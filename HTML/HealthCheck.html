<!DOCTYPE html>
<html lang="es">
<head>
  <style>
    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      color: #333;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f0f2f5;
    }
    header {
      background-color: #4267b2;
      color: white;
      text-align: center;
      padding: 1rem;
      border-radius: 8px 8px 0 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .logo {
      width: 100px;
      height: auto;
      margin-right: 20px;
    }
    .header-text {
      text-align: left;
    }
    nav {
      background-color: #365899;
      padding: 10px;
    }
    nav ul {
      list-style-type: none;
      padding: 0;
      margin: 0;
      display: flex;
      justify-content: center;
    }
    nav ul li {
      margin: 0 10px;
    }
    nav ul li a {
      color: white;
      text-decoration: none;
      padding: 5px 10px;
      border-radius: 5px;
      transition: background-color 0.3s;
    }
    nav ul li a:hover {
      background-color: #4267b2;
    }
    main {
      background-color: white;
      padding: 20px;
      border-radius: 0 0 8px 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    h1 {
      margin-top: 0;
    }
    h2 {
      color: #4267b2;
    }
    .instructions {
      background-color: #e9ebee;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .instructions ol {
      margin-bottom: 0;
    }
    .code-block {
      background-color: #f1f3f4;
      border-left: 4px solid #4267b2;
      padding: 15px;
      margin-bottom: 20px;
      overflow-x: auto;
    }
    .button {
      display: inline-block;
      background-color: #4267b2;
      color: white;
      padding: 10px 20px;
      text-decoration: none;
      border-radius: 5px;
      transition: background-color 0.3s;
    }
    .button:hover {
      background-color: #365899;
    }
    @media (max-width: 600px) {
      header {
        flex-direction: column;
      }
      .logo {
        margin-right: 0;
        margin-bottom: 10px;
      }
      .header-text {
        text-align: center;
      }
    }
    .video-container {
      position: relative;
      width: 100%;
      padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
    }
    .video-container iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    .code-container {
      position: relative;
      margin-bottom: 20px;
    }
    .copy-button {
      position: absolute;
      top: 5px;
      right: 5px;
      background-color: #4267b2;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
    }
    .copy-confirmation {
      display: none;
      position: absolute;
      top: 5px;
      right: 80px;
      background-color: #4caf50;
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
    }
    .copy-confirmation.show {
      display: block;
    }
    /* Estilo global para la barra de desplazamiento */
    * {
      scrollbar-width: thin;
      scrollbar-color: #6e8efb #e0e0e0;
    }
    /* Webkit browsers like Chrome and Safari */
    *::-webkit-scrollbar {
      width: 22px;
    }
    *::-webkit-scrollbar-track {
      background: #e0e0e0;
    }
    *::-webkit-scrollbar-thumb {
      background-color: #6e8efb;
      border-radius: 20px;
      border: 3px solid #e0e0e0;
    }
    /* Contenedor de ejemplo */
    .scroll-container {
      height: 200px;
      overflow-y: scroll;
      padding: 20px;
      border: 1px solid #ccc;
    }
    .linkedin-logo {
      width: 25%;
    }
  </style>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, shrink-to-fit=no"
  />
  <meta name="robots" content="index, follow" />
  <meta property="og:title" content="Automatizaci√≥n con PowerShell" />
  <meta
    name="keywords"
    content="PowerShell, scripts, formularios, automatizaci√≥n, administraci√≥n"
  />
  <meta
    name="description"
    content="Descubre scripts avanzados de PowerShell con formularios para automatizar tareas administrativas. Optimiza la gesti√≥n de sistemas, mejora la productividad, aplica la automatizacion y simplifica procesos con nuestras soluciones pr√°cticas y eficientes."
  />
  <title>Scripts de Vladi</title>
  <link rel="shortcut icon" href="./favicon.ico" />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css"
  />
  <link
    rel="stylesheet"
    href="./assets/vendor/bootstrap-icons/font/bootstrap-icons.css"
  />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
</head>
<body>
  <header>
    <section id="overview">
      <h1>HealthCheck para servidores Windows</h1>
    </section>
  </header>
  <nav>
    <ul>
      <li><a href="#overview">Descripci√≥n General</a></li>
      <li><a href="#funciones">Funciones</a></li>
      <li><a href="#Uso">Uso</a></li>
      <li><a href="#script-completo">Script Completo</a></li>
    </ul>
  </nav>
  <main>
    <section id="overview">
      <h2>üìå Descripci√≥n General</h2>
      <p>
        Este script PowerShell (<b>HealthCheck.ps1</b>) es una herramienta avanzada de diagn√≥stico y monitoreo para sistemas Windows, dise√±ada para administradores de sistemas y equipos de soporte t√©cnico. Recopila informaci√≥n detallada sobre:
      </p>
      <ul>
        <li><b>Rendimiento del sistema</b> (CPU, memoria, disco, red).</li>
        <li><b>Eventos de seguridad y aplicaciones</b> (logs de Windows).</li>
        <li><b>Configuraciones cr√≠ticas</b> (pol√≠ticas de grupo, servicios, parches).</li>
        <li><b>Seguridad y cumplimiento</b> (CIS Benchmarks, permisos de archivos, an√°lisis de software instalado).</li>
      </ul>
      <p>
        Genera informes en <b>HTML, JSON, CSV o Excel</b> para facilitar el an√°lisis y la documentaci√≥n.
      </p>
    </section>
    <section>
      <h2>¬øQu√© es un HealthCheck?</h2>
      <p>Un <b>HealthCheck</b> es un script o herramienta que permite verificar el estado de salud de un sistema, servidor o servicio. Es √∫til para administradores y operadores que desean asegurarse de que todo funciona correctamente y detectar problemas antes de que afecten a los usuarios.</p>
    </section>
    <h2>Requerimientos</h2>
    <ul>
      <li><b>Sistema Operativo:</b> Windows 7/8/10/11 o Windows Server 2008 R2 y superiores</li>
      <li><b>PowerShell:</b> Versi√≥n 5.1 o superior</li>
      <li><b>Permisos:</b> Ejecuci√≥n como administrador</li>
      <li><b>M√≥dulos adicionales:</b> Algunas funciones pueden requerir m√≥dulos como ActiveDirectory o Defender para an√°lisis avanzados</li>
    </ul>
    <h2>Par√°metros Principales</h2>
    <table>
      <thead>
        <tr>
          <th>Par√°metro</th>
          <th>Descripci√≥n</th>
          <th>Valores posibles</th>
          <th>Valor por defecto</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>SalidaArchivo</td>
          <td>Ruta donde se guardar√°n los informes generados</td>
          <td>Cualquier ruta v√°lida</td>
          <td>"C:\InformesSalud"</td>
        </tr>
        <tr>
          <td>DiasLogs</td>
          <td>N√∫mero de d√≠as hacia atr√°s para analizar logs</td>
          <td>N√∫mero entero</td>
          <td>15</td>
        </tr>
        <tr>
          <td>FormatoExportar</td>
          <td>Formato de exportaci√≥n del informe</td>
          <td>HTML, JSON, CSV, EXCEL</td>
          <td>HTML</td>
        </tr>
        <tr>
          <td>ParchesFaltantes</td>
          <td>Revisa parches faltantes (actualizaciones pendientes)</td>
          <td>Switch (true/false)</td>
          <td>$false</td>
        </tr>
        <tr>
          <td>RevisarServicioTerceros</td>
          <td>Revisa servicios de terceros detenidos</td>
          <td>Switch (true/false)</td>
          <td>$false</td>
        </tr>
        <tr>
          <td>AnalisisSeguridad</td>
          <td>Realiza an√°lisis de seguridad avanzado</td>
          <td>Switch (true/false)</td>
          <td>$true</td>
        </tr>
        <tr>
          <td>VerificarCumplimiento</td>
          <td>Verifica cumplimiento con est√°ndares CIS Benchmarks</td>
          <td>Switch (true/false)</td>
          <td></td>
        </tr>
      </tbody>
    </table>

    <section id="funciones">
      <h2>Funciones principales</h2>
      <ol>
        <li>
          <b>Get-InformacionSistema</b><br>
          <span>üìå <b>Prop√≥sito:</b> Obtiene informaci√≥n b√°sica del hardware y sistema operativo.</span>
          <ul>
            <li>Nombre del servidor, direcci√≥n IP, dominio.</li>
            <li>Modelo de CPU, memoria RAM, fabricante del equipo.</li>
            <li>Versi√≥n de Windows, tiempo de actividad (uptime).</li>
          </ul>
          <span>üõ†Ô∏è <b>Uso para administradores:</b></span>
          <pre><code class="language-powershell">$systemInfo = Get-InformacionSistema
Write-Output "Servidor: $($systemInfo.NombreServidor), Uptime: $($systemInfo.TiempoActividad.Days) d√≠as"</code></pre>
        </li>
        <li>
          <b>Get-MetricasRendimiento</b><br>
          <span>üìå <b>Prop√≥sito:</b> Analiza los 4 subsistemas cr√≠ticos (CPU, Memoria, Disco, Red).</span>
          <ul>
            <li>Uso de CPU (% y cola de procesos).</li>
            <li>Consumo de memoria (RAM y virtual).</li>
            <li>Rendimiento de discos (latencia, espacio libre).</li>
            <li>Tr√°fico de red (bytes enviados/recibidos).</li>
          </ul>
          <span>üõ†Ô∏è <b>Uso para administradores:</b></span>
          <pre><code class="language-powershell">$metrics = Get-MetricasRendimiento
if ($metrics.CPU.UsoCPU -gt 90) { 
    Write-Warning "¬°CPU en estado cr√≠tico!" 
}</code></pre>
        </li>
        <li>
          <b>Get-LogsEventos</b><br>
          <span>üìå <b>Prop√≥sito:</b> Recupera eventos de los logs de Sistema, Aplicaci√≥n y Seguridad.</span>
          <ul>
            <li>Errores y advertencias de los √∫ltimos $DiasLogs d√≠as.</li>
            <li>Intentos de inicio de sesi√≥n fallidos (√∫til para detectar ataques).</li>
            <li>Eventos cr√≠ticos de servicios y aplicaciones.</li>
          </ul>
          <span>üõ†Ô∏è <b>Uso para administradores:</b></span>
          <pre><code class="language-powershell">$logs = Get-LogsEventos -Dias 7
$logs.LogsSeguridad | Where-Object { $_.EventType -eq "Login Fallido" } | Format-Table</code></pre>
        </li>
        <li>
          <b>Get-AnalisisConfiabilidad</b><br>
          <span>üìå <b>Prop√≥sito:</b> Eval√∫a la estabilidad del sistema (eventos de fallos, reinicios).</span>
          <ul>
            <li>Historial de fallos de aplicaciones.</li>
            <li>Eventos de apagado inesperado.</li>
            <li>Tendencias de estabilidad (semanal).</li>
          </ul>
          <span>üõ†Ô∏è <b>Uso para administradores:</b></span>
          <pre><code class="language-powershell">$confiabilidad = Get-AnalisisConfiabilidad
if ($confiabilidad.EstadisticasEstabilidad.IndiceEstabilidad -eq "Baja") {
    Send-Alert -Message "El servidor es inestable"
}</code></pre>
        </li>
        <li>
          <b>Get-VerificacionCumplimiento</b><br>
          <span>üìå <b>Prop√≥sito:</b> Verifica el cumplimiento con CIS Benchmarks (est√°ndar de seguridad).</span>
          <ul>
            <li>Pol√≠ticas de contrase√±a (longitud, complejidad).</li>
            <li>Configuraci√≥n de firewall y UAC.</li>
            <li>Estado de Windows Defender.</li>
          </ul>
          <span>üõ†Ô∏è <b>Uso para administradores:</b></span>
          <pre><code class="language-powershell">$cumplimiento = Get-VerificacionCumplimiento
if ($cumplimiento.Verificaciones | Where-Object { $_.Cumple -eq "No" }) {
    Write-Output "¬°Ajustes de seguridad no cumplen CIS Benchmarks!"
}</code></pre>
        </li>
        <li>
          <b>Get-AnalisisPermisos</b><br>
          <span>üìå <b>Prop√≥sito:</b> Audita permisos en carpetas sensibles (C:\Windows, C:\Program Files).</span>
          <ul>
            <li>Permisos excesivos para grupos como Everyone.</li>
            <li>Archivos del sistema con permisos de escritura p√∫blicos.</li>
          </ul>
          <span>üõ†Ô∏è <b>Uso para administradores:</b></span>
          <pre><code class="language-powershell">$permisos = Get-AnalisisPermisos
$permisos.AnalisisPermisos | Where-Object { $_.Estado -eq "Cr√≠tico" } | Export-Csv -Path "permisos_peligrosos.csv"</code></pre>
        </li>
        <li>
          <b>Get-AuditoriaSoftware</b><br>
          <span>üìå <b>Prop√≥sito:</b> Detecta software vulnerable o desactualizado.</span>
          <ul>
            <li>Lista de programas instalados (versi√≥n, fecha de instalaci√≥n).</li>
            <li>Software sin soporte (Java antiguo, Adobe Flash).</li>
            <li>Navegadores con plugins inseguros.</li>
          </ul>
          <span>üõ†Ô∏è <b>Uso para administradores:</b></span>
          <pre><code class="language-powershell">$software = Get-AuditoriaSoftware
$software.SoftwareProblematico | Where-Object { $_.CriticidadMaxima -eq "Alta" } | Format-Table</code></pre>
        </li>
      </ol>
    </section>
    <section id="Uso">
      <h2>üìÇ Generaci√≥n de Informes</h2>
      <p>El script permite exportar datos en m√∫ltiples formatos:</p>
      <div class="code-block" style="overflow-x:auto;">
        <table style="width:100%; border-collapse:collapse;">
          <thead>
            <tr style="background:#e9ebee;">
              <th style="padding:8px; border:1px solid #ccc;">Formato</th>
              <th style="padding:8px; border:1px solid #ccc;">Comando de Ejemplo</th>
              <th style="padding:8px; border:1px solid #ccc;">Uso Recomendado</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td style="padding:8px; border:1px solid #ccc;">HTML</td>
              <td style="padding:8px; border:1px solid #ccc;">.\HealthCheck.ps1 -FormatoExportar HTML</td>
              <td style="padding:8px; border:1px solid #ccc;">Informes visuales para presentaciones.</td>
            </tr>
            <tr>
              <td style="padding:8px; border:1px solid #ccc;">JSON</td>
              <td style="padding:8px; border:1px solid #ccc;">.\HealthCheck.ps1 -FormatoExportar JSON</td>
              <td style="padding:8px; border:1px solid #ccc;">Integraci√≥n con SIEM (Splunk, Elastic).</td>
            </tr>
            <tr>
              <td style="padding:8px; border:1px solid #ccc;">CSV</td>
              <td style="padding:8px; border:1px solid #ccc;">.\HealthCheck.ps1 -FormatoExportar CSV</td>
              <td style="padding:8px; border:1px solid #ccc;">An√°lisis en Excel/Power BI.</td>
            </tr>
            <tr>
              <td style="padding:8px; border:1px solid #ccc;">EXCEL</td>
              <td style="padding:8px; border:1px solid #ccc;">.\HealthCheck.ps1 -FormatoExportar EXCEL</td>
              <td style="padding:8px; border:1px solid #ccc;">Reportes automatizados para auditor√≠as.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
    <section class="instructions">
      <h2>üîç Casos de Uso T√≠picos</h2>
      <ol>
        <li>
          <b>Monitoreo Proactivo de Servidores</b><br>
          <b>Problema:</b> Un servidor est√° lento.<br>
          <b>Soluci√≥n:</b> Ejecutar el script y revisar <code>Get-MetricasRendimiento</code> para identificar cuellos de botella (CPU, disco, memoria).
        </li>
        <li>
          <b>Investigaci√≥n de Incidentes de Seguridad</b><br>
          <b>Problema:</b> Sospecha de un ataque de fuerza bruta.<br>
          <b>Soluci√≥n:</b> Usar <code>Get-LogsEventos</code> para filtrar intentos de login fallidos y <code>Get-AnalisisPermisos</code> para detectar cambios en permisos.
        </li>
        <li>
          <b>Cumplimiento de Normativas (CIS, NIST)</b><br>
          <b>Problema:</b> Auditor√≠a requiere verificaci√≥n de hardening.<br>
          <b>Soluci√≥n:</b> Ejecutar <code>Get-VerificacionCumplimiento</code> y exportar a Excel para evidencias.
        </li>
        <li>
          <b>Detecci√≥n de Software Vulnerable</b><br>
          <b>Problema:</b> Necesidad de parchear sistemas cr√≠ticos.<br>
          <b>Soluci√≥n:</b> Usar <code>Get-AuditoriaSoftware</code> para listar programas desactualizados.
        </li>
      </ol>
    </section>

    <section>
      <h2>Script de HealthCheck en PowerShell</h2>
      <div class="code-block" id="codeBlock1">
<pre><code>Ôªø&lt;#
.SYNOPSIS
    Script de monitoreo completo de salud del sistema
    
.DESCRIPTION
    Recopila m√É¬©tricas de rendimiento, logs de eventos, informaci√É¬≥n de seguridad
    y genera informes detallados en m√É¬∫ltiples formatos.
    
.PARAMETER SalidaArchivo
    Ruta donde se guardar√É¬°n los informes generados
    
.PARAMETER DiasLogs
    N√É¬∫mero de d√É¬≠as hacia atr√É¬°s para analizar logs
    
.EXAMPLE
    .\monitor_system.ps1 -SalidaArchivo &quot;C:\Informes&quot; -DiasLogs 7
    
.NOTES
    Versi√É¬≥n: 3.0
    Requiere permisos de administrador
#&gt;

[CmdletBinding()]
param(
    [string]$SalidaArchivo = &quot;C:\InformesSalud&quot;,
    [int]$DiasLogs = 15,
    [ValidateSet(&quot;HTML&quot;, &quot;JSON&quot;, &quot;CSV&quot;, &quot;EXCEL&quot;)]
    [string]$FormatoExportar = &quot;HTML&quot;,
    [switch]$ParchesFaltantes = $false,
    [switch]$RevisarServicioTerceros = $false,
    [switch]$AnalisisSeguridad = $true,
    [switch]$VerificarCumplimiento = $true
)

$LPNG = &quot;iVBORw0KGgoAAAANSUhEUgAAAJwAAABJCAYAAADIS0/RAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAAHzcAAB83AeXxie8AAAgCaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/Pg0KPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgOS4xLWMwMDIgNzkuYTFjZDEyZiwgMjAyNC8xMS8xMS0xOTowODo0NiAgICAgICAgIj4NCgk8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPg0KCQk8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIiB4bWxuczpBdHRyaWI9Imh0dHA6Ly9ucy5hdHRyaWJ1dGlvbi5jb20vYWRzLzEuMC8iIHhtbG5zOmRjPSJodHRwOi8vcHVybC5vcmcvZGMvZWxlbWVudHMvMS4xLyIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczpwaG90b3Nob3A9Imh0dHA6Ly9ucy5hZG9iZS5jb20vcGhvdG9zaG9wLzEuMC8iIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdEV2dD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlRXZlbnQjIiBkYzpmb3JtYXQ9ImltYWdlL3BuZyIgeG1wOkNyZWF0b3JUb29sPSJDYW52YSBkb2M9REFHbVNQOVF5VDQgdXNlcj1VQUZzbDYwbHp0ZyBicmFuZD1DQU5WQSBQUk8gMyB0ZW1wbGF0ZT1Db2xsYWdlIGRlIEZlbGljaXRhY2lvbiBDdW1wbGVhw7FvcyBGb3RvcyBNb2Rlcm5vIFBhc3RlbCIgeG1wOkNyZWF0ZURhdGU9IjIwMjUtMDUtMTlUMTE6NTg6MTctMDY6MDAiIHhtcDpNb2RpZnlEYXRlPSIyMDI1LTA1LTE5VDEyOjAyOjQyLTA2OjAwIiB4bXA6TWV0YWRhdGFEYXRlPSIyMDI1LTA1LTE5VDEyOjAyOjQyLTA2OjAwIiBwaG90b3Nob3A6Q29sb3JNb2RlPSIzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOmQ0YjlhMjRhLWZiM2MtYTg0NS04MTUzLWNlYjBjZWI1ZTNiMiIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDpkNGI5YTI0YS1mYjNjLWE4NDUtODE1My1jZWIwY2ViNWUzYjIiIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDpkNGI5YTI0YS1mYjNjLWE4NDUtODE1My1jZWIwY2ViNWUzYjIiPg0KCQkJPEF0dHJpYjpBZHM+DQoJCQkJPHJkZjpTZXE+DQoJCQkJCTxyZGY6bGkgQXR0cmliOkNyZWF0ZWQ9IjIwMjUtMDUtMTkiIEF0dHJpYjpFeHRJZD0iOTIyNGJiODItZTg3Zi00N2Q3LTg2N2MtYjhkYzYzOTM4NzIzIiBBdHRyaWI6RmJJZD0iNTI1MjY1OTE0MTc5NTgwIiBBdHRyaWI6VG91Y2hUeXBlPSIyIi8+DQoJCQkJPC9yZGY6U2VxPg0KCQkJPC9BdHRyaWI6QWRzPg0KCQkJPGRjOnRpdGxlPg0KCQkJCTxyZGY6QWx0Pg0KCQkJCQk8cmRmOmxpIHhtbDpsYW5nPSJ4LWRlZmF1bHQiPsKhQmllbnZlbmlkb3MgYWwgRXF1aXBvIERldmVsISAtIEx1bmVzIE1vdGl2YWNpb25hbDwvcmRmOmxpPg0KCQkJCTwvcmRmOkFsdD4NCgkJCTwvZGM6dGl0bGU+DQoJCQk8ZGM6Y3JlYXRvcj4NCgkJCQk8cmRmOlNlcT4NCgkJCQkJPHJkZjpsaT5XZWJtYXN0ZXIgRGV2ZWw8L3JkZjpsaT4NCgkJCQk8L3JkZjpTZXE+DQoJCQk8L2RjOmNyZWF0b3I+DQoJCQk8eG1wTU06SGlzdG9yeT4NCgkJCQk8cmRmOlNlcT4NCgkJCQkJPHJkZjpsaSBzdEV2dDphY3Rpb249InNhdmVkIiBzdEV2dDppbnN0YW5jZUlEPSJ4bXAuaWlkOmQ0YjlhMjRhLWZiM2MtYTg0NS04MTUzLWNlYjBjZWI1ZTNiMiIgc3RFdnQ6d2hlbj0iMjAyNS0wNS0xOVQxMjowMjo0Mi0wNjowMCIgc3RFdnQ6c29mdHdhcmVBZ2VudD0iQWRvYmUgUGhvdG9zaG9wIDI2LjQgKFdpbmRvd3MpIiBzdEV2dDpjaGFuZ2VkPSIvIi8+DQoJCQkJPC9yZGY6U2VxPg0KCQkJPC94bXBNTTpIaXN0b3J5Pg0KCQk8L3JkZjpEZXNjcmlwdGlvbj4NCgkJPHJkZjpEZXNjcmlwdGlvbiB4bWxuczp0aWZmPSJodHRwOi8vbnMuYWRvYmUuY29tL3RpZmYvMS4wLyI+PHRpZmY6T3JpZW50YXRpb24+MTwvdGlmZjpPcmllbnRhdGlvbj48L3JkZjpEZXNjcmlwdGlvbj48L3JkZjpSREY+DQo8L3g6eG1wbWV0YT4NCjw/eHBhY2tldCBlbmQ9J3cnPz4C+79wAAAgy0lEQVR4Xu2dd1xUV/r/P1OZxtBBRcWCIqCAgFjWtRKjhohGEo0aY4lrTOJaIjHZrDExWTXWtcZOYkRBjSurEVGiGEA6DAjCgEMvQxvqFKbd3x+5szu5YWA0+E02v3m/XufFzHnOee557j1zynPOuQAWLFiwYMGCBQsWLFiwYMGCBQsWLFiwYOEPBY0a0RP3IyI4GDLEUafTEVRZbzQ0NGh3797dmZeXJ6fKLPy+qa6uduBwOFxqPABwuVwCAFFYWNgYGBioocqfFToA28MHD4arVCqFUqmUKxUK84JSKVcqlXK5XN7W3t5e3dLSkiiVSo8+EokWrly50ol6IQu/K7gABhcWFt7V6XQKU0GtVitEItFoauZfAwvAjHVr194g+pCWlpYGiURyIioqypd6QQu/C5wBrI6Pj6+kPjsq2dnZZj1DOjXCBDQAAqVKxacKfg22trZOw4YNWxsSEpJZWlp6fPv27c7UNBZ+U5gAbNVqNYMqMEar1YIgCLOGWeZWOADQ02g0PTWyL+Dz+cyhQ4eu27hxY2ZiYuLLVLmF3wwCgI5Go5lVmczhaSrcc8fW1nZQUFDQv7OysrZSZRb+GPyuKhwAsNls+Pv7787Ozt5OlVn43+d3V+EMjB079tOsrKy11HgL/9s8lwrX0NCgr6mp0dfW1upkMhlVbDajRo06duXKlfHUeAv/u/R5hdPpdFi3du0xfz+/Lb6+vjvGjx9/IDg4+OLmzZuTYmNja9vb26lZTMLj8RhTpkw5A4BNlVn4Y8MGELJyxYp4qv+FilarJT777LPppNPQBcAwAOMALATwNx8fn8tXr17t1a9jTGZm5kZqgZ4BOjnN7/Mf2e+YX2tzfwAbY2Njq6nPxBiNRkNkZWX5UDN3h7lLW2wAs1auWLHxXETETKrQGJ1Oh9TU1LGTJ08WUUR8AAMB+AEI2Lp168ydO3f60+m934u2trbazz//fOT+/fvNXhY7ceJEYFBQ0FQHB4cAHo83nMFgWDOZTJZer9fpdDq5RqOp7+joyGxsbHz42muvPaiurlZSdZAPinHjxo2FkydPXqrRaLTUBAbodDpNpVIVPXz4cNdrr73WRpWb4rq/y0uTnLiLoadZgyC6dTvRGDR0afXy20rOO289FHdQ5SS0EydOBEyYMGGKg4NDAIfDcWcwGNYMBoNFEITBZqlcLs+sr69P6cFmY/oDWBQbG7tl9uzZrlShAa1Wi7y8PN+AgIA8quxZeaoWLi4uLoCqwAg7AHMBfLFt27Y8an5TZGRkvEVV1A3c6OjoVaWlpSlyuZyqwiQtLS2SkpKSj0NDQ20p+pgAAsaNG7dHr9dTs3VLdXX1eYoOU1iPs+Uskc0aoideGUEQoe6mw2seRPMLQ66aaCC4UVFRK5/WZplMJikpKflbcHCwDVWhEX3ewpkLG0DIir6pcAAgBPAKgMP37t1rpOroDqlUep+qxJh58+ZNEYlEydR8T4NMJnuSkJAw10gtDUAAgM/OnTtXQk3fHUqlUhMTE+NupKM7GAAmRPg4ZRALRhDE3GGmQ8hwomvuMM3N8W6eVCVz586dkpub+2ttLklISJhD1U3S5xWu9/7s+dAOIB2AeMeOHTk6nY4q/wUCgSDo6NGj/ajxANhvvfXWmqNHj9709fWdRBU+DXZ2dsMnTpz4fUZGxjoyigBQCqB03759jxQKBSXHL+FwOEw/P7/expz2bjzm9BAXvj+03fai/4VJR3OX7lpIWkWhUSx71apVa06cOHHTx8fn19rsPmHChFvp6el/ocqeBr1eb9ZqxHOpcAwGw5yL1wEoSkhIEOfn55sal/wHPp/Pmzhx4jhKNC84OHjVjh07jg0aNMiaInsmSMfz8aSkpEVkVCsA8ePHj4vu3LlTTUneLU5OTsvPnz9val2YDmBo+DDbEEc+i46ednrRaNCodUSxQrPbKJY3Y8aMVZ9//nmf2WxlZQV/f/+TqampYVRZX/NcKpyZ6ACUA6hKTk6uowq7QyAQjDT6ymGz2cH79+//on///iyj+G5pb29HUVGRvLCwsLOlpYUq/hl0Oh2+vr6nzpw540a2chIApXv37n2k1/fSIv20R8x60qRJb1PjSeyc2czJC13446DrRReLDplK9/20lNocMobDYDCCDxw48MWAAQPMslksFneaYzODwYC3t/fZo0ePulFl5kCn07sbX/6C37LCAUAzgIaSkpJWqqA7uFzuQPIjDYD7jh071vv4+DhQkv2M+vp69YkTJ6JnzZr1vqen5xYvL69d48ePj9i+fXt2U1OTyb5cIBAIZ8yYsYv82gyg+OHDh48TExMbKUm7xcXFZd327dsFlGg6ALfw4bYh/azZrJ5bN0Cv1UOi1BjKQAfg/vnnn6/39fXt0WapVKo+ceJE1KxZs94fNWpUuJHNOc3NzT3a/NJLL/2DGv9b8FSThvj4eH+qAhPwAIStWbPmAVVPd8hksrNkPgcbG5uN5eXlGmoaYxoaGlqWLFkSSl6HS05WBgOYCeCDoKCgf9fX16up+QyoVCrN1atXR5DXHADgndDQ0HvUdKYoLi6mtnJ2Qib93coZg5XEy8N/OUEwDqHuRFPwkHtGee1Jm02Wl/jJZtnixYvndWNzMICtQUFBN3qyWaFQaKOjow2THrMnDRkZGWOMymqS37qF0wFQAzDp3zKGxfpPLzJ4yZIlM93c3Jg/T/Ff9Ho9cf/+/fUXL16MAaAAoCQnK5UAfgDwr/T09Dvh4eGp1LwGrKysmH5+fovJrw0ASmJiYgpEIpFZfjZnZ+dN5OZVkK3y4PeH24YMElpxemvdoCdQotQZWjcaALelS5fOcHNzM9mV6nQ64ocffngvKirq393YHE/aHBceHp5qavsal8tl+Pv7G8avfc5vXeGAn2Z2Zi1dKZVKg+PXPTg42Isi/hkqlUptY2PDzs7ODk1PT3/FEDIzMxfk5uaGxsfHB4SHh7uxWCyis7Oz+7sPwMbG5kXyoxZAMQDJ8ePHH1OSdYuNjc3IgoKC+eRXIYuOoKX9+H9GbxM6Jh0ylS51YnLVXTKGB8B9+vTp3pSUP6Orq0vt6OjIys3NnZeWlrbAOOTm5s6Li4vz37JlyxAGg9Gjzba2trPJjybTPG+ea5e6c+fOLKqe7igrK/uYdMaGi0SiDqrcGHMdtUQvaTs6Opp37dplR5aXDSCEwWCcLC4uVlDTdkdLS0sKmXdU+DCb60So+y+7T2qY507k/nlQqNF96k/a3E7V/6z0YnPTmTNnrAE4/NG6VCsAtuPGjTO5bGKMWq2WALARCoXOjo6OHKrcGBrNrEkT0EtaHo9n7+/vP4z8qgZQpNPpJBEREUWUpN1ia2s74ZtLl0IBeKweJJwOGtlBmgpWDLQqtPm+iVU3jNRYC4VCZwcHB55R3K+iJ5u5XK6Dr6/vENLePuW3rnDCwYMHjwoICDDls/oPXV1dOrFYLAJg5+DgYM3n802O3/oSOp0OoVBo7O+qAfDk+PHjj6RSqVkPxN3HL3wJH6EeQrZQr9ZDT6DbANDQodJ2SLq0WwAY+0x4zs7ONjY2Nj2eLegrGAwGrK2theQYu0/5LSscA8Dgjz/+eKadnZ3pnxuJXC4Xz5s3rxiADZPJZJuz6N9XCIVC4zOZSgDitra24osXLz4xijfJWPdhkwR/mkZ7JUO6NyRDevgXIV165OUM6aElovqP14lk0wITq+MoKqzodDqrp1aprxEIBJznMYYz1wI2gFkrVqzYGGHGbpGEhISA4ODgbKqMguPcuXP/fvny5Q18fu+HwUpKSv4xcuTIvwMY7+rquiYvL2+Vvb29yfJ3dHRoq6urOwHQn+UQCEEQNDabrba1tW0tLy9fGRgYmGQktgYQMnDgwNBHjx69amtr22vtfyQWf+czatRyALYm7rseQBs5u6Qywc3N7S2RSLTa1pa6v+C/GNlMe5bKabDZzs6upbOzc4mbm5sYwGpzdouIRCKfcePGPaLKnpW+njQwZ8+evam8vNysgbdcLu86e/asYRwVwGazD5eWlnZR0xkjFotLASwD8CaAFc8QVgEIBdDd+i0AjAXw2ddffy2hXrs71Gq1IjExcTBViZkEstnsI73ZXFhY+ATA0l9p8zzyPCqehx/OXJ6qwt29e3csVYERTocPH97bk/ORSkFBwddG+b0B7ExNTW2hpjOmra2tXiAQOJITE14PgUV278xuQk/NhB2AN0ePHn1dpVJRL98t1dXVB6hKzMQbwD9SUlJkVJ3GUGzmdxOe1uY+r3C9dgXPQn5+vooSJTh27Ni4+Pj4j0tKShLXr1+/xdnZ2aQD05i2trbOy5cvf2oU1QlAlpmZ2WAU9wsEAoEz2dJ2kd2UqUC7ffu2zf379wXUkJiYaJuYmGhwiVBpBVCcn59fdOfOnVqqsDvs7e1XnTx50pEabwYdAGRZWVk92mxtbe384MEDX9JmeTfBLJtzcnJM99v/R5jdwun1eqKuri6lrq7udm1t7R2pVJrc2NhYrlCY1Xv+gjt37rxHKYsNgDemTJkS25MviSAIoqmpKdfHx8fkAHHYsGGBNTU1j+RyeatCoWjuJshqamp+oOYzwgnAmilTpsTqdDrq5bulrKzsI6oSM3gam3N6snno0KHjerO5trY2nkzu0tctnLmYXeH6kpycnCvUgpCt8jQABxMTE5upeag0NzdnJCcnvxgQEGDsw7LduHHjW3l5eVXU9FSKi4t7WsymA5gK4EBiYqJZG0k7Ojqq/vKXvzytP81g8z8fPHjQY7dK/FTpMpKSkmZRbd68ebNZNkskkh1knj7vUs3l/7zCFRQUJJMLz90xEMB706ZNu2Nuy9LW1lbZ2Nj4UCqVJkil0gqNpsd1f4IgCKKzs7Nj9+7dhh0qphgA4N2wsLD71PymEIvFa6hKzMBg811zbW5vb69oampKlkqlCfX19eXm2NzR0dH+5ZdfDiCv+f9HhcvLy/uRz+f35AxmAJgCYNeBAwfE1Px9RXJy8hbqhbuBCWAWgKO5ubltVB3d0draWkDa8DQwDTbv37//edr8vtE1/9gVjtztcIH0c/WGLYDXABy7ePFir93E0yISiaKpF+yBIQA2rVu3LoWqxxQ5OTkLqErMwBbAqwCOPg+bc3JyoijX++NWuJKSkpp9+/a9S71wL/Qn/U5HDh8+3Ge/+pSUlIuka8FcrAC8zGazT0skEiVVX3fIZLJkqhIz6Wdsc2+TCHNJTk6OJJ+zMX+8CicWi+sjIiKOAOhxu1EPuJAO2h0LFy68m5aW1kq9hrmUl5fXnzlzJpx6ATMZCWDr1q1bc6h6TfH48eMQqhIzMdj82YIFC36tzdJz586ZGjr0eYXrybFpDBvAi6tXrw4/c+bMn6nCp6GtrQ1SqVRWUlJSeP/+/bsHDhy4CSCHslj9tAgAjCIdpF6vv/66X1hY2KjAwMD+gwYN6nENsqmpCRUVFcVpaWnff/DBB1/L5fJnPczLI3cSz9y7d+8Uf39/BxqNhu42OrJYLPWAAQMaNRrNd56envupcjPhA/A02Lx48WK/V1991TMwMLBfbzY3NjYSlZWVJSkpKd9/+OGHEXK53NSS1AAAi+Pj4z+eOXOmPVVoTHp6+tjx48dTD7//AtOl+jksANO9vLwWhIWFDXmaykGj0QiCILStra1ttbW1TWVlZeVZWVmFAIrIk1t9tSOBRnr/B5PB1draevC4ceNcx44d6+zq6mptb2/PYjKZRFdXV5dMJmt+8uRJaVpaWq5IJEoHUNIHZXEiK4F1D/eWTm4AyANQTxU+JTQA9gAGkTYPJG0eQLFZ39XVpW5paWkSi8WlGRkZeWba7AwgZPHixTO8vb251ANEBEHQHB0dGydPnixqaWm5NH369F7Pppi6KVToZPPqSBbwlz9b0+jJfVUqI093FzVRH8MhH7o12fqxyVkeyJ27CnLrdTu5cmH2D8gM6GbOQPW9POynhUO6kazJ1s+UzW3kqoM5NlsBcCX/6rt57jRSp1mn7ixYsGDBggULFixYsGChV8ydpf6M7777zn/MmDHjGQxG4/nz528BYAYFBY186aWXMg1pIiIihlhbW7OOHDlSt2/fvokCgYBLp9O1FRUVolmzZtUCYFy/fn2sh4dHf51OR9Pr9QyFQlE5YcKErJs3bwYMHz58gE6nowGQjR49+j/bu2/cuOHr7u4+XqPRlJ4+fTrxyJEjXbdu3Ro+dOhQd71ez2AymTSlUtnm5+eXhJ9eLCNISEiYw+Vy7VtaWlICAgLyTp48acPj8fq98cYbYlIt7cqVK14//vjjE1dXV86cOXMCWSwWh8PhaBQKRd7o0aOlAOjffvvtqDfeeONJaWlpf4FAMESn0yl1Oh2TIAirnJycR3Q63e2bb755dOXKFTUADBw4kHvq1KnRc+fOzTCU/8MPP7SbM2fOmCFDhrA1Gg1RUFBQGhoaWgYAFy9e9Pb09HQWCoUMADS5XN7p4+OTEh0d7eXl5eVibW1Na21trfbz8ys2lPvixYtjvL29nbhcLkOn09E6Oztbx40bl3bt2jVPb29vJx6Px9DpdDSFQtHq5eWV3dzcPEir1ba4uLgobt26FbRjx47c1NRUJQDcunXLp6Ojo3nRokU1sbGx/u7u7jYsFouuVqvpMpmsZsKECY9v3rwZ4OHhIeTz+br8/Pwn5LM0m6fZgEkDYB0TE7PHycnpSnZ29qSKioo358yZcysyMtLL1dX1pEgkmoGf9lyNDAgIuCoSiXynTJmyjMvlnissLFxQVVUVNmTIkH9FRkYGAxju7Oz8jUQieVssFoe1tLS80NTUNAaAp6Oj4zclJSVrnzx5sqCrq2tbUVHROQCCPXv2rBEKhRcfP34cqFKpPly4cOEGALZCofBQfX3934qKihZWVVW9RKfTvQDQly5dOuH7779PKi4u/kteXt44DocTceXKlTUVFRWTfH19PyPtsgbg5uHhcTgvL28Mn89fQRDEieLi4vmVlZVhAoHgcnx8/BwANl5eXgeXLl3qHxkZOSU5OXlxQ0PDqebm5o+kUum069evj2AwGOt27969x6A3IiLiVP/+/V8zun9OSqVy5cSJEx90dHRcJgjiwrRp00QpKSkbAAzy8vK65OTkFCeXyyMBnGMwGNsBeHl4eFyys7O7rVarz7u6uqY2NzdHDh482A6A5+jRoy/b2trGqlSqCywW6xyTyfwIwEgPD4/LPB7vdmtr6wW9Xn9Wr9d/QC6LxUkkksUAvAMDA1NiYmIukm6c/qNGjYp0cXF5G4Cnt7f3HTqd/u+Ojo4LLBbrtFarXcNisfz8/PziaTRajEqluhAUFJQnlUo/Ie3rcxyWL1++ISMjo9zLy2sygDEAPF9//fUXAQSHh4evqqqqSgPgcenSpdjU1NR/AnD75JNPjiQkJJwjNxEOj4uLO3fz5s0jAGbeu3cvBcBoo3VLGwCLExISkgH4GlYPHj9+nDFmzJiwK1euxMbExJwl/U0sLy+vwQCmxMfH3/3rX/8aQmmxvW/cuPHw2rVrhwEMBTBm4MCBo2fMmPHCunXr1hcXFxveVDkYQPCjR49+8PLymrdr1679cXFxB8mK6P7VV19tEIlEdwD4ZGVl3fnss8/+BMADwIRLly59GxMTs4zUM8HFxWW6WCxO/+KLLxa8+eabG0UiUcamTZsMJ74YACYvW7bs68bGxk4AiwHMi4yMvNLU1NQOYGlWVlZddHT0aQD+ZLkGAFiZnZ1dHx0d/Q2AhS+88MJfm5ub2x8+fHgWwILs7OzGY8eOHSJfnDiQ9JutzM3NbTx16tRe8v46k7Kw2tra6sjIyI8BbKioqOggCIK4ffv2fgCTiouLxf/617/+CeDNsrIy+cqVKz8gz244AHDncDjhlZWV8rVr1+4A8OqGDRs+USqVRFlZ2Sukjb1ibgvHBNA/ICAgiMfjXXz8+HES+aK+2kuXLt0FINu7d684ISEhNzU19Za7uzsRFhb2EQBbuVze4u3tHZiZmfnlDz/88NXAgQOnnTlz5ioAhp2dHVsikfytuLj4kEQiOblu3bqZAOrt7e21lZWVnqdOnQrYuXPnWq1Wq6iurpafP3/+1ogRI3yKi4u/LiwsXNfe3q4DoObxeKpt27ataGho2N3Y2Lj/9OnTrzAYjGGurq78xMTETwGUAaisrq6W3Lt3r0av13P1/3WbMwAw9Xo9aDQawWAwZIGBgfYKhcL3k08+menp6RlSXV2dBICr0+mwfPnyGgBVANT29vbqSZMmdZJ6pPX19dizZ0/EjBkz9q5du3ZtTU3NuoMHDxreo0sDwCQIQsnj8XRRUVFOGzZsCHR3d/dtbm4WA+jSarUdc+bMCa6rq/uyoaHhm1OnTr0GoIlGo2mDg4PzAGTcvXu3JiYm5vrIkSNfJsvUtmTJkpdqa2u/rK+vv3D8+PH5ANr0en17WFhYcE1Nzcc1NTXHdu/e/SIAPUEQenKowuvs7NRHRERETZo0aVNYWNiLcrm8U6vVMgDo6XS6as+ePcvq6ur2NjQ0RL/99tuBarW6mUajaRYtWpQGoOTQoUOPsrOzs52dnc1+r5y5FY4FgEun01uFQqHhFVRy0mutB1AIgPvGG2+k2tracmg02k7yhcU8tVrtUF5ero6MjJTGxsamVVdXx73zzjtLAFi3tLSwr1271hAdHf2ksLDwB4lEUg3AQaFQ9CsoKNjg4eHx4auvvrrw5MmTr7e0tOTfuHEj3cvL65MLFy5ktba2Tr9+/fppALy2tjb+/fv3286ePVv58OHD1Lt377YA0FtZWalXr15t2AHRRi4pqfV6Peh0uiFeB0BDEASrs7OT1dTUxJPJZJOTk5M3LV++fC+fz38QEhJy0LAZ1MbGxrBCoKUcP6wC0Hr27Nm6mpqaun79+t02HtMavPQKhYLFYDCsPTw8Ptq5c+e2kSNHds2dO3cFAAFBELyioqKG6OjonPz8/Ot5eXl5P53FphP29vbN5Etp2ng83hCNRtNO/lC4eXl50qioKNGjR4+u5+TkPAYg1Gq1VqWlpaykpCRIpdLq9vb2VkMPQJa7ic/nM7766quCb7/99tKhQ4feFwgE/dRqdRcArlarZSUmJlbGxMSkVlZWRotEoioWiwU6nU5Mnz69BoAIP60L99fr9T2/fM4IcyucDgD722+/TVKpVMElJSUvAsD777/vnJGRsf7+/ftW5MsFW5ubm8tGjBhhWCPUODg4aFksVtHBgweP7Nu3745IJKpxdHQMAqC0srKSx8bGXty2bdvpkJCQy3fu3GkAIFAoFMrXX3/9q6lTp37U1NQkXr9+/VwAVVFRUWP+/ve/O+3YsSP+nXfe+Y7L5Q4DQOPz+Wq5XH77o48+OhMaGnrl8uXLEp1OpxCLxbkODg5Hr1+/bg0AP/74Y8inn34ampaWVkin073FYrEvAO3mzZtfYDAYrIqKigo7Ozv7/Pz8tBdeeGHPkSNHPhk8ePD4sLCwAQC0DAaD3dXVRScfHI1Go7FpNJphGUsHoAJAW2traxmTySz5z90zgs/nc9vb24mxY8f+c+vWrRFsNnvQkiVLBgKQW1lZsTgczpPy8vLbEokkifznt3wGgwGCIMZkZ2dPOnPmzKqXX375z3FxcScAdHK5XBaNRhNLJJK4J0+eJAkEAgCgW1lZCRoaGq4sWrRoXUBAwKadO3emAeDT6XQO2YB0cblcmp+fH/3dd99NzMjIaHB3dx8gl8t1AFRWVlZMjUaTVVFREdfY2PjQ09OTS6fTWSwWi9nW1jb+6tWrL3733XcbRo0a5VRUVHSCaqcpzK1wagCN6enpsj179pyQyWS7kpOTYxcvXnxdrVaPbGhoMJyM6lSr1VKVSmXorugSiaRZKBT65ebmfp2UlLRr6tSpc6Oior4EoFOr1drDhw/vfPToUWRRUdG/r169ugVANYPBKJw/f34+gPZNmzYd7OrqWjZ//vypZWVl1vPmzVt37969nUePHt2Sm5t7HEBbR0eHbObMmW9JJJKvKyoqLhYUFGwAQLzyyitX0tLSdEOGDLmZkpJyUygUhnO53Nq8vLzWCxcuXOvs7Pw6ISHh/OLFi1/Mycn5BEAbjUar9PDwyAXQdOjQoSSxWJy/atWqdQBUHR0ddRqNRkNWOIZSqawjCMJ4wboLQLter2+Uy+XUA800/PRWpyatVlvg4OBQfPTo0djMzMyUhQsX/g2AVXl5eZWTk9PszZs3Xw4NDf1+xYoVewDwSkpK6urq6lbb2trGTZky5U+ZmZlvr1ix4hsA9hUVFXXDhw9/ZevWrdHz58+/tWzZst0AOrq6uh7PmDGjgDxdBnKtlZDL5U/kcnkrALpMJqv09vbOBNC8aNGiyyUlJcUEQSgBMOvq6uqmTp267r333rs6YcKE26tXr35XqVSiqqqqqbOzc7e/v/9lHx8fu/v37899mgPQT+MWYQMYQe465Y8fP95Zo9GUZGdnp5FyRwCDeDxenUKhqCd1ewEY1r9/f0a/fv3YLBarMz09PZV8MH/icrlcd3d3FoPBwIABAyq1Wm3bnTt3WNbW1rUdHR3NANx/ercKt9nFxcWpvLycA0A4adIk+/b29tz8/PwSAOMBWHt6ejL4fD6jX79+0vfee08ye/ZsOllemru7u6urq6vmwYMH98mudSwAPpvNtgsKCuIkJSUlA6gl02vJ1ppL7nGTTp06lfPgwQMbPp9fJ5fLG8mH5wZARr43zgCH/EcoSrKLNX7vHZ0cwNsLhcK89vZ2gixHw9SpU1UPHjzwAODAYrF0bDYbbDa7TCgU1lZUVHgCcGaxWBorKyt5Z2dnHjkmtQMwGYAjh8PRsVgsgslkSqytraWVlZX9AVSTLa4BF9K+UnJM7s7hcJ6oVKoqsszuAEo4HI5GpVL5A7DmcDg6JpOp5fF4YgCdDQ0NPgAEHA5HS6fTWxQKRRaAJqNr9MrTVDiQN01AFtiw+8MAg2yqjc+kcgy/LHKspwKgIdPySX0EGZTkA2Ib7SZhkDNYhcEtQ15bSQYaWTEMuyIIsjU25DccCNaRY05DBWCSdoCMN/yvdhZlF4dhnKchdRlso5E6tJQdFDQyj9bEThArMo1Bj2EGqyTLyTTS10XawiPjje8fyHvDpexMUZF5rMi/xjtCDAef1eRnttHzo5N5usjrG54NyO8q0h4eGa8zirNgwYIFCxYsWLBgwYIFCxYsWLBgwYIFCxYsWLBg4Y/I/wPI0LhNafBifwAAAABJRU5ErkJggg==&quot;
$lenbytes = [Convert]::FromBase64String($LPNG)
$lenmemoria = New-Object System.IO.MemoryStream
$lenmemoria.Write($lenbytes, 0, $lenbytes.Length)
$lenmemoria.Position = 0
$imagenl = [System.Drawing.Image]::FromStream($lenmemoria, $true)

if (-NOT ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole] &quot;Administrator&quot;)) {
    Write-Error &quot;Este script requiere permisos de administrador. Ejecute PowerShell como administrador.&quot;
    exit 1
}

$ErrorActionPreference = &quot;Continue&quot;
$ProgressPreference = &quot;SilentlyContinue&quot;
$FechaInforme = Get-Date -Format &quot;yyyyMMdd_HHmmss&quot;
$NombreServidor = $env:COMPUTERNAME

try {$DireccionIP = (Test-Connection -ComputerName $NombreServidor -Count 1 -ErrorAction Stop).IPv4Address.IPAddressToString
} catch {$DireccionIP = (Get-NetIPAddress -AddressFamily IPv4 | Where-Object { $_.IPAddress -ne &quot;127.0.0.1&quot; } | Select-Object -First 1).IPAddress}

if (-not (Test-Path -Path $SalidaArchivo)) {New-Item -ItemType Directory -Path $SalidaArchivo -Force | Out-Null}
$ArchivoSalida = &quot;$SalidaArchivo\InformeSalud_$($NombreServidor)_$FechaInforme&quot;

function Get-InformacionSistema {
    try {
        Write-Progress -Activity &quot;Recopilando informaci√É¬≥n del sistema&quot; -PercentComplete 5
        
        $os = Get-CimInstance -ClassName Win32_OperatingSystem -ErrorAction Stop
        $cpu = Get-CimInstance -ClassName Win32_Processor -ErrorAction Stop
        $system = Get-CimInstance -ClassName Win32_ComputerSystem -ErrorAction Stop
        $bios = Get-CimInstance -ClassName Win32_BIOS -ErrorAction Stop
        
        $domainInfo = if ($system.PartOfDomain) {
            &quot;Dominio: $($system.Domain)&quot;
        } else {
            &quot;Grupo de trabajo: $($system.Workgroup)&quot;
        }
        
        return @{
            NombreServidor = $NombreServidor
            DireccionIP = $DireccionIP
            NombreSO = $os.Caption
            VersionSO = $os.Version
            BuildNumber = $os.BuildNumber
            ServicePack = $os.CSDVersion
            UltimoReinicio = $os.LastBootUpTime
            TiempoActividad = (Get-Date) - $os.LastBootUpTime
            Fabricante = $system.Manufacturer
            Modelo = $system.Model
            NumeroSerie = $bios.SerialNumber
            Procesador = $cpu.Name
            Nucleos = $cpu.NumberOfCores
            ProcesadoresLogicos = $cpu.NumberOfLogicalProcessors
            VelocidadCPU = $cpu.MaxClockSpeed
            MemoriaTotal = [math]::Round($system.TotalPhysicalMemory / 1GB, 2)
            DominioWorkgroup = $domainInfo
            TimeZone = (Get-TimeZone).DisplayName
            Arquitectura = $os.OSArchitecture
        }
    } catch {
        Write-Warning &quot;Error al obtener informaci√É¬≥n del sistema: $_&quot;
        return @{ Error = $_.Exception.Message }
    }
}

function Get-MetricasRendimiento {
    try {
        Write-Progress -Activity &quot;Recopilando m√É¬©tricas de los 4 subsistemas&quot; -PercentComplete 15
        
        Write-Host &quot;   Analizando subsistema CPU...&quot; -ForegroundColor Yellow
        $cpuSamples = @()
        for ($i = 0; $i -lt 3; $i++) {
            $cpuSamples += (Get-Counter &#x27;\Processor(_Total)\% Processor Time&#x27; -SampleInterval 1 -MaxSamples 1 -ErrorAction SilentlyContinue).CounterSamples.CookedValue
            Start-Sleep -Milliseconds 500
        }
        $usoCPU = [math]::Round(($cpuSamples | Measure-Object -Average).Average, 2)
        
        $colaProcesor = (Get-Counter &#x27;\System\Processor Queue Length&#x27; -ErrorAction SilentlyContinue).CounterSamples.CookedValue
        $interrupciones = (Get-Counter &#x27;\Processor(_Total)\Interrupts/sec&#x27; -ErrorAction SilentlyContinue).CounterSamples.CookedValue
        
        Write-Host &quot;   Analizando subsistema Memoria...&quot; -ForegroundColor Yellow
        $os = Get-CimInstance -ClassName Win32_OperatingSystem
        $memTotal = [math]::Round($os.TotalVisibleMemorySize / 1KB, 2)
        $memLibre = [math]::Round($os.FreePhysicalMemory / 1KB, 2)
        $memUsada = $memTotal - $memLibre
        $porcentajeMemoria = [math]::Round(($memUsada / $memTotal) * 100, 2)
        
        $memVirtualTotal = [math]::Round($os.TotalVirtualMemorySize / 1KB, 2)
        $memVirtualLibre = [math]::Round($os.FreeVirtualMemory / 1KB, 2)
        $paginasPorSeg = (Get-Counter &#x27;\Memory\Pages/sec&#x27; -ErrorAction SilentlyContinue).CounterSamples.CookedValue
        $cacheBytes = (Get-Counter &#x27;\Memory\Cache Bytes&#x27; -ErrorAction SilentlyContinue).CounterSamples.CookedValue
        
        Write-Host &quot;   Analizando subsistema Disco...&quot; -ForegroundColor Yellow
        $discos = Get-CimInstance -ClassName Win32_LogicalDisk | Where-Object { $_.DriveType -eq 3 }
        $metricasDisco = @()
        
        foreach ($disco in $discos) {
            $espacioLibre = [math]::Round($disco.FreeSpace / 1GB, 2)
            $espacioTotal = [math]::Round($disco.Size / 1GB, 2)
            $espacioUsado = $espacioTotal - $espacioLibre
            $usoDisco = if ($espacioTotal -gt 0) { [math]::Round(($espacioUsado / $espacioTotal) * 100, 2) } else { 0 }
            
            $discoFisico = $disco.DeviceID.Replace(&quot;:&quot;, &quot;&quot;)
            $tiempoLectura = (Get-Counter &quot;\LogicalDisk($discoFisico)\Avg. Disk sec/Read&quot; -ErrorAction SilentlyContinue).CounterSamples.CookedValue
            $tiempoEscritura = (Get-Counter &quot;\LogicalDisk($discoFisico)\Avg. Disk sec/Write&quot; -ErrorAction SilentlyContinue).CounterSamples.CookedValue
            $colaDisco = (Get-Counter &quot;\LogicalDisk($discoFisico)\Current Disk Queue Length&quot; -ErrorAction SilentlyContinue).CounterSamples.CookedValue
            
            $metricasDisco += @{
                Unidad = $disco.DeviceID
                TotalGB = $espacioTotal
                LibreGB = $espacioLibre
                UsadoGB = $espacioUsado
                PorcentajeUsado = $usoDisco
                SistemaArchivos = $disco.FileSystem
                Etiqueta = $disco.VolumeName
                TiempoLectura = [math]::Round($tiempoLectura * 1000, 2)
                TiempoEscritura = [math]::Round($tiempoEscritura * 1000, 2)
                ColaDisco = [math]::Round($colaDisco, 2)
                Estado = switch ($usoDisco) {
                    { $_ -gt 90 } { &quot;Cr√É¬≠tico&quot; }
                    { $_ -gt 80 } { &quot;Advertencia&quot; }
                    default { &quot;Normal&quot; }
                }
            }
        }
        
        Write-Host &quot;   Analizando subsistema Red...&quot; -ForegroundColor Yellow
        $interfacesRed = Get-CimInstance -ClassName Win32_PerfRawData_Tcpip_NetworkInterface | 
                        Where-Object { $_.Name -notlike &quot;*Loopback*&quot; -and $_.Name -notlike &quot;*Teredo*&quot; -and $_.Name -ne &quot;_Total&quot; }
        
        $metricasRed = @()
        foreach ($interfaz in $interfacesRed) {
            $bytesEnviados = [math]::Round($interfaz.BytesSentPerSec / 1KB, 2)
            $bytesRecibidos = [math]::Round($interfaz.BytesReceivedPerSec / 1KB, 2)
            
            $metricasRed += @{
                Interfaz = $interfaz.Name
                BytesEnviados = $bytesEnviados
                BytesRecibidos = $bytesRecibidos
                PaquetesEnviados = $interfaz.PacketsSentPerSec
                PaquetesRecibidos = $interfaz.PacketsReceivedPerSec
                ErroresEnvio = $interfaz.PacketsOutboundErrors
                ErroresRecepcion = $interfaz.PacketsReceivedErrors
                Ancho = &quot;N/A&quot;  
            }
        }
        
        return @{
            CPU = @{
                UsoCPU = $usoCPU
                ColaProcesor = [math]::Round($colaProcesor, 2)
                Interrupciones = [math]::Round($interrupciones, 0)
                Estado = if ($usoCPU -gt 80) { &quot;Alto&quot; } elseif ($usoCPU -gt 60) { &quot;Medio&quot; } else { &quot;Normal&quot; }
            }
            Memoria = @{
                PorcentajeUsado = $porcentajeMemoria
                TotalMB = [math]::Round($memTotal / 1024, 2)
                UsadaMB = [math]::Round($memUsada / 1024, 2)
                LibreMB = [math]::Round($memLibre / 1024, 2)
                VirtualTotalMB = [math]::Round($memVirtualTotal / 1024, 2)
                VirtualLibreMB = [math]::Round($memVirtualLibre / 1024, 2)
                PaginasPorSeg = [math]::Round($paginasPorSeg, 2)
                CacheMB = [math]::Round($cacheBytes / 1MB, 2)
                Estado = if ($porcentajeMemoria -gt 85) { &quot;Alto&quot; } elseif ($porcentajeMemoria -gt 70) { &quot;Medio&quot; } else { &quot;Normal&quot; }
            }
            Discos = $metricasDisco
            Red = $metricasRed
        }
    } catch {
        Write-Warning &quot;Error al obtener m√É¬©tricas de rendimiento: $_&quot;
        return @{ Error = $_.Exception.Message }
    }
}

function Get-LogsEventos {
    param([int]$Dias)
    
    try {
        Write-Progress -Activity &quot;Recopilando logs de los 3 tipos principales&quot; -PercentComplete 25
        
        $fechaInicio = (Get-Date).AddDays(-$Dias)
        Write-Host &quot;   Per√É¬≠odo de logs: desde $($fechaInicio) hasta $(Get-Date)&quot; -ForegroundColor Yellow
        
        Write-Host &quot;   Recopilando logs del Sistema...&quot; -ForegroundColor Yellow
        $logsSistema = Get-WinEvent -FilterHashtable @{
            LogName = &#x27;System&#x27;
            Level = 1,2,3
            StartTime = $fechaInicio
        } -MaxEvents 200 -ErrorAction SilentlyContinue | 
        Select-Object TimeCreated, LevelDisplayName, ProviderName, Id, 
                     @{Name=&quot;Message&quot;;Expression={$_.Message.Substring(0,[Math]::Min(300,$_.Message.Length))}}
        
        Write-Host &quot;   Recopilando logs de Aplicaci√É¬≥n...&quot; -ForegroundColor Yellow
        $logsAplicacion = Get-WinEvent -FilterHashtable @{
            LogName = &#x27;Application&#x27;
            Level = 1,2,3
            StartTime = $fechaInicio
        } -MaxEvents 200 -ErrorAction SilentlyContinue |
        Select-Object TimeCreated, LevelDisplayName, ProviderName, Id,
                     @{Name=&quot;Message&quot;;Expression={$_.Message.Substring(0,[Math]::Min(300,$_.Message.Length))}}
        
        Write-Host &quot;   Recopilando logs de Seguridad...&quot; -ForegroundColor Yellow
        try {
            $eventosSeguridad = Get-WinEvent -FilterHashtable @{
                LogName = &#x27;Security&#x27;
                ID = 4624, 4625, 4634, 4647, 4648, 4740, 4767, 4771, 4776, 4616, 4720, 4722, 4724, 4738
                StartTime = $fechaInicio
            } -MaxEvents 150 -ErrorAction Stop
            
            Write-Host &quot;   Se encontraron $($eventosSeguridad.Count) eventos de seguridad&quot; -ForegroundColor Yellow
            
            
            $logsSeguridad = $eventosSeguridad | ForEach-Object {
                $evento = $_
                $cuenta = &quot;N/A&quot;
                $ip = &quot;N/A&quot;
                
                try { $cuenta = if ($evento.Properties.Count -gt 5) { $evento.Properties[5].Value } elseif ($evento.Properties.Count -gt 1) { $evento.Properties[1].Value } 
                    if ([string]::IsNullOrEmpty($cuenta)) { 
                        for ($i = 0; $i -lt [Math]::Min(10, $evento.Properties.Count); $i++) { 
                            if (![string]::IsNullOrEmpty($evento.Properties[$i].Value)) { $cuenta = $evento.Properties[$i].Value; break } 
                        } 
                    } 
                } catch { $cuenta = &quot;No disponible&quot; }
                
                $ip = if ($evento.Properties.Count -gt 19) { $evento.Properties[19].Value } elseif ($evento.Properties.Count -gt 9) { $evento.Properties[9].Value }
                
                try { $rawMessage = $evento.Message; if ($rawMessage.Length -gt 150) { $rawMessage = $rawMessage.Substring(0, 150) + &quot;...&quot; } 
                } catch { $rawMessage = &quot;[No disponible]&quot; }
                
                $tipoEvento = switch ($evento.Id) {
                    4625 { &quot;Login Fallido&quot; }
                    4648 { &quot;Login Expl√É¬≠cito&quot; }
                    4771 { &quot;Kerberos Fallido&quot; }
                    4776 { &quot;Validaci√É¬≥n&quot; }
                    4740 { &quot;Cuenta Bloqueada&quot; }
                    4767 { &quot;Desbloqueada&quot; }
                    4624 { &quot;Login&quot; }
                    4634 { &quot;Logout&quot; }
                    4647 { &quot;Logout Usuario&quot; }
                    4616 { &quot;Cambio hora&quot; }
                    4720 { &quot;Cuenta creada&quot; }
                    4722 { &quot;Cuenta habilitada&quot; }
                    4724 { &quot;Cambio pwd&quot; }
                    4738 { &quot;Cambio cuenta&quot; }
                    default { &quot;ID:$($evento.Id)&quot; }
                }
                
[PSCustomObject]@{TimeCreated=$evento.TimeCreated;Id=$evento.Id;Account=$cuenta;SourceIP=$ip;EventType=$tipoEvento;RawMessage=$rawMessage}
            }
        } catch {
            Write-Host &quot;   Error al obtener logs de seguridad: $_&quot; -ForegroundColor Red
            $logsSeguridad = @()
        }
        
        Write-Host &quot;   Total eventos encontrados - Sistema: $($logsSistema.Count), Aplicaci√É¬≥n: $($logsAplicacion.Count), Seguridad: $($logsSeguridad.Count)&quot; -ForegroundColor Yellow
        
        return @{
            LogsSistema = $logsSistema
            LogsAplicacion = $logsAplicacion
            LogsSeguridad = $logsSeguridad
        }
    } catch {
        Write-Warning &quot;Error al obtener logs de eventos: $_&quot;
        return @{ Error = $_.Exception.Message }
    }
}

function Get-AnalisisConfiabilidad {
    try {
        Write-Progress -Activity &quot;Analizando confiabilidad del sistema&quot; -PercentComplete 35
        Write-Host &quot;   Analizando registros de confiabilidad...&quot; -ForegroundColor Yellow
        
        $datos = @{}
        
        try {
            $reliabilityRecords = Get-CimInstance -ClassName Win32_ReliabilityRecords -ErrorAction SilentlyContinue | 
                                 Where-Object { $_.TimeGenerated -gt (Get-Date).AddDays(-30) } |
                                 Sort-Object TimeGenerated -Descending |
                                 Select-Object -First 100
            
            if ($reliabilityRecords) {
                Write-Host &quot;   Se encontraron $($reliabilityRecords.Count) registros de confiabilidad&quot; -ForegroundColor Yellow
                
                $eventosConfiabilidad = $reliabilityRecords | ForEach-Object {
                    $tipoEvento = switch ($_.EventIdentifier) {
                        1001 { &quot;Inicio de aplicaci√É¬≥n&quot; }
                        1002 { &quot;Fallo de aplicaci√É¬≥n&quot; }
                        1003 { &quot;Cuelgue de aplicaci√É¬≥n&quot; }
                        1004 { &quot;Instalaci√É¬≥n exitosa&quot; }
                        1005 { &quot;Fallo de instalaci√É¬≥n&quot; }
                        1006 { &quot;Inicio del sistema&quot; }
                        1007 { &quot;Apagado del sistema&quot; }
                        1008 { &quot;Fallo del sistema&quot; }
                        default { &quot;Evento ID: $($_.EventIdentifier)&quot; }
                    }
                    
                    [PSCustomObject]@{
                        Fecha = $_.TimeGenerated
                        TipoEvento = $tipoEvento
                        Fuente = $_.SourceName
                        Descripcion = if ($_.Message) { $_.Message.Substring(0, [Math]::Min(200, $_.Message.Length)) } else { &quot;N/A&quot; }
                        EventID = $_.EventIdentifier
                        Criticidad = switch ($_.EventIdentifier) {
                            { $_ -in @(1002, 1003, 1005, 1008) } { &quot;Alto&quot; }
                            { $_ -in @(1001, 1004, 1006, 1007) } { &quot;Normal&quot; }
                            default { &quot;Medio&quot; }
                        }
                    }
                }
                
                $datos.EventosConfiabilidad = $eventosConfiabilidad
                
                $fallosAplicacion = ($eventosConfiabilidad | Where-Object { $_.EventID -in @(1002, 1003) }).Count
                $fallosSistema = ($eventosConfiabilidad | Where-Object { $_.EventID -eq 1008 }).Count
                $reinicios = ($eventosConfiabilidad | Where-Object { $_.EventID -in @(1006, 1007) }).Count
                
                $datos.EstadisticasEstabilidad = @{
                    FallosAplicacion = $fallosAplicacion
                    FallosSistema = $fallosSistema
                    ReiniciosDetectados = $reinicios
                    TotalEventos = $eventosConfiabilidad.Count
                    PeriodoAnalisis = &quot;√É≈°ltimos 30 d√É¬≠as&quot;
                    IndiceEstabilidad = switch ($true) {
                        { $fallosSistema -gt 5 -or $fallosAplicacion -gt 20 } { &quot;Baja&quot; }
                        { $fallosSistema -gt 2 -or $fallosAplicacion -gt 10 } { &quot;Media&quot; }
                        default { &quot;Alta&quot; }
                    }
                }
                
                $tendenciasSemana = $eventosConfiabilidad | 
                    Group-Object { (Get-Date $_.Fecha).ToString(&quot;yyyy-MM-dd&quot;) } |
                    Sort-Object Name -Descending |
                    Select-Object -First 7 |
                    ForEach-Object {
                        $fallosDia = ($_.Group | Where-Object { $_.Criticidad -eq &quot;Alto&quot; }).Count
                        [PSCustomObject]@{
                            Fecha = $_.Name
                            TotalEventos = $_.Count
                            EventosCriticos = $fallosDia
                            Estabilidad = if ($fallosDia -eq 0) { &quot;Estable&quot; } elseif ($fallosDia -lt 3) { &quot;Moderada&quot; } else { &quot;Inestable&quot; }
                        }
                    }
                
                $datos.TendenciasSemanales = $tendenciasSemana
                
            } else {
                Write-Host &quot;   No se encontraron registros de confiabilidad o no est√É¬°n disponibles&quot; -ForegroundColor Yellow
                $datos.EventosConfiabilidad = @()
                $datos.EstadisticasEstabilidad = @{ Error = &quot;No hay datos de confiabilidad disponibles&quot; }
                $datos.TendenciasSemanales = @()
            }
            
        } catch {
            Write-Host &quot;   Error al acceder a registros de confiabilidad: $_&quot; -ForegroundColor Red
            
            try {
                Write-Host &quot;   Intentando m√É¬©todo alternativo con Event Log...&quot; -ForegroundColor Yellow
                $eventosAlternativos = Get-WinEvent -FilterHashtable @{
                    LogName = &#x27;System&#x27;
                    Level = 1,2  # Critical, Error
                    StartTime = (Get-Date).AddDays(-7)
                } -MaxEvents 50 -ErrorAction SilentlyContinue |
                Where-Object { $_.Id -in @(1001, 1074, 6005, 6006, 6008, 6009, 6013) } |
                ForEach-Object {
                    [PSCustomObject]@{
                        Fecha = $_.TimeCreated
                        TipoEvento = switch ($_.Id) {
                            1074 { &quot;Apagado del sistema&quot; }
                            6005 { &quot;Inicio del servicio Event Log&quot; }
                            6006 { &quot;Parada del servicio Event Log&quot; }
                            6008 { &quot;Apagado inesperado&quot; }
                            6009 { &quot;Informaci√É¬≥n de versi√É¬≥n del procesador&quot; }
                            6013 { &quot;Tiempo de actividad del sistema&quot; }
                            default { &quot;Evento del sistema&quot; }
                        }
                        EventID = $_.Id
                        Fuente = $_.ProviderName
                        Criticidad = if ($_.Id -eq 6008) { &quot;Alto&quot; } else { &quot;Normal&quot; }
                    }
                }
                
                $datos.EventosConfiabilidad = $eventosAlternativos
                $datos.EstadisticasEstabilidad = @{
                    Metodo = &quot;Event Log alternativo&quot;
                    ApagadosInesperados = ($eventosAlternativos | Where-Object { $_.EventID -eq 6008 }).Count
                    TotalEventos = $eventosAlternativos.Count
                    PeriodoAnalisis = &quot;√É≈°ltimos 7 d√É¬≠as&quot;
                }
                
            } catch {
                $datos.EventosConfiabilidad = @()
                $datos.EstadisticasEstabilidad = @{ Error = &quot;No se pudo obtener informaci√É¬≥n de confiabilidad: $_&quot; }
            }
        }
        
        return $datos
        
    } catch {
        Write-Warning &quot;Error en an√É¬°lisis de confiabilidad: $_&quot;
        return @{ Error = $_.Exception.Message }
    }
}

function Get-DiagnosticoHardwareAvanzado {
    try {
        Write-Progress -Activity &quot;Realizando diagn√É¬≥stico avanzado de hardware&quot; -PercentComplete 45
        Write-Host &quot;   Analizando hardware avanzado...&quot; -ForegroundColor Yellow
        
        $datos = @{}
        
        Write-Host &quot;   Verificando estado SMART de discos...&quot; -ForegroundColor Yellow
        try {
            $discosSMART = Get-CimInstance -ClassName Win32_DiskDrive -ErrorAction SilentlyContinue | ForEach-Object {
                $disco = $_
                $smartData = $null
                
                try {
                    # Intentar obtener datos SMART
                    $smartData = Get-CimInstance -ClassName MSStorageDriver_FailurePredictStatus -Namespace &quot;root\wmi&quot; -ErrorAction SilentlyContinue |
                                Where-Object { $_.InstanceName -like &quot;*$($disco.PNPDeviceID)*&quot; }
                    
                    if (-not $smartData) {
                        # M√É¬©todo alternativo
                        $smartData = Get-CimInstance -ClassName Win32_DiskDrive -ErrorAction SilentlyContinue |
                                    Where-Object { $_.DeviceID -eq $disco.DeviceID } |
                                    ForEach-Object {
                                        [PSCustomObject]@{
                                            PredictFailure = $false
                                            Reason = &quot;Datos SMART no disponibles&quot;
                                        }
                                    }
                    }
                } catch {
                    $smartData = [PSCustomObject]@{
                        PredictFailure = $null
                        Reason = &quot;Error al acceder a SMART: $_&quot;
                    }
                }
                
                [PSCustomObject]@{
                    Modelo = $disco.Model
                    NumeroSerie = $disco.SerialNumber
                    TamanoGB = [math]::Round($disco.Size / 1GB, 2)
                    Interfaz = $disco.InterfaceType
                    EstadoSMART = if ($smartData.PredictFailure -eq $true) { &quot;FALLO PREDICHO&quot; } 
                                 elseif ($smartData.PredictFailure -eq $false) { &quot;Saludable&quot; } 
                                 else { &quot;No disponible&quot; }
                    DetallesSMART = $smartData.Reason
                    Particiones = (Get-CimInstance -ClassName Win32_DiskPartition -ErrorAction SilentlyContinue | 
                                  Where-Object { $_.DiskIndex -eq $disco.Index }).Count
                    Estado = switch ($smartData.PredictFailure) {
                        $true { &quot;Cr√É¬≠tico&quot; }
                        $false { &quot;Normal&quot; }
                        default { &quot;Desconocido&quot; }
                    }
                }
            }
            
            $datos.DiscosSMART = $discosSMART
            
        } catch {
            Write-Host &quot;   Error al obtener datos SMART: $_&quot; -ForegroundColor Red
            $datos.DiscosSMART = @{ Error = &quot;No se pudo obtener informaci√É¬≥n SMART: $_&quot; }
        }
        
        Write-Host &quot;   Verificando temperaturas de componentes...&quot; -ForegroundColor Yellow
        try {
            $temperaturas = @()
            
            $tempCPU = Get-CimInstance -ClassName Win32_PerfRawData_Counters_ThermalZoneInformation -ErrorAction SilentlyContinue |
                      Where-Object { $_.Name -like &quot;*CPU*&quot; -or $_.Name -like &quot;*Processor*&quot; } |
                      ForEach-Object {
                          $tempKelvin = $_.Temperature
                          $tempCelsius = if ($tempKelvin -and $tempKelvin -gt 0) { 
                              [math]::Round(($tempKelvin / 10) - 273.15, 1) 
                          } else { $null }
                          
                          [PSCustomObject]@{
                              Componente = &quot;CPU - $($_.Name)&quot;
                              TemperaturaC = $tempCelsius
                              Estado = if ($tempCelsius -gt 80) { &quot;Cr√É¬≠tico&quot; } 
                                      elseif ($tempCelsius -gt 70) { &quot;Alto&quot; } 
                                      elseif ($tempCelsius -gt 0) { &quot;Normal&quot; } 
                                      else { &quot;No disponible&quot; }
                          }
                      }
            
            if ($tempCPU) { $temperaturas += $tempCPU }
            
            try {
                $wmiTemp = Get-CimInstance -ClassName MSAcpi_ThermalZoneTemperature -Namespace &quot;root\wmi&quot; -ErrorAction SilentlyContinue |
                          ForEach-Object {
                              $tempKelvin = $_.CurrentTemperature
                              $tempCelsius = if ($tempKelvin -and $tempKelvin -gt 0) { 
                                  [math]::Round(($tempKelvin / 10) - 273.15, 1) 
                              } else { $null }
                              
                              [PSCustomObject]@{
                                  Componente = &quot;Zona T√É¬©rmica - $($_.InstanceName)&quot;
                                  TemperaturaC = $tempCelsius
                                  Estado = if ($tempCelsius -gt 80) { &quot;Cr√É¬≠tico&quot; } 
                                          elseif ($tempCelsius -gt 70) { &quot;Alto&quot; } 
                                          elseif ($tempCelsius -gt 0) { &quot;Normal&quot; } 
                                          else { &quot;No disponible&quot; }
                              }
                          }
                
                if ($wmiTemp) { $temperaturas += $wmiTemp }
                
            } catch {
                Write-Host &quot;   M√É¬©todo WMI para temperaturas no disponible&quot; -ForegroundColor Yellow
            }
            
            if ($temperaturas.Count -eq 0) {
                $temperaturas = @([PSCustomObject]@{
                    Componente = &quot;Sistema&quot;
                    TemperaturaC = $null
                    Estado = &quot;Sensores de temperatura no disponibles&quot;
                })
            }
            
            $datos.Temperaturas = $temperaturas
            
        } catch {
            Write-Host &quot;   Error al obtener temperaturas: $_&quot; -ForegroundColor Red
            $datos.Temperaturas = @{ Error = &quot;No se pudo obtener informaci√É¬≥n de temperatura: $_&quot; }
        }
        
        Write-Host &quot;   Verificando estado de la bater√É¬≠a...&quot; -ForegroundColor Yellow
        try {
            $baterias = Get-CimInstance -ClassName Win32_Battery -ErrorAction SilentlyContinue
            
            if ($baterias) {
                $estadoBaterias = $baterias | ForEach-Object {
                    $bateria = $_
                    
                    $batteryStatus = Get-CimInstance -ClassName BatteryStatus -Namespace &quot;root\wmi&quot; -ErrorAction SilentlyContinue |
                                    Where-Object { $_.InstanceName -like &quot;*$($bateria.DeviceID)*&quot; }
                    
                    $estadoCarga = switch ($bateria.BatteryStatus) {
                        1 { &quot;Desconocido&quot; }
                        2 { &quot;Cargando&quot; }
                        3 { &quot;Descargando&quot; }
                        4 { &quot;Cr√É¬≠tico&quot; }
                        5 { &quot;Bajo&quot; }
                        6 { &quot;Cargando y Alto&quot; }
                        7 { &quot;Cargando y Bajo&quot; }
                        8 { &quot;Cargando y Cr√É¬≠tico&quot; }
                        9 { &quot;Indefinido&quot; }
                        10 { &quot;Parcialmente Cargado&quot; }
                        11 { &quot;Completamente Cargado&quot; }
                        default { &quot;Estado $($bateria.BatteryStatus)&quot; }
                    }
                    
                    [PSCustomObject]@{
                        Nombre = $bateria.Name
                        Fabricante = $bateria.Manufacturer
                        EstadoCarga = $estadoCarga
                        PorcentajeCarga = $bateria.EstimatedChargeRemaining
                        TiempoRestante = if ($bateria.EstimatedRunTime -and $bateria.EstimatedRunTime -ne 71582788) { 
                            &quot;$([math]::Round($bateria.EstimatedRunTime / 60, 1)) horas&quot; 
                        } else { &quot;Calculando...&quot; }
                        CapacidadDise√É¬±o = if ($bateria.DesignCapacity) { &quot;$($bateria.DesignCapacity) mWh&quot; } else { &quot;N/A&quot; }
                        CapacidadCompleta = if ($bateria.FullChargeCapacity) { &quot;$($bateria.FullChargeCapacity) mWh&quot; } else { &quot;N/A&quot; }
                        SaludBateria = if ($bateria.DesignCapacity -and $bateria.FullChargeCapacity) {
                            $salud = [math]::Round(($bateria.FullChargeCapacity / $bateria.DesignCapacity) * 100, 1)
                            &quot;$salud%&quot;
                        } else { &quot;No disponible&quot; }
                        Estado = switch ($true) {
                            { $bateria.BatteryStatus -in @(4, 8) } { &quot;Cr√É¬≠tico&quot; }
                            { $bateria.BatteryStatus -in @(5, 7) } { &quot;Bajo&quot; }
                            { $bateria.EstimatedChargeRemaining -lt 20 } { &quot;Advertencia&quot; }
                            default { &quot;Normal&quot; }
                        }
                    }
                }
                
                $datos.Baterias = $estadoBaterias
                
            } else {
                $datos.Baterias = @([PSCustomObject]@{
                    Estado = &quot;No se detectaron bater√É¬≠as (sistema de escritorio)&quot;
                })
            }
            
        } catch {
            Write-Host &quot;   Error al obtener estado de bater√É¬≠a: $_&quot; -ForegroundColor Red
            $datos.Baterias = @{ Error = &quot;No se pudo obtener informaci√É¬≥n de bater√É¬≠a: $_&quot; }
        }
        
        Write-Host &quot;   Recopilando informaci√É¬≥n adicional de hardware...&quot; -ForegroundColor Yellow
        try {
            $memoriaFisica = Get-CimInstance -ClassName Win32_PhysicalMemory -ErrorAction SilentlyContinue | ForEach-Object {
                [PSCustomObject]@{
                    Ubicacion = $_.DeviceLocator
                    Capacidad = &quot;$([math]::Round($_.Capacity / 1GB, 2)) GB&quot;
                    Velocidad = &quot;$($_.Speed) MHz&quot;
                    Fabricante = $_.Manufacturer
                    NumeroSerie = $_.SerialNumber
                    TipoMemoria = switch ($_.MemoryType) {
                        20 { &quot;DDR&quot; }
                        21 { &quot;DDR2&quot; }
                        22 { &quot;DDR2 FB-DIMM&quot; }
                        24 { &quot;DDR3&quot; }
                        26 { &quot;DDR4&quot; }
                        default { &quot;Tipo $($_.MemoryType)&quot; }
                    }
                }
            }
            
            $datos.MemoriaFisica = $memoriaFisica
            
            $ventiladores = Get-CimInstance -ClassName Win32_Fan -ErrorAction SilentlyContinue | ForEach-Object {
                [PSCustomObject]@{
                    Nombre = $_.Name
                    Descripcion = $_.Description
                    Estado = switch ($_.Status) {
                        &quot;OK&quot; { &quot;Normal&quot; }
                        &quot;Error&quot; { &quot;Error&quot; }
                        &quot;Degraded&quot; { &quot;Degradado&quot; }
                        default { $_.Status }
                    }
                    Activo = $_.ActiveCooling
                }
            }
            
            if ($ventiladores.Count -eq 0) {
                $ventiladores = @([PSCustomObject]@{
                    Estado = &quot;No se detectaron ventiladores o informaci√É¬≥n no disponible&quot;
                })
            }
            
            $datos.Ventiladores = $ventiladores
            
        } catch {
            Write-Host &quot;   Error al obtener informaci√É¬≥n adicional de hardware: $_&quot; -ForegroundColor Red
            $datos.MemoriaFisica = @{ Error = &quot;No disponible&quot; }
            $datos.Ventiladores = @{ Error = &quot;No disponible&quot; }
        }
        
        return $datos
        
    } catch {
        Write-Warning &quot;Error en diagn√É¬≥stico de hardware avanzado: $_&quot;
        return @{ Error = $_.Exception.Message }
    }
}

function Get-AnalisisRolesServidor {
    try {
        Write-Progress -Activity &quot;Analizando roles y caracter√É¬≠sticas del servidor&quot; -PercentComplete 55
        Write-Host &quot;   Analizando roles de Windows Server...&quot; -ForegroundColor Yellow
        
        $datos = @{}
        
        $os = Get-CimInstance -ClassName Win32_OperatingSystem
        $esServidor = $os.ProductType -eq 2 -or $os.ProductType -eq 3 -or $os.Caption -like &quot;*Server*&quot;
        
        if (-not $esServidor) {
            Write-Host &quot;   Sistema detectado como cliente Windows, no servidor&quot; -ForegroundColor Yellow
            return @{
                TipoSistema = &quot;Cliente Windows&quot;
                EsServidor = $false
                Mensaje = &quot;Este sistema no es Windows Server. An√É¬°lisis de roles no aplicable.&quot;
            }
        }
        
        Write-Host &quot;   Sistema Windows Server detectado, analizando roles...&quot; -ForegroundColor Yellow
        $datos.EsServidor = $true
        $datos.TipoSistema = &quot;Windows Server&quot;
        
        # 1. ROLES Y CARACTER√É¬çSTICAS USANDO DISM (m√É¬°s compatible)
        try {
            Write-Host &quot;   Obteniendo caracter√É¬≠sticas mediante DISM...&quot; -ForegroundColor Yellow
            $dismFeatures = dism /online /get-features /format:table | Out-String
            
            # Parsear salida de DISM para caracter√É¬≠sticas habilitadas
            $caracteristicasHabilitadas = @()
            $lineas = $dismFeatures -split &quot;`n&quot; | Where-Object { $_ -match &quot;Enabled&quot; }
            
            foreach ($linea in $lineas) {
                if ($linea -match &quot;^([^\|]+)\|.*Enabled&quot;) {
                    $nombreCaracteristica = $matches[1].Trim()
                    if ($nombreCaracteristica -and $nombreCaracteristica -ne &quot;Feature Name&quot;) {
                        $caracteristicasHabilitadas += $nombreCaracteristica
                    }
                }
            }
            
            $datos.CaracteristicasDISM = $caracteristicasHabilitadas
            
        } catch {
            Write-Host &quot;   Error al usar DISM: $_&quot; -ForegroundColor Red
            $datos.CaracteristicasDISM = @(&quot;Error al obtener caracter√É¬≠sticas via DISM&quot;)
        }
        
        # 2. SERVICIOS DE ROLES ESPEC√É¬çFICOS
        Write-Host &quot;   Analizando servicios de roles espec√É¬≠ficos...&quot; -ForegroundColor Yellow
        $rolesDetectados = @()
        
        # Active Directory Domain Services
        $addsService = Get-Service -Name &quot;NTDS&quot; -ErrorAction SilentlyContinue
        if ($addsService) {
            $rolesDetectados += [PSCustomObject]@{
                Rol = &quot;Active Directory Domain Services&quot;
                Servicio = &quot;NTDS&quot;
                Estado = $addsService.Status
                TipoInicio = $addsService.StartType
                Descripcion = &quot;Controlador de dominio Active Directory&quot;
                Critico = $true
            }
        }
        
        # DNS Server
        $dnsService = Get-Service -Name &quot;DNS&quot; -ErrorAction SilentlyContinue
        if ($dnsService) {
            $rolesDetectados += [PSCustomObject]@{
                Rol = &quot;DNS Server&quot;
                Servicio = &quot;DNS&quot;
                Estado = $dnsService.Status
                TipoInicio = $dnsService.StartType
                Descripcion = &quot;Servidor DNS&quot;
                Critico = $true
            }
        }
        
        # DHCP Server
        $dhcpService = Get-Service -Name &quot;DHCPServer&quot; -ErrorAction SilentlyContinue
        if ($dhcpService) {
            $rolesDetectados += [PSCustomObject]@{
                Rol = &quot;DHCP Server&quot;
                Servicio = &quot;DHCPServer&quot;
                Estado = $dhcpService.Status
                TipoInicio = $dhcpService.StartType
                Descripcion = &quot;Servidor DHCP&quot;
                Critico = $false
            }
        }
        
        # IIS (Internet Information Services)
        $iisService = Get-Service -Name &quot;W3SVC&quot; -ErrorAction SilentlyContinue
        if ($iisService) {
            $rolesDetectados += [PSCustomObject]@{
                Rol = &quot;Web Server (IIS)&quot;
                Servicio = &quot;W3SVC&quot;
                Estado = $iisService.Status
                TipoInicio = $iisService.StartType
                Descripcion = &quot;Servidor web IIS&quot;
                Critico = $false
            }
            
            # Informaci√É¬≥n adicional de IIS
            try {
                $iisInfo = Get-CimInstance -ClassName Win32_Service -Filter &quot;Name=&#x27;W3SVC&#x27;&quot; -ErrorAction SilentlyContinue
                $sitiosIIS = @()
                
                # Intentar obtener sitios web si IIS est√É¬° instalado
                if (Get-Command &quot;Get-IISSite&quot; -ErrorAction SilentlyContinue) {
                    $sitiosIIS = Get-IISSite | ForEach-Object {
                        [PSCustomObject]@{
                            Nombre = $_.Name
                            Estado = $_.State
                            Puerto = ($_.Bindings | ForEach-Object { $_.EndPoint.Port }) -join &quot;, &quot;
                            RutaFisica = $_.PhysicalPath
                        }
                    }
                } else {
                    # M√É¬©todo alternativo usando appcmd si est√É¬° disponible
                    try {
                        $appcmdPath = &quot;$env:SystemRoot\System32\inetsrv\appcmd.exe&quot;
                        if (Test-Path $appcmdPath) {
                            $sitiosOutput = &amp; $appcmdPath list sites
                            $sitiosIIS = $sitiosOutput | ForEach-Object {
                                if ($_ -match &#x27;SITE &quot;([^&quot;]+)&quot; $$id:(\d+),bindings:([^,]+),state:(\w+)$$&#x27;) {
                                    [PSCustomObject]@{
                                        Nombre = $matches[1]
                                        ID = $matches[2]
                                        Bindings = $matches[3]
                                        Estado = $matches[4]
                                    }
                                }
                            }
                        }
                    } catch {
                        $sitiosIIS = @([PSCustomObject]@{ Info = &quot;No se pudo obtener informaci√É¬≥n de sitios IIS&quot; })
                    }
                }
                
                $datos.SitiosIIS = $sitiosIIS
                
            } catch {
                $datos.SitiosIIS = @{ Error = &quot;Error al obtener informaci√É¬≥n de IIS: $_&quot; }
            }
        }
        
        # File and Storage Services
        $lanmanService = Get-Service -Name &quot;LanmanServer&quot; -ErrorAction SilentlyContinue
        if ($lanmanService -and $lanmanService.Status -eq &quot;Running&quot;) {
            $rolesDetectados += [PSCustomObject]@{
                Rol = &quot;File and Storage Services&quot;
                Servicio = &quot;LanmanServer&quot;
                Estado = $lanmanService.Status
                TipoInicio = $lanmanService.StartType
                Descripcion = &quot;Servicios de archivos y almacenamiento&quot;
                Critico = $false
            }
        }
        
        # Print and Document Services
        $spoolerService = Get-Service -Name &quot;Spooler&quot; -ErrorAction SilentlyContinue
        if ($spoolerService -and $spoolerService.Status -eq &quot;Running&quot;) {
            # Verificar si hay impresoras compartidas
            $impresorasCompartidas = Get-CimInstance -ClassName Win32_Printer -ErrorAction SilentlyContinue | 
                                    Where-Object { $_.Shared -eq $true }
            
            if ($impresorasCompartidas) {
                $rolesDetectados += [PSCustomObject]@{
                    Rol = &quot;Print and Document Services&quot;
                    Servicio = &quot;Spooler&quot;
                    Estado = $spoolerService.Status
                    TipoInicio = $spoolerService.StartType
                    Descripcion = &quot;Servicios de impresi√É¬≥n y documentos&quot;
                    Critico = $false
                }
            }
        }
        
        # Remote Desktop Services
        $termService = Get-Service -Name &quot;TermService&quot; -ErrorAction SilentlyContinue
        if ($termService) {
            $rolesDetectados += [PSCustomObject]@{
                Rol = &quot;Remote Desktop Services&quot;
                Servicio = &quot;TermService&quot;
                Estado = $termService.Status
                TipoInicio = $termService.StartType
                Descripcion = &quot;Servicios de escritorio remoto&quot;
                Critico = $false
            }
        }
        
        # Windows Server Update Services (WSUS)
        $wsusService = Get-Service -Name &quot;WsusService&quot; -ErrorAction SilentlyContinue
        if ($wsusService) {
            $rolesDetectados += [PSCustomObject]@{
                Rol = &quot;Windows Server Update Services&quot;
                Servicio = &quot;WsusService&quot;
                Estado = $wsusService.Status
                TipoInicio = $wsusService.StartType
                Descripcion = &quot;Servidor WSUS&quot;
                Critico = $false
            }
        }
        
        # Hyper-V
        $hypervService = Get-Service -Name &quot;vmms&quot; -ErrorAction SilentlyContinue
        if ($hypervService) {
            $rolesDetectados += [PSCustomObject]@{
                Rol = &quot;Hyper-V&quot;
                Servicio = &quot;vmms&quot;
                Estado = $hypervService.Status
                TipoInicio = $hypervService.StartType
                Descripcion = &quot;Plataforma de virtualizaci√É¬≥n Hyper-V&quot;
                Critico = $false
            }
            
            # Informaci√É¬≥n adicional de Hyper-V
            try {
                if (Get-Command &quot;Get-VM&quot; -ErrorAction SilentlyContinue) {
                    $vms = Get-VM -ErrorAction SilentlyContinue | ForEach-Object {
                        [PSCustomObject]@{
                            Nombre = $_.Name
                            Estado = $_.State
                            CPUs = $_.ProcessorCount
                            MemoriaGB = [math]::Round($_.MemoryAssigned / 1GB, 2)
                            TiempoActividad = if ($_.Uptime) { $_.Uptime.ToString() } else { &quot;N/A&quot; }
                        }
                    }
                    $datos.MaquinasVirtuales = $vms
                } else {
                    $datos.MaquinasVirtuales = @{ Info = &quot;Cmdlets de Hyper-V no disponibles&quot; }
                }
            } catch {
                $datos.MaquinasVirtuales = @{ Error = &quot;Error al obtener VMs: $_&quot; }
            }
        }
        
        $datos.RolesDetectados = $rolesDetectados
        
        # 3. INFORMACI√É‚ÄúN ADICIONAL DEL SERVIDOR
        Write-Host &quot;   Recopilando informaci√É¬≥n adicional del servidor...&quot; -ForegroundColor Yellow
        
        # Informaci√É¬≥n de dominio
        try {
            $dominioInfo = Get-CimInstance -ClassName Win32_ComputerSystem
            $datos.InformacionDominio = @{
                ParteDominio = $dominioInfo.PartOfDomain
                Dominio = $dominioInfo.Domain
                Workgroup = $dominioInfo.Workgroup
                Rol = switch ($dominioInfo.DomainRole) {
                    0 { &quot;Standalone Workstation&quot; }
                    1 { &quot;Member Workstation&quot; }
                    2 { &quot;Standalone Server&quot; }
                    3 { &quot;Member Server&quot; }
                    4 { &quot;Backup Domain Controller&quot; }
                    5 { &quot;Primary Domain Controller&quot; }
                    default { &quot;Desconocido ($($dominioInfo.DomainRole))&quot; }
                }
            }
        } catch {
            $datos.InformacionDominio = @{ Error = &quot;No se pudo obtener informaci√É¬≥n de dominio&quot; }
        }
        
        # Caracter√É¬≠sticas de Windows instaladas
        try {
            $caracteristicasWindows = Get-WindowsFeature -ErrorAction SilentlyContinue | 
                                     Where-Object { $_.InstallState -eq &quot;Installed&quot; } |
                                     Select-Object Name, DisplayName, InstallState |
                                     Sort-Object DisplayName
            
            if ($caracteristicasWindows) {
                $datos.CaracteristicasWindows = $caracteristicasWindows
            } else {
                # M√É¬©todo alternativo si Get-WindowsFeature no est√É¬° disponible
                $datos.CaracteristicasWindows = @{ Info = &quot;Get-WindowsFeature no disponible en esta versi√É¬≥n&quot; }
            }
        } catch {
            $datos.CaracteristicasWindows = @{ Error = &quot;Error al obtener caracter√É¬≠sticas de Windows: $_&quot; }
        }
        
        # Resumen de estado de roles
        $rolesCriticos = $rolesDetectados | Where-Object { $_.Critico -eq $true }
        $rolesDetenidos = $rolesDetectados | Where-Object { $_.Estado -ne &quot;Running&quot; }
        
        $datos.ResumenRoles = @{
            TotalRoles = $rolesDetectados.Count
            RolesCriticos = $rolesCriticos.Count
            RolesDetenidos = $rolesDetenidos.Count
            EstadoGeneral = if ($rolesDetenidos.Count -eq 0) { &quot;Todos los roles funcionando&quot; } 
                           elseif ($rolesDetenidos.Count -eq 1) { &quot;1 rol detenido&quot; } 
                           else { &quot;$($rolesDetenidos.Count) roles detenidos&quot; }
        }
        
        return $datos
        
    } catch {
        Write-Warning &quot;Error en an√É¬°lisis de roles del servidor: $_&quot;
        return @{ Error = $_.Exception.Message }
    }
}

# NUEVA FUNCI√É‚ÄúN: An√É¬°lisis de Pol√É¬≠ticas de Grupo (GPO)
function Get-AnalisisPoliticasGrupo {
    try {
        Write-Progress -Activity &quot;Analizando pol√É¬≠ticas de grupo aplicadas&quot; -PercentComplete 60
        Write-Host &quot;   Analizando pol√É¬≠ticas de grupo (GPO)...&quot; -ForegroundColor Yellow
        
        $datos = @{}
        
        # 1. OBTENER INFORMACI√É‚ÄúN B√É¬ÅSICA DE GPO
        try {
            # Verificar si el sistema est√É¬° en un dominio
            $computerSystem = Get-CimInstance -ClassName Win32_ComputerSystem
            if (-not $computerSystem.PartOfDomain) {
                Write-Host &quot;   Sistema no est√É¬° en dominio, an√É¬°lisis GPO limitado&quot; -ForegroundColor Yellow
                return @{
                    EnDominio = $false
                    Mensaje = &quot;El sistema no est√É¬° unido a un dominio. An√É¬°lisis de GPO no aplicable.&quot;
                    PoliticasLocales = Get-AnalisisPoliticasLocales
                }
            }
            
            Write-Host &quot;   Sistema en dominio detectado, analizando GPOs...&quot; -ForegroundColor Yellow
            $datos.EnDominio = $true
            
            # Ejecutar gpresult para obtener informaci√É¬≥n de GPO
            $gpresultOutput = gpresult /r /scope:computer 2&gt;$null
            $gpresultUser = gpresult /r /scope:user 2&gt;$null
            
            # Parsear informaci√É¬≥n de GPO del equipo
            $gpoComputer = @()
            $gpoUser = @()
            
            if ($gpresultOutput) {
                $inGPOSection = $false
                foreach ($line in $gpresultOutput) {
                    if ($line -match &quot;Applied Group Policy Objects&quot;) {
                        $inGPOSection = $true
                        continue
                    }
                    if ($inGPOSection -and $line.Trim() -ne &quot;&quot; -and $line -notmatch &quot;^-+$&quot;) {
                        if ($line -match &quot;The following GPOs were not applied&quot;) {
                            break
                        }
                        $gpoName = $line.Trim()
                        if ($gpoName -and $gpoName -ne &quot;None&quot;) {
                            $gpoComputer += [PSCustomObject]@{
                                Nombre = $gpoName
                                Tipo = &quot;Equipo&quot;
                                Estado = &quot;Aplicada&quot;
                            }
                        }
                    }
                }
            }
            
            # Parsear informaci√É¬≥n de GPO del usuario
            if ($gpresultUser) {
                $inGPOSection = $false
                foreach ($line in $gpresultUser) {
                    if ($line -match &quot;Applied Group Policy Objects&quot;) {
                        $inGPOSection = $true
                        continue
                    }
                    if ($inGPOSection -and $line.Trim() -ne &quot;&quot; -and $line -notmatch &quot;^-+$&quot;) {
                        if ($line -match &quot;The following GPOs were not applied&quot;) {
                            break
                        }
                        $gpoName = $line.Trim()
                        if ($gpoName -and $gpoName -ne &quot;None&quot;) {
                            $gpoUser += [PSCustomObject]@{
                                Nombre = $gpoName
                                Tipo = &quot;Usuario&quot;
                                Estado = &quot;Aplicada&quot;
                            }
                        }
                    }
                }
            }
            
            $datos.GPOsEquipo = $gpoComputer
            $datos.GPOsUsuario = $gpoUser
            
            # Obtener informaci√É¬≥n detallada con gpresult /v
            try {
                Write-Host &quot;   Obteniendo detalles de configuraci√É¬≥n GPO...&quot; -ForegroundColor Yellow
                $gpresultDetailed = gpresult /v /scope:computer 2&gt;$null
                
                # Parsear configuraciones espec√É¬≠ficas
                $configuracionesSeguridad = @()
                $configuracionesRed = @()
                $configuracionesAuditoria = @()
                
                if ($gpresultDetailed) {
                    $currentSection = &quot;&quot;
                    foreach ($line in $gpresultDetailed) {
                        # Identificar secciones importantes
                        if ($line -match &quot;Security Settings&quot;) {
                            $currentSection = &quot;Security&quot;
                        } elseif ($line -match &quot;Network&quot;) {
                            $currentSection = &quot;Network&quot;
                        } elseif ($line -match &quot;Audit&quot;) {
                            $currentSection = &quot;Audit&quot;
                        }
                        
                        # Extraer configuraciones relevantes
                        if ($line -match &quot;^\s+(.+):\s+(.+)$&quot;) {
                            $setting = $matches[1].Trim()
                            $value = $matches[2].Trim()
                            
                            $configObj = [PSCustomObject]@{
                                Configuracion = $setting
                                Valor = $value
                                Seccion = $currentSection
                            }
                            
                            switch ($currentSection) {
                                &quot;Security&quot; { $configuracionesSeguridad += $configObj }
                                &quot;Network&quot; { $configuracionesRed += $configObj }
                                &quot;Audit&quot; { $configuracionesAuditoria += $configObj }
                            }
                        }
                    }
                }
                
                $datos.ConfiguracionesSeguridad = $configuracionesSeguridad
                $datos.ConfiguracionesRed = $configuracionesRed
                $datos.ConfiguracionesAuditoria = $configuracionesAuditoria
                
            } catch {
                Write-Host &quot;   Error al obtener detalles de GPO: $_&quot; -ForegroundColor Red
                $datos.ConfiguracionesSeguridad = @()
                $datos.ConfiguracionesRed = @()
                $datos.ConfiguracionesAuditoria = @()
            }
            
            # Informaci√É¬≥n de √É¬∫ltima actualizaci√É¬≥n de GPO
            try {
                $gpoUpdateInfo = gpresult /r | Select-String &quot;Last time Group Policy was applied&quot;
                if ($gpoUpdateInfo) {
                    $datos.UltimaActualizacionGPO = $gpoUpdateInfo.ToString().Split(&quot;:&quot;)[1].Trim()
                } else {
                    $datos.UltimaActualizacionGPO = &quot;No disponible&quot;
                }
            } catch {
                $datos.UltimaActualizacionGPO = &quot;Error al obtener fecha&quot;
            }
            
        } catch {
            Write-Host &quot;   Error al analizar GPOs: $_&quot; -ForegroundColor Red
            $datos.Error = &quot;Error al obtener informaci√É¬≥n de GPO: $_&quot;
        }
        
        # 2. AN√É¬ÅLISIS DE POL√É¬çTICAS LOCALES (siempre disponible)
        $datos.PoliticasLocales = Get-AnalisisPoliticasLocales
        
        return $datos
        
    } catch {
        Write-Warning &quot;Error en an√É¬°lisis de pol√É¬≠ticas de grupo: $_&quot;
        return @{ Error = $_.Exception.Message }
    }
}

function Get-AnalisisPoliticasLocales {
    try {
        Write-Host &quot;   Analizando pol√É¬≠ticas de seguridad locales...&quot; -ForegroundColor Yellow
        
        $politicasLocales = @()
        
        # Pol√É¬≠ticas de contrase√É¬±as
        try {
            $secpol = secedit /export /cfg &quot;$env:TEMP\secpol.cfg&quot; 2&gt;$null
            if (Test-Path &quot;$env:TEMP\secpol.cfg&quot;) {
                $secpolContent = Get-Content &quot;$env:TEMP\secpol.cfg&quot;
                
                foreach ($line in $secpolContent) {
                    if ($line -match &quot;^(.+)\s*=\s*(.+)$&quot;) {
                        $setting = $matches[1].Trim()
                        $value = $matches[2].Trim()
                        
                        # Mapear configuraciones importantes
                        $descripcion = switch ($setting) {
                            &quot;MinimumPasswordAge&quot; { &quot;Edad m√É¬≠nima de contrase√É¬±a (d√É¬≠as)&quot; }
                            &quot;MaximumPasswordAge&quot; { &quot;Edad m√É¬°xima de contrase√É¬±a (d√É¬≠as)&quot; }
                            &quot;MinimumPasswordLength&quot; { &quot;Longitud m√É¬≠nima de contrase√É¬±a&quot; }
                            &quot;PasswordComplexity&quot; { &quot;Complejidad de contrase√É¬±a requerida&quot; }
                            &quot;PasswordHistorySize&quot; { &quot;Historial de contrase√É¬±as&quot; }
                            &quot;LockoutBadCount&quot; { &quot;Umbral de bloqueo de cuenta&quot; }
                            &quot;LockoutDuration&quot; { &quot;Duraci√É¬≥n de bloqueo (minutos)&quot; }
                            &quot;ResetLockoutCount&quot; { &quot;Restablecer contador despu√É¬©s de (minutos)&quot; }
                            &quot;RequireLogonToChangePassword&quot; { &quot;Requerir logon para cambiar contrase√É¬±a&quot; }
                            &quot;ClearTextPassword&quot; { &quot;Almacenar contrase√É¬±as con cifrado reversible&quot; }
                            default { $setting }
                        }
                        
                        if ($descripcion -ne $setting) {
                            $politicasLocales += [PSCustomObject]@{
                                Politica = $descripcion
                                Valor = $value
                                Configuracion = $setting
                                Categoria = &quot;Pol√É¬≠ticas de Contrase√É¬±a&quot;
                            }
                        }
                    }
                }
                
                Remove-Item &quot;$env:TEMP\secpol.cfg&quot; -Force -ErrorAction SilentlyContinue
            }
        } catch {
            Write-Host &quot;   Error al obtener pol√É¬≠ticas de seguridad locales: $_&quot; -ForegroundColor Red
        }
        
        # Pol√É¬≠ticas de auditor√É¬≠a
        try {
            $auditPolicies = auditpol /get /category:* 2&gt;$null
            if ($auditPolicies) {
                $currentCategory = &quot;&quot;
                foreach ($line in $auditPolicies) {
                    if ($line -match &quot;^\s*(.+):$&quot;) {
                        $currentCategory = $matches[1].Trim()
                    } elseif ($line -match &quot;^\s+(.+?)\s+(Success and Failure|Success|Failure|No Auditing)$&quot;) {
                        $auditType = $matches[1].Trim()
                        $auditSetting = $matches[2].Trim()
                        
                        $politicasLocales += [PSCustomObject]@{
                            Politica = $auditType
                            Valor = $auditSetting
                            Configuracion = $auditType
                            Categoria = &quot;Auditor√É¬≠a - $currentCategory&quot;
                        }
                    }
                }
            }
        } catch {
            Write-Host &quot;   Error al obtener pol√É¬≠ticas de auditor√É¬≠a: $_&quot; -ForegroundColor Red
        }
        
        return $politicasLocales
        
    } catch {
        Write-Warning &quot;Error al obtener pol√É¬≠ticas locales: $_&quot;
        return @()
    }
}

# NUEVA FUNCI√É‚ÄúN: Verificaci√É¬≥n de Cumplimiento (CIS Benchmarks b√É¬°sicos)
function Get-VerificacionCumplimiento {
    try {
        Write-Progress -Activity &quot;Verificando cumplimiento con est√É¬°ndares de seguridad&quot; -PercentComplete 65
        Write-Host &quot;   Verificando cumplimiento con CIS Benchmarks...&quot; -ForegroundColor Yellow
        
        $verificaciones = @()
        
        # 1. VERIFICACIONES DE POL√É¬çTICAS DE CONTRASE√É‚ÄòA
        Write-Host &quot;   Verificando pol√É¬≠ticas de contrase√É¬±a...&quot; -ForegroundColor Yellow
        
        # Obtener pol√É¬≠ticas de contrase√É¬±a actuales
        $passwordPolicy = net accounts 2&gt;$null
        $minPasswordLength = 0
        $maxPasswordAge = 0
        $minPasswordAge = 0
        $passwordComplexity = $false
        
        if ($passwordPolicy) {
            foreach ($line in $passwordPolicy) {
                if ($line -match &quot;Minimum password length:\s*(\d+)&quot;) {
                    $minPasswordLength = [int]$matches[1]
                } elseif ($line -match &quot;Maximum password age $$days$$:\s*(\d+)&quot;) {
                    $maxPasswordAge = [int]$matches[1]
                } elseif ($line -match &quot;Minimum password age $$days$$:\s*(\d+)&quot;) {
                    $minPasswordAge = [int]$matches[1]
                }
            }
        }
        
        # Verificar complejidad de contrase√É¬±a
        try {
            $secpol = secedit /export /cfg &quot;$env:TEMP\secpol_check.cfg&quot; 2&gt;$null
            if (Test-Path &quot;$env:TEMP\secpol_check.cfg&quot;) {
                $secpolContent = Get-Content &quot;$env:TEMP\secpol_check.cfg&quot;
                $complexityLine = $secpolContent | Where-Object { $_ -match &quot;PasswordComplexity&quot; }
                if ($complexityLine -and $complexityLine -match &quot;=\s*1&quot;) {
                    $passwordComplexity = $true
                }
                Remove-Item &quot;$env:TEMP\secpol_check.cfg&quot; -Force -ErrorAction SilentlyContinue
            }
        } catch {}
        
        # CIS 1.1.1 - Enforce password history
        $verificaciones += [PSCustomObject]@{
            ID = &quot;CIS-1.1.1&quot;
            Descripcion = &quot;Enforce password history: 24 or more passwords remembered&quot;
            Categoria = &quot;Pol√É¬≠ticas de Contrase√É¬±a&quot;
            EstadoActual = &quot;Verificar manualmente&quot;
            Recomendacion = &quot;24 o m√É¬°s contrase√É¬±as&quot;
            Cumple = &quot;Pendiente&quot;
            Criticidad = &quot;Media&quot;
        }
        
        # CIS 1.1.2 - Maximum password age
        $verificaciones += [PSCustomObject]@{
            ID = &quot;CIS-1.1.2&quot;
            Descripcion = &quot;Maximum password age: 365 or fewer days&quot;
            Categoria = &quot;Pol√É¬≠ticas de Contrase√É¬±a&quot;
            EstadoActual = &quot;$maxPasswordAge d√É¬≠as&quot;
            Recomendacion = &quot;365 d√É¬≠as o menos&quot;
            Cumple = if ($maxPasswordAge -le 365 -and $maxPasswordAge -gt 0) { &quot;S√É¬≠&quot; } else { &quot;No&quot; }
            Criticidad = &quot;Media&quot;
        }
        
        # CIS 1.1.3 - Minimum password age
        $verificaciones += [PSCustomObject]@{
            ID = &quot;CIS-1.1.3&quot;
            Descripcion = &quot;Minimum password age: 1 or more days&quot;
            Categoria = &quot;Pol√É¬≠ticas de Contrase√É¬±a&quot;
            EstadoActual = &quot;$minPasswordAge d√É¬≠as&quot;
            Recomendacion = &quot;1 d√É¬≠a o m√É¬°s&quot;
            Cumple = if ($minPasswordAge -ge 1) { &quot;S√É¬≠&quot; } else { &quot;No&quot; }
            Criticidad = &quot;Baja&quot;
        }
        
        # CIS 1.1.4 - Minimum password length
        $verificaciones += [PSCustomObject]@{
            ID = &quot;CIS-1.1.4&quot;
            Descripcion = &quot;Minimum password length: 14 or more characters&quot;
            Categoria = &quot;Pol√É¬≠ticas de Contrase√É¬±a&quot;
            EstadoActual = &quot;$minPasswordLength caracteres&quot;
            Recomendacion = &quot;14 caracteres o m√É¬°s&quot;
            Cumple = if ($minPasswordLength -ge 14) { &quot;S√É¬≠&quot; } else { &quot;No&quot; }
            Criticidad = &quot;Alta&quot;
        }
        
        # CIS 1.1.5 - Password complexity
        $verificaciones += [PSCustomObject]@{
            ID = &quot;CIS-1.1.5&quot;
            Descripcion = &quot;Password must meet complexity requirements&quot;
            Categoria = &quot;Pol√É¬≠ticas de Contrase√É¬±a&quot;
            EstadoActual = if ($passwordComplexity) { &quot;Habilitado&quot; } else { &quot;Deshabilitado&quot; }
            Recomendacion = &quot;Habilitado&quot;
            Cumple = if ($passwordComplexity) { &quot;S√É¬≠&quot; } else { &quot;No&quot; }
            Criticidad = &quot;Alta&quot;
        }
        
        # 2. VERIFICACIONES DE POL√É¬çTICAS DE BLOQUEO DE CUENTA
        Write-Host &quot;   Verificando pol√É¬≠ticas de bloqueo de cuenta...&quot; -ForegroundColor Yellow
        
        $lockoutThreshold = 0
        $lockoutDuration = 0
        
        if ($passwordPolicy) {
            foreach ($line in $passwordPolicy) {
                if ($line -match &quot;Lockout threshold:\s*(\d+)&quot;) {
                    $lockoutThreshold = [int]$matches[1]
                } elseif ($line -match &quot;Lockout duration $$minutes$$:\s*(\d+)&quot;) {
                    $lockoutDuration = [int]$matches[1]
                }
            }
        }
        
        # CIS 1.2.1 - Account lockout threshold
        $verificaciones += [PSCustomObject]@{
            ID = &quot;CIS-1.2.1&quot;
            Descripcion = &quot;Account lockout threshold: 5 or fewer invalid attempts&quot;
            Categoria = &quot;Pol√É¬≠ticas de Bloqueo&quot;
            EstadoActual = if ($lockoutThreshold -eq 0) { &quot;Sin bloqueo&quot; } else { &quot;$lockoutThreshold intentos&quot; }
            Recomendacion = &quot;5 intentos o menos&quot;
            Cumple = if ($lockoutThreshold -gt 0 -and $lockoutThreshold -le 5) { &quot;S√É¬≠&quot; } else { &quot;No&quot; }
            Criticidad = &quot;Media&quot;
        }
        
        # CIS 1.2.2 - Account lockout duration
        $verificaciones += [PSCustomObject]@{
            ID = &quot;CIS-1.2.2&quot;
            Descripcion = &quot;Account lockout duration: 15 or more minutes&quot;
            Categoria = &quot;Pol√É¬≠ticas de Bloqueo&quot;
            EstadoActual = &quot;$lockoutDuration minutos&quot;
            Recomendacion = &quot;15 minutos o m√É¬°s&quot;
            Cumple = if ($lockoutDuration -ge 15) { &quot;S√É¬≠&quot; } else { &quot;No&quot; }
            Criticidad = &quot;Media&quot;
        }
        
        # 3. VERIFICACIONES DE SERVICIOS Y CARACTER√É¬çSTICAS
        Write-Host &quot;   Verificando servicios y caracter√É¬≠sticas de seguridad...&quot; -ForegroundColor Yellow
        
        # Windows Defender
        $defenderStatus = Get-MpComputerStatus -ErrorAction SilentlyContinue
        $verificaciones += [PSCustomObject]@{
            ID = &quot;CIS-18.9.39.1&quot;
            Descripcion = &quot;Windows Defender Antivirus: Real-time protection enabled&quot;
            Categoria = &quot;Antivirus&quot;
            EstadoActual = if ($defenderStatus -and $defenderStatus.RealTimeProtectionEnabled) { &quot;Habilitado&quot; } else { &quot;Deshabilitado&quot; }
            Recomendacion = &quot;Habilitado&quot;
            Cumple = if ($defenderStatus -and $defenderStatus.RealTimeProtectionEnabled) { &quot;S√É¬≠&quot; } else { &quot;No&quot; }
            Criticidad = &quot;Alta&quot;
        }
        
        # Windows Firewall
        $firewallProfiles = Get-NetFirewallProfile -ErrorAction SilentlyContinue
        foreach ($profile in $firewallProfiles) {
            $verificaciones += [PSCustomObject]@{
                ID = &quot;CIS-9.1.$($profile.Name)&quot;
                Descripcion = &quot;Windows Firewall: $($profile.Name) profile enabled&quot;
                Categoria = &quot;Firewall&quot;
                EstadoActual = if ($profile.Enabled) { &quot;Habilitado&quot; } else { &quot;Deshabilitado&quot; }
                Recomendacion = &quot;Habilitado&quot;
                Cumple = if ($profile.Enabled) { &quot;S√É¬≠&quot; } else { &quot;No&quot; }
                Criticidad = &quot;Alta&quot;
            }
        }
        
        # UAC
        $uacSettings = Get-ItemProperty &quot;HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System&quot; -ErrorAction SilentlyContinue
        $uacEnabled = $uacSettings.EnableLUA -eq 1
        
        $verificaciones += [PSCustomObject]@{
            ID = &quot;CIS-2.3.17.1&quot;
            Descripcion = &quot;User Account Control: Admin Approval Mode for Built-in Administrator&quot;
            Categoria = &quot;Control de Acceso&quot;
            EstadoActual = if ($uacEnabled) { &quot;Habilitado&quot; } else { &quot;Deshabilitado&quot; }
            Recomendacion = &quot;Habilitado&quot;
            Cumple = if ($uacEnabled) { &quot;S√É¬≠&quot; } else { &quot;No&quot; }
            Criticidad = &quot;Alta&quot;
        }
        
        # 4. VERIFICACIONES DE AUDITOR√É¬çA
        Write-Host &quot;   Verificando configuraci√É¬≥n de auditor√É¬≠a...&quot; -ForegroundColor Yellow
        
        $auditCategories = @(
            @{ Name = &quot;Logon/Logoff&quot;; ID = &quot;CIS-17.1&quot; },
            @{ Name = &quot;Account Management&quot;; ID = &quot;CIS-17.2&quot; },
            @{ Name = &quot;Privilege Use&quot;; ID = &quot;CIS-17.3&quot; },
            @{ Name = &quot;System&quot;; ID = &quot;CIS-17.4&quot; }
        )
        
        try {
            $auditPol = auditpol /get /category:* 2&gt;$null
            foreach ($category in $auditCategories) {
                $auditEnabled = $false
                if ($auditPol) {
                    $categorySection = $auditPol | Select-String -Pattern $category.Name -Context 0,10
                    if ($categorySection -and $categorySection.ToString() -match &quot;(Success and Failure|Success|Failure)&quot;) {
                        $auditEnabled = $true
                    }
                }
                
                $verificaciones += [PSCustomObject]@{
                    ID = $category.ID
                    Descripcion = &quot;Audit $($category.Name) events&quot;
                    Categoria = &quot;Auditor√É¬≠a&quot;
                    EstadoActual = if ($auditEnabled) { &quot;Configurado&quot; } else { &quot;No configurado&quot; }
                    Recomendacion = &quot;Success and Failure&quot;
                    Cumple = if ($auditEnabled) { &quot;S√É¬≠&quot; } else { &quot;No&quot; }
                    Criticidad = &quot;Media&quot;
                }
            }
        } catch {
            Write-Host &quot;   Error al verificar auditor√É¬≠a: $_&quot; -ForegroundColor Red
        }
        
        # 5. VERIFICACIONES DE REGISTRO
        Write-Host &quot;   Verificando configuraciones del registro...&quot; -ForegroundColor Yellow
        
        # SMB v1
        $smbv1Enabled = $false
        try {
            $smbv1Feature = Get-WindowsOptionalFeature -Online -FeatureName &quot;SMB1Protocol&quot; -ErrorAction SilentlyContinue
            $smbv1Enabled = $smbv1Feature -and $smbv1Feature.State -eq &quot;Enabled&quot;
        } catch {
            # M√É¬©todo alternativo para versiones m√É¬°s antiguas
            $smbv1Reg = Get-ItemProperty &quot;HKLM:\SYSTEM\CurrentControlSet\Services\mrxsmb10&quot; -Name &quot;Start&quot; -ErrorAction SilentlyContinue
            $smbv1Enabled = $smbv1Reg -and $smbv1Reg.Start -ne 4
        }
        
        $verificaciones += [PSCustomObject]@{
            ID = &quot;CIS-18.3.1&quot;
            Descripcion = &quot;SMB v1 protocol disabled&quot;
            Categoria = &quot;Protocolos de Red&quot;
            EstadoActual = if ($smbv1Enabled) { &quot;Habilitado&quot; } else { &quot;Deshabilitado&quot; }
            Recomendacion = &quot;Deshabilitado&quot;
            Cumple = if (-not $smbv1Enabled) { &quot;S√É¬≠&quot; } else { &quot;No&quot; }
            Criticidad = &quot;Alta&quot;
        }
        
        # Remote Desktop
        $rdpEnabled = $false
        try {
            $rdpSetting = Get-ItemProperty &quot;HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server&quot; -Name &quot;fDenyTSConnections&quot; -ErrorAction SilentlyContinue
            $rdpEnabled = $rdpSetting -and $rdpSetting.fDenyTSConnections -eq 0
        } catch {}
        
        $verificaciones += [PSCustomObject]@{
            ID = &quot;CIS-18.9.48.3.1&quot;
            Descripcion = &quot;Remote Desktop connections security&quot;
            Categoria = &quot;Acceso Remoto&quot;
            EstadoActual = if ($rdpEnabled) { &quot;Habilitado&quot; } else { &quot;Deshabilitado&quot; }
            Recomendacion = &quot;Configurado seg√É¬∫n necesidad&quot;
            Cumple = &quot;Revisar&quot;
            Criticidad = &quot;Media&quot;
        }
        
        # 6. RESUMEN DE CUMPLIMIENTO
        $totalVerificaciones = $verificaciones.Count
        $cumpleCompleto = ($verificaciones | Where-Object { $_.Cumple -eq &quot;S√É¬≠&quot; }).Count
        $noCumple = ($verificaciones | Where-Object { $_.Cumple -eq &quot;No&quot; }).Count
        $pendienteRevision = ($verificaciones | Where-Object { $_.Cumple -in @(&quot;Pendiente&quot;, &quot;Revisar&quot;) }).Count
        
        $porcentajeCumplimiento = if ($totalVerificaciones -gt 0) {
            [math]::Round(($cumpleCompleto / $totalVerificaciones) * 100, 1)
        } else { 0 }
        
        $resumenCumplimiento = @{
            TotalVerificaciones = $totalVerificaciones
            Cumple = $cumpleCompleto
            NoCumple = $noCumple
            PendienteRevision = $pendienteRevision
            PorcentajeCumplimiento = $porcentajeCumplimiento
            NivelCumplimiento = switch ($porcentajeCumplimiento) {
                { $_ -ge 90 } { &quot;Excelente&quot; }
                { $_ -ge 80 } { &quot;Bueno&quot; }
                { $_ -ge 70 } { &quot;Aceptable&quot; }
                { $_ -ge 60 } { &quot;Mejorable&quot; }
                default { &quot;Deficiente&quot; }
            }
        }
        
        return @{
            Verificaciones = $verificaciones
            ResumenCumplimiento = $resumenCumplimiento
        }
        
    } catch {
        Write-Warning &quot;Error en verificaci√É¬≥n de cumplimiento: $_&quot;
        return @{ Error = $_.Exception.Message }
    }
}

# NUEVA FUNCI√É‚ÄúN: An√É¬°lisis de Permisos de Carpetas Sensibles
function Get-AnalisisPermisos {
    try {
        Write-Progress -Activity &quot;Analizando permisos de carpetas sensibles&quot; -PercentComplete 70
        Write-Host &quot;   Analizando permisos de carpetas sensibles...&quot; -ForegroundColor Yellow
        
        $analisisPermisos = @()
        
        # Definir carpetas sensibles del sistema
        $carpetasSensibles = @(
            @{ Ruta = &quot;C:\Windows\System32&quot;; Descripcion = &quot;Archivos del sistema Windows&quot; },
            @{ Ruta = &quot;C:\Windows\SysWOW64&quot;; Descripcion = &quot;Archivos del sistema Windows (32-bit)&quot; },
            @{ Ruta = &quot;C:\Program Files&quot;; Descripcion = &quot;Programas instalados&quot; },
            @{ Ruta = &quot;C:\Program Files (x86)&quot;; Descripcion = &quot;Programas instalados (32-bit)&quot; },
            @{ Ruta = &quot;C:\Windows\Temp&quot;; Descripcion = &quot;Archivos temporales del sistema&quot; },
            @{ Ruta = &quot;C:\ProgramData&quot;; Descripcion = &quot;Datos de aplicaciones&quot; },
            @{ Ruta = &quot;C:\Users\Public&quot;; Descripcion = &quot;Carpeta p√É¬∫blica de usuarios&quot; },
            @{ Ruta = &quot;C:\inetpub&quot;; Descripcion = &quot;Sitios web IIS&quot; }
        )
        
        # Agregar carpetas compartidas
        try {
            $carpetasCompartidas = Get-SmbShare -ErrorAction SilentlyContinue | Where-Object { $_.Name -ne &quot;IPC$&quot; -and $_.Name -ne &quot;ADMIN$&quot; -and $_.Name -notlike &quot;*$&quot; }
            foreach ($share in $carpetasCompartidas) {
                $carpetasSensibles += @{ Ruta = $share.Path; Descripcion = &quot;Carpeta compartida: $($share.Name)&quot; }
            }
        } catch {
            Write-Host &quot;   No se pudieron obtener carpetas compartidas&quot; -ForegroundColor Yellow
        }
        
        foreach ($carpeta in $carpetasSensibles) {
            try {
                if (Test-Path $carpeta.Ruta) {
                    Write-Host &quot;   Analizando: $($carpeta.Ruta)&quot; -ForegroundColor Yellow
                    
                    # Obtener ACL de la carpeta
                    $acl = Get-Acl $carpeta.Ruta -ErrorAction SilentlyContinue
                    
                    if ($acl) {
                        $permisosProblematicos = @()
                        $permisosNormales = @()
                        
                        foreach ($access in $acl.Access) {
                            $usuario = $access.IdentityReference.Value
                            $permisos = $access.FileSystemRights.ToString()
                            $tipo = $access.AccessControlType.ToString()
                            $herencia = $access.IsInherited
                            
                            # Identificar permisos problem√É¬°ticos
                            $esProblematico = $false
                            $razon = &quot;&quot;
                            
                            # Verificar si Everyone o Users tienen permisos excesivos
                            if ($usuario -match &quot;(Everyone|Users|Authenticated Users)&quot; -and $tipo -eq &quot;Allow&quot;) {
                                if ($permisos -match &quot;(FullControl|Modify|Write)&quot; -and $carpeta.Ruta -match &quot;(System32|Program Files|Windows)&quot;) {
                                    $esProblematico = $true
                                    $razon = &quot;Permisos excesivos para grupo amplio en carpeta del sistema&quot;
                                }
                            }
                            
                            # Verificar permisos de escritura en carpetas del sistema
                            if ($permisos -match &quot;(Write|Modify|FullControl)&quot; -and $tipo -eq &quot;Allow&quot; -and $carpeta.Ruta -match &quot;(System32|SysWOW64)&quot;) {
                                if ($usuario -notmatch &quot;(SYSTEM|Administrators|TrustedInstaller)&quot;) {
                                    $esProblematico = $true
                                    $razon = &quot;Permisos de escritura en carpeta cr√É¬≠tica del sistema&quot;
                                }
                            }
                            
                            # Verificar permisos en carpetas temporales
                            if ($carpeta.Ruta -match &quot;Temp&quot; -and $permisos -match &quot;FullControl&quot; -and $usuario -match &quot;Everyone&quot;) {
                                $esProblematico = $true
                                $razon = &quot;Control total para Everyone en carpeta temporal&quot;
                            }
                            
                            $permisoObj = [PSCustomObject]@{
                                Usuario = $usuario
                                Permisos = $permisos
                                Tipo = $tipo
                                Heredado = $herencia
                                Problematico = $esProblematico
                                Razon = $razon
                            }
                            
                            if ($esProblematico) {
                                $permisosProblematicos += $permisoObj
                            } else {
                                $permisosNormales += $permisoObj
                            }
                        }
                        
                        $analisisPermisos += [PSCustomObject]@{
                            Ruta = $carpeta.Ruta
                            Descripcion = $carpeta.Descripcion
                            Propietario = $acl.Owner
                            PermisosProblematicos = $permisosProblematicos
                            PermisosNormales = $permisosNormales
                            TotalPermisos = $acl.Access.Count
                            PermisosProblematicosCount = $permisosProblematicos.Count
                            Estado = if ($permisosProblematicos.Count -eq 0) { &quot;Normal&quot; } 
                                    elseif ($permisosProblematicos.Count -le 2) { &quot;Advertencia&quot; } 
                                    else { &quot;Cr√É¬≠tico&quot; }
                        }
                    }
                } else {
                    Write-Host &quot;   Carpeta no existe: $($carpeta.Ruta)&quot; -ForegroundColor Gray
                }
            } catch {
                Write-Host &quot;   Error al analizar $($carpeta.Ruta): $_&quot; -ForegroundColor Red
                $analisisPermisos += [PSCustomObject]@{
                    Ruta = $carpeta.Ruta
                    Descripcion = $carpeta.Descripcion
                    Error = $_.Exception.Message
                    Estado = &quot;Error&quot;
                }
            }
        }
        
        # Resumen del an√É¬°lisis de permisos
        $totalCarpetas = $analisisPermisos.Count
        $carpetasConProblemas = ($analisisPermisos | Where-Object { $_.Estado -in @(&quot;Advertencia&quot;, &quot;Cr√É¬≠tico&quot;) }).Count
        $carpetasCriticas = ($analisisPermisos | Where-Object { $_.Estado -eq &quot;Cr√É¬≠tico&quot; }).Count
        
        $resumenPermisos = @{
            TotalCarpetasAnalizadas = $totalCarpetas
            CarpetasConProblemas = $carpetasConProblemas
            CarpetasCriticas = $carpetasCriticas
            CarpetasNormales = $totalCarpetas - $carpetasConProblemas
            PorcentajeSeguras = if ($totalCarpetas -gt 0) { 
                [math]::Round((($totalCarpetas - $carpetasConProblemas) / $totalCarpetas) * 100, 1) 
            } else { 0 }
            NivelSeguridad = switch ($carpetasCriticas) {
                0 { if ($carpetasConProblemas -eq 0) { &quot;Excelente&quot; } else { &quot;Bueno&quot; } }
                { $_ -le 2 } { &quot;Aceptable&quot; }
                default { &quot;Deficiente&quot; }
            }
        }
        
        return @{
            AnalisisPermisos = $analisisPermisos
            ResumenPermisos = $resumenPermisos
        }
        
    } catch {
        Write-Warning &quot;Error en an√É¬°lisis de permisos: $_&quot;
        return @{ Error = $_.Exception.Message }
    }
}

# NUEVA FUNCI√É‚ÄúN: Auditor√É¬≠a de Software Instalado
function Get-AuditoriaSoftware {
    try {
        Write-Progress -Activity &quot;Realizando auditor√É¬≠a de software instalado&quot; -PercentComplete 75
        Write-Host &quot;   Auditando software instalado...&quot; -ForegroundColor Yellow
        
        $softwareInstalado = @()
        $softwareProblematico = @()
        
        # 1. OBTENER SOFTWARE INSTALADO DESDE EL REGISTRO
        Write-Host &quot;   Obteniendo lista de software instalado...&quot; -ForegroundColor Yellow
        
        $registryPaths = @(
            &quot;HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\*&quot;,
            &quot;HKLM:\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall\*&quot;
        )
        
        foreach ($path in $registryPaths) {
            try {
                $installedSoftware = Get-ItemProperty $path -ErrorAction SilentlyContinue | 
                                   Where-Object { $_.DisplayName -and $_.DisplayName -notmatch &quot;^(KB|Update for)&quot; }
                
                foreach ($software in $installedSoftware) {
                    $nombre = $software.DisplayName
                    $version = $software.DisplayVersion
                    $fabricante = $software.Publisher
                    $fechaInstalacion = $software.InstallDate
                    $tama√É¬±o = $software.EstimatedSize
                    
                    # Convertir fecha de instalaci√É¬≥n
                    $fechaInstalacionFormateada = &quot;No disponible&quot;
                    if ($fechaInstalacion -and $fechaInstalacion -match &quot;^\d{8}$&quot;) {
                        try {
                            $fechaInstalacionFormateada = [DateTime]::ParseExact($fechaInstalacion, &quot;yyyyMMdd&quot;, $null).ToString(&quot;dd/MM/yyyy&quot;)
                        } catch {}
                    }
                    
                    # Convertir tama√É¬±o
                    $tama√É¬±oMB = if ($tama√É¬±o) { [math]::Round($tama√É¬±o / 1024, 2) } else { 0 }
                    
                    $softwareInstalado += [PSCustomObject]@{
                        Nombre = $nombre
                        Version = $version
                        Fabricante = $fabricante
                        FechaInstalacion = $fechaInstalacionFormateada
                        Tama√É¬±oMB = $tama√É¬±oMB
                        RegistryPath = $software.PSPath
                    }
                }
            } catch {
                Write-Host &quot;   Error al leer registro: $_&quot; -ForegroundColor Red
            }
        }
        
        # Eliminar duplicados
        $softwareInstalado = $softwareInstalado | Sort-Object Nombre, Version | Get-Unique -AsString
        
        Write-Host &quot;   Se encontraron $($softwareInstalado.Count) programas instalados&quot; -ForegroundColor Yellow
        
        # 2. IDENTIFICAR SOFTWARE PROBLEM√É¬ÅTICO
        Write-Host &quot;   Identificando software problem√É¬°tico...&quot; -ForegroundColor Yellow
        
        # Lista de software conocido como problem√É¬°tico o desactualizado
        $softwareProblemas = @(
            @{ Nombre = &quot;Adobe Flash Player&quot;; Razon = &quot;Software descontinuado y vulnerable&quot;; Criticidad = &quot;Alta&quot; },
            @{ Nombre = &quot;Java&quot;; VersionMinima = &quot;8.0.300&quot;; Razon = &quot;Versiones antiguas de Java son vulnerables&quot;; Criticidad = &quot;Alta&quot; },
            @{ Nombre = &quot;Adobe Reader&quot;; VersionMinima = &quot;2021.0&quot;; Razon = &quot;Versiones antiguas tienen vulnerabilidades&quot;; Criticidad = &quot;Media&quot; },
            @{ Nombre = &quot;VLC media player&quot;; VersionMinima = &quot;3.0.16&quot;; Razon = &quot;Versiones antiguas pueden tener vulnerabilidades&quot;; Criticidad = &quot;Baja&quot; },
            @{ Nombre = &quot;WinRAR&quot;; VersionMinima = &quot;6.0&quot;; Razon = &quot;Versiones antiguas tienen vulnerabilidades conocidas&quot;; Criticidad = &quot;Media&quot; },
            @{ Nombre = &quot;7-Zip&quot;; VersionMinima = &quot;21.0&quot;; Razon = &quot;Versiones antiguas pueden ser vulnerables&quot;; Criticidad = &quot;Baja&quot; },
            @{ Nombre = &quot;Google Chrome&quot;; Razon = &quot;Verificar que est√É¬© actualizado&quot;; Criticidad = &quot;Media&quot; },
            @{ Nombre = &quot;Mozilla Firefox&quot;; Razon = &quot;Verificar que est√É¬© actualizado&quot;; Criticidad = &quot;Media&quot; },
            @{ Nombre = &quot;Internet Explorer&quot;; Razon = &quot;Navegador descontinuado&quot;; Criticidad = &quot;Alta&quot; }
        )
        
        # Software sin soporte conocido
        $softwareSinSoporte = @(
            &quot;Windows XP&quot;, &quot;Windows Vista&quot;, &quot;Windows 7&quot;, &quot;Office 2010&quot;, &quot;Office 2013&quot;, 
            &quot;Adobe Flash&quot;, &quot;Internet Explorer&quot;, &quot;Silverlight&quot;
        )
        
        foreach ($software in $softwareInstalado) {
            $problemas = @()
            
            # Verificar si est√É¬° en la lista de software problem√É¬°tico
            foreach ($problema in $softwareProblemas) {
                if ($software.Nombre -like &quot;*$($problema.Nombre)*&quot;) {
                    if ($problema.VersionMinima) {
                        # Comparar versiones (simplificado)
                        $versionActual = $software.Version
                        if ($versionActual) {
                            try {
                                $versionActualNum = [Version]$versionActual.Split(&#x27; &#x27;)[0]
                                $versionMinimaNum = [Version]$problema.VersionMinima
                                
                                if ($versionActualNum -lt $versionMinimaNum) {
                                    $problemas += @{
                                        Tipo = &quot;Versi√É¬≥n desactualizada&quot;
                                        Descripcion = $problema.Razon
                                        Criticidad = $problema.Criticidad
                                        Recomendacion = &quot;Actualizar a versi√É¬≥n $($problema.VersionMinima) o superior&quot;
                                    }
                                }
                            } catch {
                                $problemas += @{
                                    Tipo = &quot;Verificaci√É¬≥n de versi√É¬≥n&quot;
                                    Descripcion = &quot;No se pudo verificar la versi√É¬≥n autom√É¬°ticamente&quot;
                                    Criticidad = &quot;Baja&quot;
                                    Recomendacion = &quot;Verificar manualmente la versi√É¬≥n&quot;
                                }
                            }
                        }
                    } else {
                        $problemas += @{
                            Tipo = &quot;Software problem√É¬°tico&quot;
                            Descripcion = $problema.Razon
                            Criticidad = $problema.Criticidad
                            Recomendacion = &quot;Considerar desinstalar o reemplazar&quot;
                        }
                    }
                }
            }
            
            # Verificar software sin soporte
            foreach ($sinSoporte in $softwareSinSoporte) {
                if ($software.Nombre -like &quot;*$sinSoporte*&quot;) {
                    $problemas += @{
                        Tipo = &quot;Sin soporte&quot;
                        Descripcion = &quot;Software sin soporte del fabricante&quot;
                        Criticidad = &quot;Alta&quot;
                        Recomendacion = &quot;Migrar a versi√É¬≥n soportada&quot;
                    }
                }
            }
            
            # Verificar software muy antiguo (m√É¬°s de 5 a√É¬±os)
            if ($software.FechaInstalacion -ne &quot;No disponible&quot;) {
                try {
                    $fechaInstalacion = [DateTime]::ParseExact($software.FechaInstalacion, &quot;dd/MM/yyyy&quot;, $null)
                    $a√É¬±osAntiguedad = ((Get-Date) - $fechaInstalacion).Days / 365
                    
                    if ($a√É¬±osAntiguedad -gt 5) {
                        $problemas += @{
                            Tipo = &quot;Software muy antiguo&quot;
                            Descripcion = &quot;Instalado hace m√É¬°s de 5 a√É¬±os&quot;
                            Criticidad = &quot;Baja&quot;
                            Recomendacion = &quot;Verificar si hay actualizaciones disponibles&quot;
                        }
                    }
                } catch {}
            }
            
            # Verificar software sin fabricante conocido
            if (-not $software.Fabricante -or $software.Fabricante -eq &quot;&quot;) {
                $problemas += @{
                    Tipo = &quot;Fabricante desconocido&quot;
                    Descripcion = &quot;Software sin informaci√É¬≥n del fabricante&quot;
                    Criticidad = &quot;Media&quot;
                    Recomendacion = &quot;Verificar la legitimidad del software&quot;
                }
            }
            
            if ($problemas.Count -gt 0) {
                $softwareProblematico += [PSCustomObject]@{
                    Nombre = $software.Nombre
                    Version = $software.Version
                    Fabricante = $software.Fabricante
                    FechaInstalacion = $software.FechaInstalacion
                    Problemas = $problemas
                    CriticidadMaxima = ($problemas | ForEach-Object { $_.Criticidad } | Sort-Object { 
                        switch ($_) { &quot;Alta&quot; { 3 } &quot;Media&quot; { 2 } &quot;Baja&quot; { 1 } default { 0 } } 
                    } -Descending)[0]
                }
            }
        }
        
        # 3. AN√É¬ÅLISIS DE NAVEGADORES Y PLUGINS
        Write-Host &quot;   Analizando navegadores y plugins...&quot; -ForegroundColor Yellow
        
        $navegadores = $softwareInstalado | Where-Object { 
            $_.Nombre -match &quot;(Chrome|Firefox|Edge|Internet Explorer|Opera|Safari)&quot; 
        }
        
        # 4. RESUMEN DE AUDITOR√É¬çA
        $totalSoftware = $softwareInstalado.Count
        $softwareConProblemas = $softwareProblematico.Count
        $softwareCritico = ($softwareProblematico | Where-Object { $_.CriticidadMaxima -eq &quot;Alta&quot; }).Count
        $softwareMedia = ($softwareProblematico | Where-Object { $_.CriticidadMaxima -eq &quot;Media&quot; }).Count
        $softwareBaja = ($softwareProblematico | Where-Object { $_.CriticidadMaxima -eq &quot;Baja&quot; }).Count
        
        $resumenAuditoria = @{
            TotalSoftwareInstalado = $totalSoftware
            SoftwareConProblemas = $softwareConProblemas
            SoftwareCritico = $softwareCritico
            SoftwareRiesgoMedio = $softwareMedia
            SoftwareRiesgoBajo = $softwareBaja
            SoftwareSeguro = $totalSoftware - $softwareConProblemas
            PorcentajeSeguro = if ($totalSoftware -gt 0) { 
                [math]::Round((($totalSoftware - $softwareConProblemas) / $totalSoftware) * 100, 1) 
            } else { 0 }
            NivelRiesgo = switch ($softwareCritico) {
                0 { if ($softwareMedia -eq 0) { &quot;Bajo&quot; } else { &quot;Medio&quot; } }
                { $_ -le 2 } { &quot;Medio&quot; }
                default { &quot;Alto&quot; }
            }
        }
        
        return @{
            SoftwareInstalado = $softwareInstalado
            SoftwareProblematico = $softwareProblematico
            Navegadores = $navegadores
            ResumenAuditoria = $resumenAuditoria
        }
        
    } catch {
        Write-Warning &quot;Error en auditor√É¬≠a de software: $_&quot;
        return @{ Error = $_.Exception.Message }
    }
}

function Get-DatosExtendidos {
    param(
        [bool]$ParchesFaltantes = $false,
        [bool]$RevisarServicioTerceros = $false
    )
    
    try {
        Write-Progress -Activity &quot;Recopilando datos extendidos completos&quot; -PercentComplete 40
        
        $datos = @{}
        
        # 1. PARCHES - √É≈°ltimos instalados + Faltantes (si se solicita)
        Write-Host &quot;   Analizando parches del sistema...&quot; -ForegroundColor Yellow
        $datos.UltimosParches = Get-HotFix | Sort-Object InstalledOn -Descending | 
                               Select-Object -First 15 HotFixID, Description, InstalledOn, InstalledBy
        
        if ($ParchesFaltantes) {
            try {
                Write-Host &quot;   Verificando parches faltantes...&quot; -ForegroundColor Yellow
                $updateSession = New-Object -ComObject Microsoft.Update.Session
                $updateSearcher = $updateSession.CreateUpdateSearcher()
                $searchResult = $updateSearcher.Search(&quot;IsInstalled=0 and Type=&#x27;Software&#x27;&quot;)
                
                $datos.ParchesFaltantes = @()
                for ($i = 0; $i -lt $searchResult.Updates.Count; $i++) {
                    $update = $searchResult.Updates.Item($i)
                    $datos.ParchesFaltantes += @{
                        Titulo = $update.Title
                        Descripcion = $update.Description.Substring(0,[Math]::Min(200,$update.Description.Length))
                        Tama√É¬±o = [math]::Round($update.MaxDownloadSize / 1MB, 2)
                    }
                }
            } catch {
                $datos.ParchesFaltantes = @{ Error = &quot;No se pudo verificar parches faltantes: $_&quot; }
            }
        }
        
        # 2. SERVICIOS - Autom√É¬°ticos detenidos + Terceros (si se solicita)
        Write-Host &quot;   Analizando servicios...&quot; -ForegroundColor Yellow
        $serviciosDetenidos = Get-Service | Where-Object { $_.StartType -eq &quot;Automatic&quot; -and $_.Status -ne &quot;Running&quot; }
        
        if ($RevisarServicioTerceros) {
            # Lista de servicios Microsoft conocidos (como respaldo)
            $serviciosMicrosoft = @(&#x27;Spooler&#x27;, &#x27;BITS&#x27;, &#x27;Themes&#x27;, &#x27;AudioSrv&#x27;, &#x27;Dnscache&#x27;, &#x27;eventlog&#x27;, &#x27;PlugPlay&#x27;, 
                                    &#x27;RpcSs&#x27;, &#x27;lanmanserver&#x27;, &#x27;W32Time&#x27;, &#x27;Winmgmt&#x27;, &#x27;Schedule&#x27;, &#x27;LanmanWorkstation&#x27;,
                                    &#x27;DHCP&#x27;, &#x27;Netlogon&#x27;, &#x27;PolicyAgent&#x27;, &#x27;TermService&#x27;, &#x27;UmRdpService&#x27;, &#x27;SessionEnv&#x27;,
                                    &#x27;RemoteRegistry&#x27;)
            
            # Usar an√É¬°lisis de fabricante del ejecutable para clasificaci√É¬≥n m√É¬°s precisa
            $datos.ServiciosDetenidos = foreach ($servicio in $serviciosDetenidos) {
                # Obtener detalles del servicio mediante CIM
                $servicioCIM = Get-CimInstance Win32_Service -Filter &quot;Name=&#x27;$($servicio.Name)&#x27;&quot; -ErrorAction SilentlyContinue
                $compania = &quot;Desconocido&quot;
                $esMicrosoft = $false
                
                # Intentar determinar la compa√É¬±√É¬≠a por el ejecutable del servicio
                if ($servicioCIM -and $servicioCIM.PathName) {
                    if ($servicioCIM.PathName -match &#x27;&quot;([^&quot;]+)&quot;&#x27; -or $servicioCIM.PathName -match &#x27;([^\s]+\.exe)&#x27;) {
                        $exePath = $matches[1]
                        
                        if (Test-Path $exePath -ErrorAction SilentlyContinue) {
                            $fileInfo = (Get-Item $exePath -ErrorAction SilentlyContinue).VersionInfo
                            if ($fileInfo.CompanyName) {
                                $compania = $fileInfo.CompanyName
                                $esMicrosoft = $compania -like &quot;*Microsoft*&quot;
                            }
                        }
                    }
                }
                
                # Si no se pudo determinar, usar la lista de servicios conocidos
                if ($compania -eq &quot;Desconocido&quot;) {
                    $esMicrosoft = $serviciosMicrosoft -contains $servicio.Name
                }
                
                [PSCustomObject]@{
                    DisplayName = $servicio.DisplayName
                    Name = $servicio.Name
                    Status = $servicio.Status
                    StartType = $servicio.StartType
                    Compania = $compania
                    EsMicrosoft = $esMicrosoft
                    Tipo = if ($esMicrosoft) { &quot;Microsoft&quot; } else { &quot;Tercero&quot; }
                }
            }
        } else {
            $datos.ServiciosDetenidos = $serviciosDetenidos | Select-Object DisplayName, Name, Status, StartType
        }
        
        # 3. TOP 5 PROCESOS por CPU y Memoria (ORIGINAL)
        Write-Host &quot;   Analizando procesos con alto consumo...&quot; -ForegroundColor Yellow
        $datos.ProcesosCPU = Get-Process | Where-Object { $_.CPU -gt 0 } | 
                            Sort-Object CPU -Descending | Select-Object -First 5 |
                            Select-Object Name, @{Name=&quot;CPU&quot;;Expression={[math]::Round($_.CPU,2)}}, Id, 
                                        @{Name=&quot;Memoria_MB&quot;;Expression={[math]::Round($_.WS/1MB,2)}}
        
        $datos.ProcesosMemoria = Get-Process | Sort-Object WS -Descending | Select-Object -First 5 |
                                Select-Object Name, @{Name=&quot;Memoria_MB&quot;;Expression={[math]::Round($_.WS/1MB,2)}}, 
                                            Id, @{Name=&quot;CPU&quot;;Expression={[math]::Round($_.CPU,2)}}
        
        # 4. PUERTOS ABIERTOS (ORIGINAL)
        Write-Host &quot;   Analizando puertos de red...&quot; -ForegroundColor Yellow
        $datos.PuertosAbiertos = Get-NetTCPConnection | Where-Object { $_.State -eq &quot;Listen&quot; } |
                                Select-Object LocalAddress, LocalPort, State, OwningProcess |
                                Sort-Object LocalPort
        
        # 5. CONEXIONES ACTIVAS (ORIGINAL)
        $datos.ConexionesActivas = Get-NetTCPConnection | Where-Object { $_.State -eq &quot;Established&quot; } |
                                  Group-Object RemoteAddress | Select-Object Count, Name |
                                  Sort-Object Count -Descending | Select-Object -First 10
        
        # 6. USUARIOS LOCALES (ORIGINAL)
        Write-Host &quot;   Analizando usuarios locales...&quot; -ForegroundColor Yellow
        $datos.UsuariosLocales = Get-LocalUser | Select-Object Name, Enabled, 
                                @{Name=&quot;UltimoLogon&quot;;Expression={
                                    if($_.LastLogon -eq $null){&quot;Nunca&quot;}else{$_.LastLogon.ToString(&quot;dd/MM/yyyy HH:mm&quot;)}
                                }},
                                @{Name=&quot;PasswordExpires&quot;;Expression={
                                    if($_.PasswordExpires -eq $null){&quot;Nunca&quot;}else{$_.PasswordExpires.ToString(&quot;dd/MM/yyyy&quot;)}
                                }}
        
        # 7. LOGINS FALLIDOS RECIENTES - TOP 5 (ORIGINAL)
        Write-Host &quot;   Analizando intentos de login fallidos...&quot; -ForegroundColor Yellow
        $datos.LoginsFallidos = Get-WinEvent -LogName &quot;Security&quot; -FilterXPath &quot;*[System[EventID=4625]]&quot; -MaxEvents 5 -ErrorAction SilentlyContinue | 
                               Select-Object TimeCreated, 
                                           @{Name=&quot;Cuenta&quot;;Expression={$_.Properties[5].Value}}, 
                                           @{Name=&quot;IPOrigen&quot;;Expression={$_.Properties[19].Value}},
                                           @{Name=&quot;TipoFallo&quot;;Expression={$_.Properties[10].Value}}
        
        # 8. TAREAS PROGRAMADAS (ORIGINAL)
        Write-Host &quot;   Analizando tareas programadas...&quot; -ForegroundColor Yellow
        $datos.TareasProgramadas = Get-ScheduledTask | Where-Object { $_.State -eq &quot;Ready&quot; } | 
                                  Get-ScheduledTaskInfo | Select-Object -First 20 |
                                  Select-Object TaskName, LastRunTime, LastTaskResult,
                                              @{Name=&quot;Estado&quot;;Expression={
                                                  switch ($_.LastTaskResult) {
                                                      0 { &quot;Exitoso&quot; }
                                                      1 { &quot;Falso/Incorrecto&quot; }
                                                      2 { &quot;Acceso Denegado&quot; }
                                                      default { &quot;Error ($($_.LastTaskResult))&quot; }
                                                  }
                                              }}
        
        # 9. INFORMACI√É‚ÄúN SNMP COMPLETA (ORIGINAL)
        Write-Host &quot;   Verificando configuraci√É¬≥n SNMP...&quot; -ForegroundColor Yellow
        $datos.ServicioSNMP = Get-Service -Name &quot;SNMP&quot; -ErrorAction SilentlyContinue | 
                             Select-Object Name, Status, StartType
        
        $datos.ConfigSNMP = try {
            $snmpConfig = Get-ItemProperty -Path &quot;HKLM:\SYSTEM\CurrentControlSet\Services\SNMP\Parameters\ValidCommunities&quot; -ErrorAction SilentlyContinue
            if ($snmpConfig) {
                $snmpConfig.PSObject.Properties | Where-Object { $_.Name -notmatch &quot;^PS&quot; } | 
                Select-Object Name, Value
            } else {
                @{ Info = &quot;No hay comunidades SNMP configuradas&quot; }
            }
        } catch {
            @{ Error = &quot;No se pudo obtener configuraci√É¬≥n SNMP&quot; }
        }
        
        Write-Host &quot;   Analizando rendimiento de discos f√É¬≠sicos...&quot; -ForegroundColor Yellow
        $datos.RendimientoDisco = Get-Counter &quot;\PhysicalDisk(*)\Avg. Disk sec/Read&quot;, &quot;\PhysicalDisk(*)\Avg. Disk sec/Write&quot; -ErrorAction SilentlyContinue
        $datos.DiscosFisicos = Get-PhysicalDisk -ErrorAction SilentlyContinue | Select-Object FriendlyName, HealthStatus, OperationalStatus, @{Name=&quot;SizeGB&quot;;Expression={[math]::Round($_.Size / 1GB, 2)}}, MediaType, BusType
        
        Write-Host &quot;   Verificando configuraci√É¬≥n de seguridad...&quot; -ForegroundColor Yellow
        
        # Informaci√É¬≥n detallada Windows Defender
        try {
            $defenderStatus = Get-MpComputerStatus -ErrorAction SilentlyContinue
            if ($defenderStatus) {
                $datos.WindowsDefender = @{
                    Habilitado = $defenderStatus.AntivirusEnabled
                    TiempoRealActivo = $defenderStatus.RealTimeProtectionEnabled
                    ProteccionSpyware = $defenderStatus.AntispywareEnabled
                    ServicioActivo = $defenderStatus.AMServiceEnabled
                    UltimoAnalisisRapido = if ($defenderStatus.QuickScanEndTime) { $defenderStatus.QuickScanEndTime.ToString(&quot;dd/MM/yyyy HH:mm&quot;) } else { &quot;No disponible&quot; }
                    UltimoAnalisisCompleto = if ($defenderStatus.FullScanEndTime) { $defenderStatus.FullScanEndTime.ToString(&quot;dd/MM/yyyy HH:mm&quot;) } else { &quot;No disponible&quot; }
                    EdadDefinicionesAV = &quot;$($defenderStatus.AntivirusSignatureAge) d√É¬≠as&quot;
                    VersionEngine = $defenderStatus.AMEngineVersion
                    VersionSignature = $defenderStatus.AntispywareSignatureVersion
                    TamperProtection = if (Get-Member -InputObject $defenderStatus -Name &quot;IsTamperProtected&quot; -MemberType Properties) { 
                        $defenderStatus.IsTamperProtected 
                    } else { &quot;No disponible&quot; }
                    ProteccionBasadaNube = $defenderStatus.CloudBlockLevel
                    ProteccionRed = if (Get-Member -InputObject $defenderStatus -Name &quot;NISEnabled&quot; -MemberType Properties) {
                        $defenderStatus.NISEnabled
                    } else { &quot;No disponible&quot; }
                }
            } else {
                # Obtener informaci√É¬≥n de Defender mediante WMI si los cmdlets no est√É¬°n disponibles
                $wmiBuscador = Get-CimInstance -Namespace &quot;root\SecurityCenter2&quot; -ClassName AntivirusProduct -ErrorAction SilentlyContinue
                if ($wmiBuscador) {
                    $defenderWMI = $wmiBuscador | Where-Object { $_.displayName -like &quot;*Defender*&quot; }
                    
                    if ($defenderWMI) {
                        # Convertir el c√É¬≥digo de estado a valores legibles
                        $habilitado = [bool]($defenderWMI.productState -band 0x1000)
                        $actualizado = [bool]($defenderWMI.productState -band 0x10)
                        
                        $datos.WindowsDefender = @{
                            Habilitado = $habilitado
                            TiempoRealActivo = $habilitado  # Asumiendo que si est√É¬° habilitado, la protecci√É¬≥n en tiempo real tambi√É¬©n
                            DefinicionesActualizadas = $actualizado
                            FechaUltimaActualizacion = &quot;No disponible&quot;
                            UltimoAnalisisCompleto = &quot;No disponible&quot;
                        }
                    } else {
                        $datos.WindowsDefender = @{ Estado = &quot;No detectado&quot; }
                    }
                } else {
                    $datos.WindowsDefender = @{ Estado = &quot;No disponible&quot; }
                }
            }
        } catch {
            $datos.WindowsDefender = @{ Error = &quot;No se pudo obtener estado de Windows Defender: $_&quot; }
        }
        
        # Otros antivirus instalados
        try {
            $otrosAntivirus = @()
            $antivirusList = Get-CimInstance -Namespace &quot;root\SecurityCenter2&quot; -ClassName AntivirusProduct -ErrorAction SilentlyContinue
            
            if ($antivirusList) {
                foreach ($av in $antivirusList) {
                    if ($av.displayName -notlike &quot;*Defender*&quot;) {
                        # Determinar estado basado en el productState
                        $habilitado = [bool]($av.productState -band 0x1000)
                        $actualizado = [bool]($av.productState -band 0x10)
                        
                        $otrosAntivirus += @{
                            Nombre = $av.displayName
                            Habilitado = $habilitado
                            DefinicionesActualizadas = $actualizado
                            Fabricante = $av.companyName
                            Path = $av.pathToSignedProductExe
                        }
                    }
                }
            }
            
            $datos.OtrosAntivirus = $otrosAntivirus
        } catch {
            $datos.OtrosAntivirus = @{ Error = &quot;No se pudo obtener informaci√É¬≥n de otros antivirus: $_&quot; }
        }
        
        # Estado detallado del Firewall por perfil
        try {
            $firewallPerfiles = @()
            $perfilesFirewall = Get-NetFirewallProfile -ErrorAction SilentlyContinue
            
            if ($perfilesFirewall) {
                foreach ($perfil in $perfilesFirewall) {
                    $firewallPerfiles += @{
                        Nombre = $perfil.Name
                        Habilitado = $perfil.Enabled
                        ConexionesEntrantes = $perfil.DefaultInboundAction
                        ConexionesSalientes = $perfil.DefaultOutboundAction
                        NotificacionesActivas = $perfil.NotifyOnListen
                        LoggingAllowed = $perfil.LogAllowed
                        LoggingBlocked = $perfil.LogBlocked
                        RutaLogs = $perfil.LogFileName
                    }
                }
                $datos.Firewall = $firewallPerfiles
            } else {
                # Alternativa usando netsh
                $netshOutput = netsh advfirewall show allprofiles | Out-String
                
                # Procesar la salida para extraer el estado
                $perfilesNombres = @(&quot;Domain&quot;, &quot;Private&quot;, &quot;Public&quot;)
                $firewallNetsh = @()
                foreach ($nombre in $perfilesNombres) {
                    if ($netshOutput -match &quot;$nombre Profile Settings:&quot;) {
                        $habilitadoMatch = $netshOutput -match &quot;$nombre Profile Settings:\s*\n.*?State\s*(ON|OFF)&quot;
                        $habilitado = if ($matches -and $matches[1] -eq &quot;ON&quot;) { $true } else { $false }
                        
                        $firewallNetsh += @{
                            Nombre = $nombre
                            Habilitado = $habilitado
                            Detalles = &quot;Informaci√É¬≥n limitada disponible a trav√É¬©s de netsh&quot;
                        }
                    }
                }
                $datos.Firewall = $firewallNetsh
            }
        } catch {
            $datos.Firewall = @{ Error = &quot;No se pudo obtener informaci√É¬≥n del Firewall: $_&quot; }
        }
        
        # Control de Acceso de Usuario (UAC)
        try {
            $uacPolicies = Get-ItemProperty &quot;HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System&quot; -ErrorAction SilentlyContinue
            $uacEnabled = $uacPolicies.EnableLUA -eq 1
            
            $nivelUAC = switch ($uacPolicies.ConsentPromptBehaviorAdmin) {
                0 { &quot;Nunca notificar&quot; }
                1 { &quot;Notificar solo aplicaciones (sin oscurecer escritorio)&quot; }
                2 { &quot;Notificar siempre&quot; }
                5 { &quot;Notificar siempre y oscurecer escritorio (predeterminado)&quot; }
                default { &quot;Desconocido ($($uacPolicies.ConsentPromptBehaviorAdmin))&quot; }
            }
            
            $datos.UAC = @{
                Habilitado = $uacEnabled
                Nivel = $nivelUAC
                ElevacionNoSegura = $uacPolicies.EnableInstallerDetection -eq 0
                AdminSinPrompt = $uacPolicies.PromptOnSecureDesktop -eq 0
                AprobacionModo = $uacPolicies.ValidateAdminCodeSignatures -eq 1
            }
        } catch {
            $datos.UAC = @{ Error = &quot;No se pudo obtener informaci√É¬≥n de UAC: $_&quot; }
        }
        
        # SmartScreen y otras protecciones de seguridad
        try {
            $smartScreenPath = &quot;HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer&quot;
            $smartScreenEnabled = Get-ItemProperty -Path $smartScreenPath -Name &quot;SmartScreenEnabled&quot; -ErrorAction SilentlyContinue
            
            $datos.SmartScreen = @{
                Habilitado = if ($smartScreenEnabled) {
                    switch ($smartScreenEnabled.SmartScreenEnabled) {
                        &quot;RequireAdmin&quot; { &quot;Activo (requiere aprobaci√É¬≥n)&quot; }
                        &quot;Warn&quot; { &quot;Activo (solo advertencias)&quot; }
                        &quot;Off&quot; { &quot;Desactivado&quot; }
                        default { $smartScreenEnabled.SmartScreenEnabled }
                    }
                } else { &quot;No disponible&quot; }
            }
            
            # Informaci√É¬≥n sobre Secure Boot si est√É¬° disponible
            if (Get-Command Get-SecureBootUEFI -ErrorAction SilentlyContinue) {
                try {
                    $secureBootStatus = Get-SecureBootUEFI -Name SetupMode -ErrorAction SilentlyContinue
                    $datos.SecureBoot = @{
                        Habilitado = $secureBootStatus -eq 0 -or $secureBootStatus.Bytes[0] -eq 0
                    }
                } catch {
                    $datos.SecureBoot = @{ Estado = &quot;No disponible o no compatible&quot; }
                }
            }
            
            # Verificar BitLocker
            if (Get-Command Get-BitLockerVolume -ErrorAction SilentlyContinue) {
                try {
                    $bitlockerVolumes = Get-BitLockerVolume -ErrorAction SilentlyContinue
                    $datos.BitLocker = $bitlockerVolumes | ForEach-Object {
                        @{
                            Unidad = $_.MountPoint
                            ProteccionActiva = $_.ProtectionStatus
                            MetodoEncriptacion = $_.EncryptionMethod
                            EstadoEncriptacion = $_.VolumeStatus
                            PorcentajeEncriptado = $_.EncryptionPercentage
                        }
                    }
                } catch {
                    $datos.BitLocker = @{ Error = &quot;No se pudo obtener informaci√É¬≥n de BitLocker&quot; }
                }
            }
            
            # Verificar Device Guard y Credential Guard
            try {
                $deviceGuard = Get-CimInstance -ClassName Win32_DeviceGuard -Namespace root\Microsoft\Windows\DeviceGuard -ErrorAction SilentlyContinue
                if ($deviceGuard) {
                    $datos.DeviceGuard = @{
                        VirtualizationBasedSecurityStatus = $deviceGuard.VirtualizationBasedSecurityStatus
                        CredentialGuardStatus = if ($deviceGuard.SecurityServicesRunning -contains 1) { &quot;Activo&quot; } else { &quot;Inactivo&quot; }
                        HypervisorEnforcedCodeIntegrity = if ($deviceGuard.SecurityServicesRunning -contains 2) { &quot;Activo&quot; } else { &quot;Inactivo&quot; }
                    }
                }
            } catch {
                $datos.DeviceGuard = @{ Estado = &quot;No disponible&quot; }
            }
            
        } catch {
            $datos.SmartScreen = @{ Error = &quot;No se pudo obtener informaci√É¬≥n de SmartScreen: $_&quot; }
        }
        
        return $datos
    } catch {
        Write-Warning &quot;Error al obtener datos extendidos: $_&quot;
        return @{ Error = $_.Exception.Message }
    }
}

function Generate-CompleteHTML {
    param($InfoSistema, $MetricasRendimiento, $LogsEventos, $DatosExtendidos, $AnalisisConfiabilidad, $DiagnosticoHardware, $AnalisisRoles, $AnalisisPoliticas, $VerificacionCumplimiento, $AnalisisPermisos, $AuditoriaSoftware)
    
    # Extraer el nombre del servidor y SO directamente
    $nombreServidor = $InfoSistema.NombreServidor
    $sistemaOperativo = $InfoSistema.NombreSO
    
    # Convertir la imagen a Base64 para usar en el HTML
    $ms = New-Object System.IO.MemoryStream
    $imagenl.Save($ms, [System.Drawing.Imaging.ImageFormat]::Png)
    $imagenBytes = $ms.ToArray()
    $ms.Close()
    $imagenBase64 = [Convert]::ToBase64String($imagenBytes)
    
    # Crear el CSS como string separado para evitar problemas de parsing
    $cssStyles = @&#x27;
        * { box-sizing: border-box; }
        body { 
            font-family: &#x27;Segoe UI&#x27;, Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; padding: 20px; 
            background: linear-gradient(135deg, rgb(102,126,234) 0%, rgb(118,75,162) 100%);
            min-height: 100vh;
        }
        .container { 
            max-width: 1400px; margin: 0 auto; 
            background: white; padding: 30px; 
            border-radius: 15px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        h1 { 
            color: white; text-align: center; margin-bottom: 30px; 
            border-bottom: 4px solid rgb(255,255,255); padding-bottom: 20px;
            font-size: 2.5em; text-shadow: 2px 2px 6px rgba(0,0,0,0.8);
        }
        h2 { 
            color: white; margin: 40px 0 20px 0; padding: 20px; 
            background: linear-gradient(135deg, rgb(52,152,219), rgb(41,128,185)); 
            border-radius: 10px; font-size: 1.5em;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }
        h3 { 
            color: rgb(44,62,80); margin: 30px 0 15px 0; 
            border-left: 6px solid rgb(52,152,219); padding-left: 20px;
            font-size: 1.3em;
        }
        .metrics-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 25px; margin: 30px 0; 
        }
        .metric-card { 
            background: linear-gradient(135deg, rgb(248,249,250), rgb(233,236,239)); 
            padding: 25px; border-radius: 12px; 
            border-left: 6px solid rgb(52,152,219);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        .metric-card:hover { transform: translateY(-5px); }
        .metric-card h4 { margin-top: 0; color: rgb(44,62,80); font-size: 1.2em; }
        .metric-value { font-size: 2em; font-weight: bold; color: rgb(52,152,219); margin: 10px 0; }
        .status-indicator { 
            display: inline-block; padding: 5px 15px; 
            border-radius: 20px; color: white; font-weight: bold; 
        }
        .status-normal { background-color: rgb(39,174,96); }
        .status-warning { background-color: rgb(243,156,18); }
        .status-critical { background-color: rgb(231,76,60); }
        .status-high { background-color: rgb(230,126,34); }
        .status-medium { background-color: rgb(241,196,15); color: rgb(44,62,80); }
        
        table { 
            border-collapse: collapse; width: 100%; margin: 20px 0; 
            background: white; border-radius: 10px; overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        th { 
            background: linear-gradient(135deg, rgb(52,152,219), rgb(41,128,185)); 
            color: white; padding: 15px; text-align: left; font-weight: 600;
        }
        td { padding: 12px 15px; border-bottom: 1px solid rgb(236,240,241); }
        tr:nth-child(even) { background-color: rgb(248,249,250); }
        tr:hover { background-color: rgb(214,234,248); }
        
        .summary-box { 
            background: linear-gradient(135deg, rgb(46,204,113), rgb(39,174,96)); 
            color: white; padding: 25px; margin: 30px 0; 
            border-radius: 12px; text-align: center;
            box-shadow: 0 6px 20px rgba(46, 204, 113, 0.3);
        }
        .summary-box h3 { color: white; border: none; padding: 0; margin-bottom: 15px; }
        
        .warning-box { 
            background: linear-gradient(135deg, rgb(231,76,60), rgb(192,57,43)); 
            color: white; padding: 25px; margin: 30px 0; 
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.3);
        }
        .warning-box h3 { color: white; border: none; padding: 0; margin-bottom: 15px; }
        
        .info-box { 
            background: linear-gradient(135deg, rgb(52,152,219), rgb(41,128,185)); 
            color: white; padding: 25px; margin: 30px 0; 
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.3);
        }
        .info-box h3 { color: white; border: none; padding: 0; margin-bottom: 15px; }
        
        .header-info { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 20px; margin: 30px 0; 
        }
        .header-card { 
            background: white; padding: 20px; border-radius: 10px; 
            border-left: 5px solid rgb(52,152,219);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .header-card strong { color: rgb(44,62,80); }
        
        .logo { 
            text-align: center; margin-bottom: 30px; 
        }
        .logo img { 
            max-width: 200px; height: auto; 
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
        }
        
        .footer { 
            text-align: center; margin-top: 50px; padding: 30px; 
            background: linear-gradient(135deg, rgb(44,62,80), rgb(52,73,94)); 
            color: white; border-radius: 10px;
        }
        
        .progress-bar { 
            background-color: rgb(236,240,241); 
            border-radius: 10px; height: 20px; 
            overflow: hidden; margin: 10px 0;
        }
        .progress-fill { 
            height: 100%; 
            background: linear-gradient(90deg, rgb(46,204,113), rgb(39,174,96)); 
            transition: width 0.3s ease;
        }
        
        .tabs { 
            display: flex; 
            background: rgb(236,240,241); 
            border-radius: 10px 10px 0 0; 
            overflow: hidden;
        }
        .tab { 
            flex: 1; padding: 15px; text-align: center; 
            background: rgb(189,195,199); color: rgb(44,62,80); 
            cursor: pointer; transition: background 0.3s;
        }
        .tab.active { 
            background: rgb(52,152,219); color: white; 
        }
        .tab-content { 
            background: white; padding: 30px; 
            border-radius: 0 0 10px 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .compliance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .compliance-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            border-left: 5px solid;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .compliance-pass { border-left-color: rgb(39,174,96); }
        .compliance-fail { border-left-color: rgb(231,76,60); }
        .compliance-pending { border-left-color: rgb(243,156,18); }
        
        .security-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .security-metric {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, rgb(248,249,250), rgb(233,236,239));
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .security-metric .number {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .risk-high { color: rgb(231,76,60); }
        .risk-medium { color: rgb(243,156,18); }
        .risk-low { color: rgb(39,174,96); }
        
        @media (max-width: 768px) {
            .container { padding: 15px; }
            .metrics-grid { grid-template-columns: 1fr; }
            .header-info { grid-template-columns: 1fr; }
            h1 { font-size: 2em; }
            h2 { font-size: 1.3em; }
        }
&#x27;@

    $htmlContent = @&quot;
&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;es&quot;&gt;
&lt;head&gt;
    &lt;meta charset=&quot;UTF-8&quot;&gt;
    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;
    &lt;title&gt;Informe de Salud del Sistema - $nombreServidor&lt;/title&gt;
    &lt;style&gt;$cssStyles&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;div class=&quot;container&quot;&gt;
        &lt;div class=&quot;logo&quot;&gt;
            &lt;img src=&quot;data:image/png;base64,$imagenBase64&quot; alt=&quot;Logo&quot;&gt;
        &lt;/div&gt;
        
        &lt;h1&gt;√∞≈∏‚Äì¬•√Ø¬∏¬è INFORME COMPLETO DE SALUD DEL SISTEMA&lt;/h1&gt;
        
        &lt;div class=&quot;summary-box&quot;&gt;
            &lt;h3&gt;√∞≈∏‚Äú≈† Resumen Ejecutivo&lt;/h3&gt;
            &lt;p&gt;&lt;strong&gt;Servidor:&lt;/strong&gt; $nombreServidor | &lt;strong&gt;Sistema:&lt;/strong&gt; $sistemaOperativo&lt;/p&gt;
            &lt;p&gt;&lt;strong&gt;Fecha del Informe:&lt;/strong&gt; $(Get-Date -Format &quot;dd/MM/yyyy HH:mm:ss&quot;)&lt;/p&gt;
            &lt;p&gt;&lt;strong&gt;Tiempo de Actividad:&lt;/strong&gt; $($InfoSistema.TiempoActividad.Days) d√É¬≠as, $($InfoSistema.TiempoActividad.Hours) horas&lt;/p&gt;
        &lt;/div&gt;

        &lt;div class=&quot;header-info&quot;&gt;
            &lt;div class=&quot;header-card&quot;&gt;
                &lt;strong&gt;√∞≈∏¬è¬¢ Informaci√É¬≥n del Sistema&lt;/strong&gt;&lt;br&gt;
                Fabricante: $($InfoSistema.Fabricante)&lt;br&gt;
                Modelo: $($InfoSistema.Modelo)&lt;br&gt;
                Procesador: $($InfoSistema.Procesador)&lt;br&gt;
                Memoria Total: $($InfoSistema.MemoriaTotal) GB
            &lt;/div&gt;
            &lt;div class=&quot;header-card&quot;&gt;
                &lt;strong&gt;√∞≈∏≈í¬ê Configuraci√É¬≥n de Red&lt;/strong&gt;&lt;br&gt;
                IP Principal: $($InfoSistema.DireccionIP)&lt;br&gt;
                $($InfoSistema.DominioWorkgroup)&lt;br&gt;
                Zona Horaria: $($InfoSistema.TimeZone)
            &lt;/div&gt;
            &lt;div class=&quot;header-card&quot;&gt;
                &lt;strong&gt;√∞≈∏‚Äù¬ß Detalles T√É¬©cnicos&lt;/strong&gt;&lt;br&gt;
                Versi√É¬≥n SO: $($InfoSistema.VersionSO)&lt;br&gt;
                Build: $($InfoSistema.BuildNumber)&lt;br&gt;
                Arquitectura: $($InfoSistema.Arquitectura)&lt;br&gt;
                √É≈°ltimo Reinicio: $($InfoSistema.UltimoReinicio.ToString(&quot;dd/MM/yyyy HH:mm&quot;))
            &lt;/div&gt;
        &lt;/div&gt;

        &lt;h2&gt;√∞≈∏‚ÄúÀÜ M√É‚Ä∞TRICAS DE RENDIMIENTO DE LOS 4 SUBSISTEMAS&lt;/h2&gt;
        
        &lt;div class=&quot;metrics-grid&quot;&gt;
            &lt;div class=&quot;metric-card&quot;&gt;
                &lt;h4&gt;√∞≈∏‚Äù¬• Subsistema CPU&lt;/h4&gt;
                &lt;div class=&quot;metric-value&quot;&gt;$($MetricasRendimiento.CPU.UsoCPU)%&lt;/div&gt;
                &lt;span class=&quot;status-indicator status-$($MetricasRendimiento.CPU.Estado.ToLower())&quot;&gt;$($MetricasRendimiento.CPU.Estado)&lt;/span&gt;
                &lt;p&gt;&lt;strong&gt;Cola del Procesador:&lt;/strong&gt; $($MetricasRendimiento.CPU.ColaProcesor)&lt;/p&gt;
                &lt;p&gt;&lt;strong&gt;Interrupciones/seg:&lt;/strong&gt; $($MetricasRendimiento.CPU.Interrupciones)&lt;/p&gt;
            &lt;/div&gt;
            
            &lt;div class=&quot;metric-card&quot;&gt;
                &lt;h4&gt;√∞≈∏¬ß¬† Subsistema Memoria&lt;/h4&gt;
                &lt;div class=&quot;metric-value&quot;&gt;$($MetricasRendimiento.Memoria.PorcentajeUsado)%&lt;/div&gt;
                &lt;span class=&quot;status-indicator status-$($MetricasRendimiento.Memoria.Estado.ToLower())&quot;&gt;$($MetricasRendimiento.Memoria.Estado)&lt;/span&gt;
                &lt;p&gt;&lt;strong&gt;Usada:&lt;/strong&gt; $($MetricasRendimiento.Memoria.UsadaMB) MB / $($MetricasRendimiento.Memoria.TotalMB) MB&lt;/p&gt;
                &lt;p&gt;&lt;strong&gt;P√É¬°ginas/seg:&lt;/strong&gt; $($MetricasRendimiento.Memoria.PaginasPorSeg)&lt;/p&gt;
                &lt;p&gt;&lt;strong&gt;Cach√É¬©:&lt;/strong&gt; $($MetricasRendimiento.Memoria.CacheMB) MB&lt;/p&gt;
            &lt;/div&gt;
        &lt;/div&gt;

        &lt;h3&gt;√∞≈∏‚Äô¬æ Subsistema Disco&lt;/h3&gt;
        &lt;table&gt;
            &lt;tr&gt;
                &lt;th&gt;Unidad&lt;/th&gt;
                &lt;th&gt;Total (GB)&lt;/th&gt;
                &lt;th&gt;Libre (GB)&lt;/th&gt;
                &lt;th&gt;% Usado&lt;/th&gt;
                &lt;th&gt;Sistema Archivos&lt;/th&gt;
                &lt;th&gt;Tiempo Lectura (ms)&lt;/th&gt;
                &lt;th&gt;Tiempo Escritura (ms)&lt;/th&gt;
                &lt;th&gt;Estado&lt;/th&gt;
            &lt;/tr&gt;
&quot;@

    foreach ($disco in $MetricasRendimiento.Discos) {
        $statusClass = switch ($disco.Estado) {
            &quot;Normal&quot; { &quot;status-normal&quot; }
            &quot;Advertencia&quot; { &quot;status-warning&quot; }
            &quot;Cr√É¬≠tico&quot; { &quot;status-critical&quot; }
            default { &quot;status-normal&quot; }
        }
        
        $htmlContent += @&quot;
            &lt;tr&gt;
                &lt;td&gt;&lt;strong&gt;$($disco.Unidad)&lt;/strong&gt;&lt;/td&gt;
                &lt;td&gt;$($disco.TotalGB)&lt;/td&gt;
                &lt;td&gt;$($disco.LibreGB)&lt;/td&gt;
                &lt;td&gt;$($disco.PorcentajeUsado)%&lt;/td&gt;
                &lt;td&gt;$($disco.SistemaArchivos)&lt;/td&gt;
                &lt;td&gt;$($disco.TiempoLectura)&lt;/td&gt;
                &lt;td&gt;$($disco.TiempoEscritura)&lt;/td&gt;
                &lt;td&gt;&lt;span class=&quot;status-indicator $statusClass&quot;&gt;$($disco.Estado)&lt;/span&gt;&lt;/td&gt;
            &lt;/tr&gt;
&quot;@
    }

    $htmlContent += @&quot;
        &lt;/table&gt;

        &lt;h3&gt;√∞≈∏≈í¬ê Subsistema Red&lt;/h3&gt;
        &lt;table&gt;
            &lt;tr&gt;
                &lt;th&gt;Interfaz&lt;/th&gt;
                &lt;th&gt;Bytes Enviados (KB)&lt;/th&gt;
                &lt;th&gt;Bytes Recibidos (KB)&lt;/th&gt;
                &lt;th&gt;Paquetes Enviados&lt;/th&gt;
                &lt;th&gt;Paquetes Recibidos&lt;/th&gt;
                &lt;th&gt;Errores Env√É¬≠o&lt;/th&gt;
                &lt;th&gt;Errores Recepci√É¬≥n&lt;/th&gt;
            &lt;/tr&gt;
&quot;@

    foreach ($interfaz in $MetricasRendimiento.Red) {
        $htmlContent += @&quot;
            &lt;tr&gt;
                &lt;td&gt;$($interfaz.Interfaz)&lt;/td&gt;
                &lt;td&gt;$($interfaz.BytesEnviados)&lt;/td&gt;
                &lt;td&gt;$($interfaz.BytesRecibidos)&lt;/td&gt;
                &lt;td&gt;$($interfaz.PaquetesEnviados)&lt;/td&gt;
                &lt;td&gt;$($interfaz.PaquetesRecibidos)&lt;/td&gt;
                &lt;td&gt;$($interfaz.ErroresEnvio)&lt;/td&gt;
                &lt;td&gt;$($interfaz.ErroresRecepcion)&lt;/td&gt;
            &lt;/tr&gt;
&quot;@
    }

    # NUEVA SECCI√É‚ÄúN: AN√É¬ÅLISIS DE CONFIABILIDAD
    if ($AnalisisConfiabilidad -and $AnalisisConfiabilidad.EstadisticasEstabilidad) {
        $htmlContent += @&quot;
        &lt;/table&gt;

        &lt;h2&gt;√∞≈∏‚Äù¬ç AN√É¬ÅLISIS DE CONFIABILIDAD DEL SISTEMA&lt;/h2&gt;
        
        &lt;div class=&quot;metrics-grid&quot;&gt;
            &lt;div class=&quot;metric-card&quot;&gt;
                &lt;h4&gt;√∞≈∏‚Äú≈† Estad√É¬≠sticas de Estabilidad&lt;/h4&gt;
                &lt;p&gt;&lt;strong&gt;√É¬çndice de Estabilidad:&lt;/strong&gt; &lt;span class=&quot;status-indicator status-$(if($AnalisisConfiabilidad.EstadisticasEstabilidad.IndiceEstabilidad -eq &#x27;Alta&#x27;){&#x27;normal&#x27;}elseif($AnalisisConfiabilidad.EstadisticasEstabilidad.IndiceEstabilidad -eq &#x27;Media&#x27;){&#x27;warning&#x27;}else{&#x27;critical&#x27;})&quot;&gt;$($AnalisisConfiabilidad.EstadisticasEstabilidad.IndiceEstabilidad)&lt;/span&gt;&lt;/p&gt;
                &lt;p&gt;&lt;strong&gt;Fallos de Aplicaci√É¬≥n:&lt;/strong&gt; $($AnalisisConfiabilidad.EstadisticasEstabilidad.FallosAplicacion)&lt;/p&gt;
                &lt;p&gt;&lt;strong&gt;Fallos del Sistema:&lt;/strong&gt; $($AnalisisConfiabilidad.EstadisticasEstabilidad.FallosSistema)&lt;/p&gt;
                &lt;p&gt;&lt;strong&gt;Reinicios Detectados:&lt;/strong&gt; $($AnalisisConfiabilidad.EstadisticasEstabilidad.ReiniciosDetectados)&lt;/p&gt;
                &lt;p&gt;&lt;strong&gt;Per√É¬≠odo de An√É¬°lisis:&lt;/strong&gt; $($AnalisisConfiabilidad.EstadisticasEstabilidad.PeriodoAnalisis)&lt;/p&gt;
            &lt;/div&gt;
        &lt;/div&gt;
&quot;@

        if ($AnalisisConfiabilidad.TendenciasSemanales -and $AnalisisConfiabilidad.TendenciasSemanales.Count -gt 0) {
            $htmlContent += @&quot;
        &lt;h3&gt;√∞≈∏‚ÄúÀÜ Tendencias de Estabilidad (√É≈°ltimos 7 d√É¬≠as)&lt;/h3&gt;
        &lt;table&gt;
            &lt;tr&gt;
                &lt;th&gt;Fecha&lt;/th&gt;
                &lt;th&gt;Total Eventos&lt;/th&gt;
                &lt;th&gt;Eventos Cr√É¬≠ticos&lt;/th&gt;
                &lt;th&gt;Estado de Estabilidad&lt;/th&gt;
            &lt;/tr&gt;
&quot;@
            foreach ($tendencia in $AnalisisConfiabilidad.TendenciasSemanales) {
                $estabilidadClass = switch ($tendencia.Estabilidad) {
                    &quot;Estable&quot; { &quot;status-normal&quot; }
                    &quot;Moderada&quot; { &quot;status-warning&quot; }
                    &quot;Inestable&quot; { &quot;status-critical&quot; }
                    default { &quot;status-normal&quot; }
                }
                
                $htmlContent += @&quot;
            &lt;tr&gt;
                &lt;td&gt;$($tendencia.Fecha)&lt;/td&gt;
                &lt;td&gt;$($tendencia.TotalEventos)&lt;/td&gt;
                &lt;td&gt;$($tendencia.EventosCriticos)&lt;/td&gt;
                &lt;td&gt;&lt;span class=&quot;status-indicator $estabilidadClass&quot;&gt;$($tendencia.Estabilidad)&lt;/span&gt;&lt;/td&gt;
            &lt;/tr&gt;
&quot;@
            }
            $htmlContent += &quot;&lt;/table&gt;&quot;
        }
    }

    # NUEVA SECCI√É‚ÄúN: DIAGN√É‚ÄúSTICO DE HARDWARE AVANZADO
    if ($DiagnosticoHardware) {
        $htmlContent += @&quot;
        &lt;h2&gt;√∞≈∏‚Äù¬ß DIAGN√É‚ÄúSTICO AVANZADO DE HARDWARE&lt;/h2&gt;
&quot;@

        # Estado SMART de discos
        if ($DiagnosticoHardware.DiscosSMART -and $DiagnosticoHardware.DiscosSMART.Count -gt 0) {
            $htmlContent += @&quot;
        &lt;h3&gt;√∞≈∏‚Äô¬æ Estado SMART de Discos Duros&lt;/h3&gt;
        &lt;table&gt;
            &lt;tr&gt;
                &lt;th&gt;Modelo&lt;/th&gt;
                &lt;th&gt;N√É¬∫mero de Serie&lt;/th&gt;
                &lt;th&gt;Tama√É¬±o (GB)&lt;/th&gt;
                &lt;th&gt;Interfaz&lt;/th&gt;
                &lt;th&gt;Estado SMART&lt;/th&gt;
                &lt;th&gt;Particiones&lt;/th&gt;
                &lt;th&gt;Estado General&lt;/th&gt;
            &lt;/tr&gt;
&quot;@
            foreach ($disco in $DiagnosticoHardware.DiscosSMART) {
                $estadoClass = switch ($disco.Estado) {
                    &quot;Normal&quot; { &quot;status-normal&quot; }
                    &quot;Cr√É¬≠tico&quot; { &quot;status-critical&quot; }
                    default { &quot;status-warning&quot; }
                }
                
                $htmlContent += @&quot;
            &lt;tr&gt;
                &lt;td&gt;$($disco.Modelo)&lt;/td&gt;
                &lt;td&gt;$($disco.NumeroSerie)&lt;/td&gt;
                &lt;td&gt;$($disco.TamanoGB)&lt;/td&gt;
                &lt;td&gt;$($disco.Interfaz)&lt;/td&gt;
                &lt;td&gt;$($disco.EstadoSMART)&lt;/td&gt;
                &lt;td&gt;$($disco.Particiones)&lt;/td&gt;
                &lt;td&gt;&lt;span class=&quot;status-indicator $estadoClass&quot;&gt;$($disco.Estado)&lt;/span&gt;&lt;/td&gt;
            &lt;/tr&gt;
&quot;@
            }
            $htmlContent += &quot;&lt;/table&gt;&quot;
        }

        # Temperaturas
        if ($DiagnosticoHardware.Temperaturas -and $DiagnosticoHardware.Temperaturas.Count -gt 0) {
            $htmlContent += @&quot;
        &lt;h3&gt;√∞≈∏≈í¬°√Ø¬∏¬è Temperaturas de Componentes&lt;/h3&gt;
        &lt;table&gt;
            &lt;tr&gt;
                &lt;th&gt;Componente&lt;/th&gt;
                &lt;th&gt;Temperatura (√Ç¬∞C)&lt;/th&gt;
                &lt;th&gt;Estado&lt;/th&gt;
            &lt;/tr&gt;
&quot;@
            foreach ($temp in $DiagnosticoHardware.Temperaturas) {
                $tempClass = switch ($temp.Estado) {
                    &quot;Normal&quot; { &quot;status-normal&quot; }
                    &quot;Alto&quot; { &quot;status-warning&quot; }
                    &quot;Cr√É¬≠tico&quot; { &quot;status-critical&quot; }
                    default { &quot;status-warning&quot; }
                }
                
                $tempValue = if ($temp.TemperaturaC) { &quot;$($temp.TemperaturaC)√Ç¬∞C&quot; } else { &quot;No disponible&quot; }
                
                $htmlContent += @&quot;
            &lt;tr&gt;
                &lt;td&gt;$($temp.Componente)&lt;/td&gt;
                &lt;td&gt;$tempValue&lt;/td&gt;
                &lt;td&gt;&lt;span class=&quot;status-indicator $tempClass&quot;&gt;$($temp.Estado)&lt;/span&gt;&lt;/td&gt;
            &lt;/tr&gt;
&quot;@
            }
            $htmlContent += &quot;&lt;/table&gt;&quot;
        }

        # Estado de bater√É¬≠as
        if ($DiagnosticoHardware.Baterias -and $DiagnosticoHardware.Baterias.Count -gt 0) {
            $htmlContent += @&quot;
        &lt;h3&gt;√∞≈∏‚Äù‚Äπ Estado de Bater√É¬≠as&lt;/h3&gt;
        &lt;table&gt;
            &lt;tr&gt;
                &lt;th&gt;Nombre&lt;/th&gt;
                &lt;th&gt;Fabricante&lt;/th&gt;
                &lt;th&gt;Estado de Carga&lt;/th&gt;
                &lt;th&gt;% Carga&lt;/th&gt;
                &lt;th&gt;Tiempo Restante&lt;/th&gt;
                &lt;th&gt;Salud de Bater√É¬≠a&lt;/th&gt;
                &lt;th&gt;Estado&lt;/th&gt;
            &lt;/tr&gt;
&quot;@
            foreach ($bateria in $DiagnosticoHardware.Baterias) {
                if ($bateria.Estado -ne &quot;No se detectaron bater√É¬≠as (sistema de escritorio)&quot;) {
                    $bateriaClass = switch ($bateria.Estado) {
                        &quot;Normal&quot; { &quot;status-normal&quot; }
                        &quot;Advertencia&quot; { &quot;status-warning&quot; }
                        &quot;Bajo&quot; { &quot;status-warning&quot; }
                        &quot;Cr√É¬≠tico&quot; { &quot;status-critical&quot; }
                        default { &quot;status-normal&quot; }
                    }
                    
                    $htmlContent += @&quot;
            &lt;tr&gt;
                &lt;td&gt;$($bateria.Nombre)&lt;/td&gt;
                &lt;td&gt;$($bateria.Fabricante)&lt;/td&gt;
                &lt;td&gt;$($bateria.EstadoCarga)&lt;/td&gt;
                &lt;td&gt;$($bateria.PorcentajeCarga)%&lt;/td&gt;
                &lt;td&gt;$($bateria.TiempoRestante)&lt;/td&gt;
                &lt;td&gt;$($bateria.SaludBateria)&lt;/td&gt;
                &lt;td&gt;&lt;span class=&quot;status-indicator $bateriaClass&quot;&gt;$($bateria.Estado)&lt;/span&gt;&lt;/td&gt;
            &lt;/tr&gt;
&quot;@
                } else {
                    $htmlContent += @&quot;
            &lt;tr&gt;
                &lt;td colspan=&quot;7&quot; style=&quot;text-align: center; font-style: italic;&quot;&gt;$($bateria.Estado)&lt;/td&gt;
            &lt;/tr&gt;
&quot;@
                }
            }
            $htmlContent += &quot;&lt;/table&gt;&quot;
        }
    }

    # NUEVA SECCI√É‚ÄúN: AN√É¬ÅLISIS DE ROLES DE SERVIDOR
    if ($AnalisisRoles -and $AnalisisRoles.EsServidor) {
        $htmlContent += @&quot;
        &lt;h2&gt;√∞≈∏‚Äì¬•√Ø¬∏¬è AN√É¬ÅLISIS DE ROLES DE WINDOWS SERVER&lt;/h2&gt;
        
        &lt;div class=&quot;info-box&quot;&gt;
            &lt;h3&gt;√∞≈∏‚Äú≈† Resumen de Roles&lt;/h3&gt;
            &lt;p&gt;&lt;strong&gt;Tipo de Sistema:&lt;/strong&gt; $($AnalisisRoles.TipoSistema)&lt;/p&gt;
            &lt;p&gt;&lt;strong&gt;Total de Roles Detectados:&lt;/strong&gt; $($AnalisisRoles.ResumenRoles.TotalRoles)&lt;/p&gt;
            &lt;p&gt;&lt;strong&gt;Roles Cr√É¬≠ticos:&lt;/strong&gt; $($AnalisisRoles.ResumenRoles.RolesCriticos)&lt;/p&gt;
            &lt;p&gt;&lt;strong&gt;Roles Detenidos:&lt;/strong&gt; $($AnalisisRoles.ResumenRoles.RolesDetenidos)&lt;/p&gt;
            &lt;p&gt;&lt;strong&gt;Estado General:&lt;/strong&gt; $($AnalisisRoles.ResumenRoles.EstadoGeneral)&lt;/p&gt;
        &lt;/div&gt;
&quot;@

        if ($AnalisisRoles.RolesDetectados -and $AnalisisRoles.RolesDetectados.Count -gt 0) {
            $htmlContent += @&quot;
        &lt;h3&gt;√∞≈∏‚Äù¬ß Roles y Servicios Detectados&lt;/h3&gt;
        &lt;table&gt;
            &lt;tr&gt;
                &lt;th&gt;Rol&lt;/th&gt;
                &lt;th&gt;Servicio&lt;/th&gt;
                &lt;th&gt;Estado&lt;/th&gt;
                &lt;th&gt;Tipo de Inicio&lt;/th&gt;
                &lt;th&gt;Descripci√É¬≥n&lt;/th&gt;
                &lt;th&gt;Cr√É¬≠tico&lt;/th&gt;
            &lt;/tr&gt;
&quot;@
            foreach ($rol in $AnalisisRoles.RolesDetectados) {
                $estadoClass = if ($rol.Estado -eq &quot;Running&quot;) { &quot;status-normal&quot; } else { &quot;status-critical&quot; }
                $criticoIcon = if ($rol.Critico) { &quot;√¢≈°¬†√Ø¬∏¬è&quot; } else { &quot;√¢‚Äû¬π√Ø¬∏¬è&quot; }
                
                $htmlContent += @&quot;
            &lt;tr&gt;
                &lt;td&gt;&lt;strong&gt;$($rol.Rol)&lt;/strong&gt;&lt;/td&gt;
                &lt;td&gt;$($rol.Servicio)&lt;/td&gt;
                &lt;td&gt;&lt;span class=&quot;status-indicator $estadoClass&quot;&gt;$($rol.Estado)&lt;/span&gt;&lt;/td&gt;
                &lt;td&gt;$($rol.TipoInicio)&lt;/td&gt;
                &lt;td&gt;$($rol.Descripcion)&lt;/td&gt;
                &lt;td&gt;$criticoIcon&lt;/td&gt;
            &lt;/tr&gt;
&quot;@
            }
            $htmlContent += &quot;&lt;/table&gt;&quot;
        }

        # Informaci√É¬≥n de dominio
        if ($AnalisisRoles.InformacionDominio) {
            $htmlContent += @&quot;
        &lt;h3&gt;√∞≈∏≈í¬ê Informaci√É¬≥n de Dominio&lt;/h3&gt;
        &lt;div class=&quot;metric-card&quot;&gt;
            &lt;p&gt;&lt;strong&gt;Parte de Dominio:&lt;/strong&gt; $(if($AnalisisRoles.InformacionDominio.ParteDominio){&#x27;S√É¬≠&#x27;}else{&#x27;No&#x27;})&lt;/p&gt;
            &lt;p&gt;&lt;strong&gt;Dominio:&lt;/strong&gt; $($AnalisisRoles.InformacionDominio.Dominio)&lt;/p&gt;
            &lt;p&gt;&lt;strong&gt;Rol del Servidor:&lt;/strong&gt; $($AnalisisRoles.InformacionDominio.Rol)&lt;/p&gt;
        &lt;/div&gt;
&quot;@
        }
    } elseif ($AnalisisRoles -and -not $AnalisisRoles.EsServidor) {
        $htmlContent += @&quot;
        &lt;div class=&quot;info-box&quot;&gt;
            &lt;h3&gt;√¢‚Äû¬π√Ø¬∏¬è Informaci√É¬≥n del Sistema&lt;/h3&gt;
            &lt;p&gt;Este sistema es un &lt;strong&gt;$($AnalisisRoles.TipoSistema)&lt;/strong&gt;, no un Windows Server.&lt;/p&gt;
            &lt;p&gt;El an√É¬°lisis de roles de servidor no es aplicable.&lt;/p&gt;
        &lt;/div&gt;
&quot;@
    }

    # NUEVA SECCI√É‚ÄúN: AN√É¬ÅLISIS DE POL√É¬çTICAS DE GRUPO
    if ($AnalisisPoliticas) {
        $htmlContent += @&quot;
        &lt;h2&gt;√∞≈∏‚Ä∫¬°√Ø¬∏¬è AN√É¬ÅLISIS DE POL√É¬çTICAS DE GRUPO Y SEGURIDAD&lt;/h2&gt;
&quot;@

        if ($AnalisisPoliticas.EnDominio) {
            $htmlContent += @&quot;
        &lt;div class=&quot;info-box&quot;&gt;
            &lt;h3&gt;√∞≈∏‚Äú‚Äπ Informaci√É¬≥n de GPO&lt;/h3&gt;
            &lt;p&gt;&lt;strong&gt;Sistema en Dominio:&lt;/strong&gt; S√É¬≠&lt;/p&gt;
            &lt;p&gt;&lt;strong&gt;√É≈°ltima Actualizaci√É¬≥n GPO:&lt;/strong&gt; $($AnalisisPoliticas.UltimaActualizacionGPO)&lt;/p&gt;
        &lt;/div&gt;
&quot;@

            # GPOs aplicadas al equipo
            if ($AnalisisPoliticas.GPOsEquipo -and $AnalisisPoliticas.GPOsEquipo.Count -gt 0) {
                $htmlContent += @&quot;
        &lt;h3&gt;√∞≈∏‚Äì¬•√Ø¬∏¬è GPOs Aplicadas al Equipo&lt;/h3&gt;
        &lt;table&gt;
            &lt;tr&gt;
                &lt;th&gt;Nombre de la GPO&lt;/th&gt;
                &lt;th&gt;Tipo&lt;/th&gt;
                &lt;th&gt;Estado&lt;/th&gt;
            &lt;/tr&gt;
&quot;@
                foreach ($gpo in $AnalisisPoliticas.GPOsEquipo) {
                    $htmlContent += @&quot;
            &lt;tr&gt;
                &lt;td&gt;$($gpo.Nombre)&lt;/td&gt;
                &lt;td&gt;$($gpo.Tipo)&lt;/td&gt;
                &lt;td&gt;&lt;span class=&quot;status-indicator status-normal&quot;&gt;$($gpo.Estado)&lt;/span&gt;&lt;/td&gt;
            &lt;/tr&gt;
&quot;@
                }
                $htmlContent += &quot;&lt;/table&gt;&quot;
            }

            # GPOs aplicadas al usuario
            if ($AnalisisPoliticas.GPOsUsuario -and $AnalisisPoliticas.GPOsUsuario.Count -gt 0) {
                $htmlContent += @&quot;
        &lt;h3&gt;√∞≈∏‚Äò¬§ GPOs Aplicadas al Usuario&lt;/h3&gt;
        &lt;table&gt;
            &lt;tr&gt;
                &lt;th&gt;Nombre de la GPO&lt;/th&gt;
                &lt;th&gt;Tipo&lt;/th&gt;
                &lt;th&gt;Estado&lt;/th&gt;
            &lt;/tr&gt;
&quot;@
                foreach ($gpo in $AnalisisPoliticas.GPOsUsuario) {
                    $htmlContent += @&quot;
            &lt;tr&gt;
                &lt;td&gt;$($gpo.Nombre)&lt;/td&gt;
                &lt;td&gt;$($gpo.Tipo)&lt;/td&gt;
                &lt;td&gt;&lt;span class=&quot;status-indicator status-normal&quot;&gt;$($gpo.Estado)&lt;/span&gt;&lt;/td&gt;
            &lt;/tr&gt;
&quot;@
                }
                $htmlContent += &quot;&lt;/table&gt;&quot;
            }
        } else {
            $htmlContent += @&quot;
        &lt;div class=&quot;warning-box&quot;&gt;
            &lt;h3&gt;√¢≈°¬†√Ø¬∏¬è Sistema No Unido a Dominio&lt;/h3&gt;
            &lt;p&gt;Este sistema no est√É¬° unido a un dominio Active Directory.&lt;/p&gt;
            &lt;p&gt;Las pol√É¬≠ticas de grupo de dominio no son aplicables.&lt;/p&gt;
        &lt;/div&gt;
&quot;@
        }

        # Pol√É¬≠ticas locales
        if ($AnalisisPoliticas.PoliticasLocales -and $AnalisisPoliticas.PoliticasLocales.Count -gt 0) {
            $htmlContent += @&quot;
        &lt;h3&gt;√∞≈∏‚Äù‚Äô Pol√É¬≠ticas de Seguridad Locales&lt;/h3&gt;
        &lt;table&gt;
            &lt;tr&gt;
                &lt;th&gt;Pol√É¬≠tica&lt;/th&gt;
                &lt;th&gt;Valor&lt;/th&gt;
                &lt;th&gt;Categor√É¬≠a&lt;/th&gt;
            &lt;/tr&gt;
&quot;@
            foreach ($politica in $AnalisisPoliticas.PoliticasLocales | Select-Object -First 20) {
                $htmlContent += @&quot;
            &lt;tr&gt;
                &lt;td&gt;$($politica.Politica)&lt;/td&gt;
                &lt;td&gt;$($politica.Valor)&lt;/td&gt;
                &lt;td&gt;$($politica.Categoria)&lt;/td&gt;
            &lt;/tr&gt;
&quot;@
            }
            $htmlContent += &quot;&lt;/table&gt;&quot;
        }
    }

    # NUEVA SECCI√É‚ÄúN: VERIFICACI√É‚ÄúN DE CUMPLIMIENTO
    if ($VerificacionCumplimiento -and $VerificacionCumplimiento.ResumenCumplimiento) {
        $htmlContent += @&quot;
        &lt;h2&gt;√¢≈ì‚Ä¶ VERIFICACI√É‚ÄúN DE CUMPLIMIENTO (CIS BENCHMARKS)&lt;/h2&gt;
        
        &lt;div class=&quot;security-summary&quot;&gt;
            &lt;div class=&quot;security-metric&quot;&gt;
                &lt;div class=&quot;number risk-low&quot;&gt;$($VerificacionCumplimiento.ResumenCumplimiento.PorcentajeCumplimiento)%&lt;/div&gt;
                &lt;div&gt;Cumplimiento General&lt;/div&gt;
            &lt;/div&gt;
            &lt;div class=&quot;security-metric&quot;&gt;
                &lt;div class=&quot;number risk-low&quot;&gt;$($VerificacionCumplimiento.ResumenCumplimiento.Cumple)&lt;/div&gt;
                &lt;div&gt;Verificaciones Exitosas&lt;/div&gt;
            &lt;/div&gt;
            &lt;div class=&quot;security-metric&quot;&gt;
                &lt;div class=&quot;number risk-high&quot;&gt;$($VerificacionCumplimiento.ResumenCumplimiento.NoCumple)&lt;/div&gt;
                &lt;div&gt;No Cumple&lt;/div&gt;
            &lt;/div&gt;
            &lt;div class=&quot;security-metric&quot;&gt;
                &lt;div class=&quot;number risk-medium&quot;&gt;$($VerificacionCumplimiento.ResumenCumplimiento.PendienteRevision)&lt;/div&gt;
                &lt;div&gt;Pendiente Revisi√É¬≥n&lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
        
        &lt;div class=&quot;$(if($VerificacionCumplimiento.ResumenCumplimiento.NivelCumplimiento -eq &#x27;Excelente&#x27; -or $VerificacionCumplimiento.ResumenCumplimiento.NivelCumplimiento -eq &#x27;Bueno&#x27;){&#x27;summary-box&#x27;}elseif($VerificacionCumplimiento.ResumenCumplimiento.NivelCumplimiento -eq &#x27;Aceptable&#x27;){&#x27;info-box&#x27;}else{&#x27;warning-box&#x27;})&quot;&gt;
            &lt;h3&gt;√∞≈∏‚Äú≈† Nivel de Cumplimiento: $($VerificacionCumplimiento.ResumenCumplimiento.NivelCumplimiento)&lt;/h3&gt;
            &lt;p&gt;Total de verificaciones realizadas: $($VerificacionCumplimiento.ResumenCumplimiento.TotalVerificaciones)&lt;/p&gt;
        &lt;/div&gt;
&quot;@

        if ($VerificacionCumplimiento.Verificaciones -and $VerificacionCumplimiento.Verificaciones.Count -gt 0) {
            # Mostrar solo las verificaciones que no cumplen o est√É¬°n pendientes
            $verificacionesProblematicas = $VerificacionCumplimiento.Verificaciones | Where-Object { $_.Cumple -ne &quot;S√É¬≠&quot; }
            
            if ($verificacionesProblematicas.Count -gt 0) {
                $htmlContent += @&quot;
        &lt;h3&gt;√¢≈°¬†√Ø¬∏¬è Verificaciones que Requieren Atenci√É¬≥n&lt;/h3&gt;
        &lt;div class=&quot;compliance-grid&quot;&gt;
&quot;@
                foreach ($verificacion in $verificacionesProblematicas) {
                    $cardClass = switch ($verificacion.Cumple) {
                        &quot;No&quot; { &quot;compliance-fail&quot; }
                        &quot;Pendiente&quot; { &quot;compliance-pending&quot; }
                        &quot;Revisar&quot; { &quot;compliance-pending&quot; }
                        default { &quot;compliance-pending&quot; }
                    }
                    
                    $criticidadClass = switch ($verificacion.Criticidad) {
                        &quot;Alta&quot; { &quot;risk-high&quot; }
                        &quot;Media&quot; { &quot;risk-medium&quot; }
                        &quot;Baja&quot; { &quot;risk-low&quot; }
                        default { &quot;risk-medium&quot; }
                    }
                    
                    $htmlContent += @&quot;
            &lt;div class=&quot;compliance-card $cardClass&quot;&gt;
                &lt;h4&gt;$($verificacion.ID)&lt;/h4&gt;
                &lt;p&gt;&lt;strong&gt;$($verificacion.Descripcion)&lt;/strong&gt;&lt;/p&gt;
                &lt;p&gt;&lt;strong&gt;Estado Actual:&lt;/strong&gt; $($verificacion.EstadoActual)&lt;/p&gt;
                &lt;p&gt;&lt;strong&gt;Recomendaci√É¬≥n:&lt;/strong&gt; $($verificacion.Recomendacion)&lt;/p&gt;
                &lt;p&gt;&lt;strong&gt;Criticidad:&lt;/strong&gt; &lt;span class=&quot;$criticidadClass&quot;&gt;$($verificacion.Criticidad)&lt;/span&gt;&lt;/p&gt;
                &lt;p&gt;&lt;strong&gt;Categor√É¬≠a:&lt;/strong&gt; $($verificacion.Categoria)&lt;/p&gt;
            &lt;/div&gt;
&quot;@
                }
                $htmlContent += &quot;&lt;/div&gt;&quot;
            }
        }
    }

    # NUEVA SECCI√É‚ÄúN: AN√É¬ÅLISIS DE PERMISOS
    if ($AnalisisPermisos -and $AnalisisPermisos.ResumenPermisos) {
        $htmlContent += @&quot;
        &lt;h2&gt;√∞≈∏‚Äù¬ê AN√É¬ÅLISIS DE PERMISOS DE CARPETAS SENSIBLES&lt;/h2&gt;
        
        &lt;div class=&quot;security-summary&quot;&gt;
            &lt;div class=&quot;security-metric&quot;&gt;
                &lt;div class=&quot;number risk-low&quot;&gt;$($AnalisisPermisos.ResumenPermisos.PorcentajeSeguras)%&lt;/div&gt;
                &lt;div&gt;Carpetas Seguras&lt;/div&gt;
            &lt;/div&gt;
            &lt;div class=&quot;security-metric&quot;&gt;
                &lt;div class=&quot;number risk-medium&quot;&gt;$($AnalisisPermisos.ResumenPermisos.CarpetasConProblemas)&lt;/div&gt;
                &lt;div&gt;Con Problemas&lt;/div&gt;
            &lt;/div&gt;
            &lt;div class=&quot;security-metric&quot;&gt;
                &lt;div class=&quot;number risk-high&quot;&gt;$($AnalisisPermisos.ResumenPermisos.CarpetasCriticas)&lt;/div&gt;
                &lt;div&gt;Cr√É¬≠ticas&lt;/div&gt;
            &lt;/div&gt;
            &lt;div class=&quot;security-metric&quot;&gt;
                &lt;div class=&quot;number&quot;&gt;$($AnalisisPermisos.ResumenPermisos.TotalCarpetasAnalizadas)&lt;/div&gt;
                &lt;div&gt;Total Analizadas&lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
        
        &lt;div class=&quot;$(if($AnalisisPermisos.ResumenPermisos.NivelSeguridad -eq &#x27;Excelente&#x27;){&#x27;summary-box&#x27;}elseif($AnalisisPermisos.ResumenPermisos.NivelSeguridad -eq &#x27;Bueno&#x27; -or $AnalisisPermisos.ResumenPermisos.NivelSeguridad -eq &#x27;Aceptable&#x27;){&#x27;info-box&#x27;}else{&#x27;warning-box&#x27;})&quot;&gt;
            &lt;h3&gt;√∞≈∏‚Ä∫¬°√Ø¬∏¬è Nivel de Seguridad: $($AnalisisPermisos.ResumenPermisos.NivelSeguridad)&lt;/h3&gt;
        &lt;/div&gt;
&quot;@

        if ($AnalisisPermisos.AnalisisPermisos) {
            $carpetasProblematicas = $AnalisisPermisos.AnalisisPermisos | Where-Object { $_.Estado -in @(&quot;Advertencia&quot;, &quot;Cr√É¬≠tico&quot;) }
            
            if ($carpetasProblematicas.Count -gt 0) {
                $htmlContent += @&quot;
        &lt;h3&gt;√¢≈°¬†√Ø¬∏¬è Carpetas con Permisos Problem√É¬°ticos&lt;/h3&gt;
        &lt;table&gt;
            &lt;tr&gt;
                &lt;th&gt;Ruta&lt;/th&gt;
                &lt;th&gt;Descripci√É¬≥n&lt;/th&gt;
                &lt;th&gt;Propietario&lt;/th&gt;
                &lt;th&gt;Permisos Problem√É¬°ticos&lt;/th&gt;
                &lt;th&gt;Estado&lt;/th&gt;
            &lt;/tr&gt;
&quot;@
                foreach ($carpeta in $carpetasProblematicas) {
                    $estadoClass = switch ($carpeta.Estado) {
                        &quot;Cr√É¬≠tico&quot; { &quot;status-critical&quot; }
                        &quot;Advertencia&quot; { &quot;status-warning&quot; }
                        default { &quot;status-normal&quot; }
                    }
                    
                    $htmlContent += @&quot;
            &lt;tr&gt;
                &lt;td&gt;&lt;strong&gt;$($carpeta.Ruta)&lt;/strong&gt;&lt;/td&gt;
                &lt;td&gt;$($carpeta.Descripcion)&lt;/td&gt;
                &lt;td&gt;$($carpeta.Propietario)&lt;/td&gt;
                &lt;td&gt;$($carpeta.PermisosProblematicosCount)&lt;/td&gt;
                &lt;td&gt;&lt;span class=&quot;status-indicator $estadoClass&quot;&gt;$($carpeta.Estado)&lt;/span&gt;&lt;/td&gt;
            &lt;/tr&gt;
&quot;@
                }
                $htmlContent += &quot;&lt;/table&gt;&quot;
            }
        }
    }

    # NUEVA SECCI√É‚ÄúN: AUDITOR√É¬çA DE SOFTWARE
    if ($AuditoriaSoftware -and $AuditoriaSoftware.ResumenAuditoria) {
        $htmlContent += @&quot;
        &lt;h2&gt;√∞≈∏‚Äô¬ø AUDITOR√É¬çA DE SOFTWARE INSTALADO&lt;/h2&gt;
        
        &lt;div class=&quot;security-summary&quot;&gt;
            &lt;div class=&quot;security-metric&quot;&gt;
                &lt;div class=&quot;number&quot;&gt;$($AuditoriaSoftware.ResumenAuditoria.TotalSoftwareInstalado)&lt;/div&gt;
                &lt;div&gt;Total Programas&lt;/div&gt;
            &lt;/div&gt;
            &lt;div class=&quot;security-metric&quot;&gt;
                &lt;div class=&quot;number risk-high&quot;&gt;$($AuditoriaSoftware.ResumenAuditoria.SoftwareCritico)&lt;/div&gt;
                &lt;div&gt;Riesgo Alto&lt;/div&gt;
            &lt;/div&gt;
            &lt;div class=&quot;security-metric&quot;&gt;
                &lt;div class=&quot;number risk-medium&quot;&gt;$($AuditoriaSoftware.ResumenAuditoria.SoftwareRiesgoMedio)&lt;/div&gt;
                &lt;div&gt;Riesgo Medio&lt;/div&gt;
            &lt;/div&gt;
            &lt;div class=&quot;security-metric&quot;&gt;
                &lt;div class=&quot;number risk-low&quot;&gt;$($AuditoriaSoftware.ResumenAuditoria.PorcentajeSeguro)%&lt;/div&gt;
                &lt;div&gt;Software Seguro&lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
        
        &lt;div class=&quot;$(if($AuditoriaSoftware.ResumenAuditoria.NivelRiesgo -eq &#x27;Bajo&#x27;){&#x27;summary-box&#x27;}elseif($AuditoriaSoftware.ResumenAuditoria.NivelRiesgo -eq &#x27;Medio&#x27;){&#x27;info-box&#x27;}else{&#x27;warning-box&#x27;})&quot;&gt;
            &lt;h3&gt;√¢≈°¬†√Ø¬∏¬è Nivel de Riesgo: $($AuditoriaSoftware.ResumenAuditoria.NivelRiesgo)&lt;/h3&gt;
        &lt;/div&gt;
        
&quot;@
# NUEVA SECCI√É‚ÄúN: SOFTWARE INSTALADO
if ($AuditoriaSoftware -and $AuditoriaSoftware.SoftwareInstalado) {
    $htmlContent += @&quot;
    &lt;h2&gt;√∞≈∏‚Äú¬¶ INVENTARIO DE SOFTWARE INSTALADO&lt;/h2&gt;
    
    &lt;div class=&quot;metrics-grid&quot;&gt;
        &lt;div class=&quot;metric-card&quot;&gt;
            &lt;h4&gt;√∞≈∏‚Äú≈† Resumen de Auditor√É¬≠a de Software&lt;/h4&gt;
            &lt;p&gt;&lt;strong&gt;Total Software:&lt;/strong&gt; $($AuditoriaSoftware.ResumenAuditoria.TotalSoftwareInstalado)&lt;/p&gt;
            &lt;p&gt;&lt;strong&gt;Software Problem√É¬°tico:&lt;/strong&gt; $($AuditoriaSoftware.ResumenAuditoria.SoftwareConProblemas)&lt;/p&gt;
            &lt;p&gt;&lt;strong&gt;Nivel de Riesgo:&lt;/strong&gt; &lt;span class=&quot;status-indicator status-$(if($AuditoriaSoftware.ResumenAuditoria.NivelRiesgo -eq &#x27;Bajo&#x27;){&#x27;normal&#x27;}elseif($AuditoriaSoftware.ResumenAuditoria.NivelRiesgo -eq &#x27;Medio&#x27;){&#x27;warning&#x27;}else{&#x27;critical&#x27;})&quot;&gt;$($AuditoriaSoftware.ResumenAuditoria.NivelRiesgo)&lt;/span&gt;&lt;/p&gt;
            &lt;p&gt;&lt;strong&gt;Software Cr√É¬≠tico:&lt;/strong&gt; $($AuditoriaSoftware.ResumenAuditoria.SoftwareCritico)&lt;/p&gt;
            &lt;p&gt;&lt;strong&gt;Software Riesgo Medio:&lt;/strong&gt; $($AuditoriaSoftware.ResumenAuditoria.SoftwareRiesgoMedio)&lt;/p&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&quot;@

    # Software problem√É¬°tico
    if ($AuditoriaSoftware.SoftwareProblematico -and $AuditoriaSoftware.SoftwareProblematico.Count -gt 0) {
        $htmlContent += @&quot;
    &lt;h3&gt;√¢≈°¬†√Ø¬∏¬è Software Problem√É¬°tico Detectado&lt;/h3&gt;
    &lt;table&gt;
        &lt;tr&gt;
            &lt;th&gt;Software&lt;/th&gt;
            &lt;th&gt;Versi√É¬≥n&lt;/th&gt;
            &lt;th&gt;Fabricante&lt;/th&gt;
            &lt;th&gt;Instalado&lt;/th&gt;
            &lt;th&gt;Criticidad&lt;/th&gt;
            &lt;th&gt;Problema&lt;/th&gt;
        &lt;/tr&gt;
&quot;@

        foreach ($software in $AuditoriaSoftware.SoftwareProblematico) {
            $criticidadClass = switch ($software.CriticidadMaxima) {
                &quot;Alta&quot; { &quot;status-critical&quot; }
                &quot;Media&quot; { &quot;status-warning&quot; }
                &quot;Baja&quot; { &quot;status-normal&quot; }
                default { &quot;&quot; }
            }
            
            $descripcionProblemas = &quot;&quot;
            foreach ($problema in $software.Problemas) {
                $descripcionProblemas += &quot;$($problema.Descripcion)&lt;br&gt;&quot;
            }
            
            $htmlContent += @&quot;
        &lt;tr&gt;
            &lt;td&gt;&lt;strong&gt;$($software.Nombre)&lt;/strong&gt;&lt;/td&gt;
            &lt;td&gt;$($software.Version)&lt;/td&gt;
            &lt;td&gt;$($software.Fabricante)&lt;/td&gt;
            &lt;td&gt;$($software.FechaInstalacion)&lt;/td&gt;
            &lt;td&gt;&lt;span class=&quot;status-indicator $criticidadClass&quot;&gt;$($software.CriticidadMaxima)&lt;/span&gt;&lt;/td&gt;
            &lt;td&gt;$descripcionProblemas&lt;/td&gt;
        &lt;/tr&gt;
&quot;@
        }
        $htmlContent += &quot;&lt;/table&gt;&quot;
    }

    # Lista completa de software
    $htmlContent += @&quot;
    &lt;h3&gt;√∞≈∏‚Äú‚Äπ Lista Completa de Software Instalado&lt;/h3&gt;
    &lt;table&gt;
        &lt;tr&gt;
            &lt;th&gt;Nombre&lt;/th&gt;
            &lt;th&gt;Versi√É¬≥n&lt;/th&gt;
            &lt;th&gt;Fabricante&lt;/th&gt;
            &lt;th&gt;Fecha Instalaci√É¬≥n&lt;/th&gt;
            &lt;th&gt;Tama√É¬±o (MB)&lt;/th&gt;
        &lt;/tr&gt;
&quot;@

    foreach ($software in ($AuditoriaSoftware.SoftwareInstalado | Sort-Object Nombre)) {
        $htmlContent += @&quot;
        &lt;tr&gt;
            &lt;td&gt;$($software.Nombre)&lt;/td&gt;
            &lt;td&gt;$($software.Version)&lt;/td&gt;
            &lt;td&gt;$($software.Fabricante)&lt;/td&gt;
            &lt;td&gt;$($software.FechaInstalacion)&lt;/td&gt;
            &lt;td&gt;$($software.Tama√É¬±oMB)&lt;/td&gt;
        &lt;/tr&gt;
&quot;@
    }
    $htmlContent += &quot;&lt;/table&gt;&quot;
}
        if ($AuditoriaSoftware.SoftwareProblematico -and $AuditoriaSoftware.SoftwareProblematico.Count -gt 0) {
            $htmlContent += @&quot;
        &lt;h3&gt;√¢≈°¬†√Ø¬∏¬è Software que Requiere Atenci√É¬≥n&lt;/h3&gt;
        &lt;table&gt;
            &lt;tr&gt;
                &lt;th&gt;Nombre&lt;/th&gt;
                &lt;th&gt;Versi√É¬≥n&lt;/th&gt;
                &lt;th&gt;Fabricante&lt;/th&gt;
                &lt;th&gt;Fecha Instalaci√É¬≥n&lt;/th&gt;
                &lt;th&gt;Criticidad&lt;/th&gt;
                &lt;th&gt;Problemas Detectados&lt;/th&gt;
            &lt;/tr&gt;
&quot;@
            foreach ($software in $AuditoriaSoftware.SoftwareProblematico | Select-Object -First 20) {
                $criticidadClass = switch ($software.CriticidadMaxima) {
                    &quot;Alta&quot; { &quot;status-critical&quot; }
                    &quot;Media&quot; { &quot;status-warning&quot; }
                    &quot;Baja&quot; { &quot;status-normal&quot; }
                    default { &quot;status-normal&quot; }
                }
                
                $problemasTexto = ($software.Problemas | ForEach-Object { $_.Tipo }) -join &quot;, &quot;
                
                $htmlContent += @&quot;
            &lt;tr&gt;
                &lt;td&gt;&lt;strong&gt;$($software.Nombre)&lt;/strong&gt;&lt;/td&gt;
                &lt;td&gt;$($software.Version)&lt;/td&gt;
                &lt;td&gt;$($software.Fabricante)&lt;/td&gt;
                &lt;td&gt;$($software.FechaInstalacion)&lt;/td&gt;
                &lt;td&gt;&lt;span class=&quot;status-indicator $criticidadClass&quot;&gt;$($software.CriticidadMaxima)&lt;/span&gt;&lt;/td&gt;
                &lt;td&gt;$problemasTexto&lt;/td&gt;
            &lt;/tr&gt;
&quot;@
            }
            $htmlContent += &quot;&lt;/table&gt;&quot;
        }
    }

    $htmlContent += @&quot;
        &lt;h2&gt;√∞≈∏‚Äú≈† LOGS DE EVENTOS DE LOS 3 TIPOS PRINCIPALES&lt;/h2&gt;
        
        &lt;h3&gt;√∞≈∏‚Äù¬¥ Logs del Sistema (√É≈°ltimos eventos cr√É¬≠ticos)&lt;/h3&gt;
        &lt;table&gt;
            &lt;tr&gt;
                &lt;th&gt;Fecha/Hora&lt;/th&gt;
                &lt;th&gt;Nivel&lt;/th&gt;
                &lt;th&gt;Proveedor&lt;/th&gt;
                &lt;th&gt;ID Evento&lt;/th&gt;
                &lt;th&gt;Mensaje&lt;/th&gt;
            &lt;/tr&gt;
&quot;@

    foreach ($log in $LogsEventos.LogsSistema | Select-Object -First 10) {
        $nivelClass = switch ($log.LevelDisplayName) {
            &quot;Critical&quot; { &quot;status-critical&quot; }
            &quot;Error&quot; { &quot;status-critical&quot; }
            &quot;Warning&quot; { &quot;status-warning&quot; }
            default { &quot;status-normal&quot; }
        }
        
        $htmlContent += @&quot;
            &lt;tr&gt;
                &lt;td&gt;$($log.TimeCreated.ToString(&quot;dd/MM/yyyy HH:mm:ss&quot;))&lt;/td&gt;
                &lt;td&gt;&lt;span class=&quot;status-indicator $nivelClass&quot;&gt;$($log.LevelDisplayName)&lt;/span&gt;&lt;/td&gt;
                &lt;td&gt;$($log.ProviderName)&lt;/td&gt;
                &lt;td&gt;$($log.Id)&lt;/td&gt;
                &lt;td&gt;$($log.Message)&lt;/td&gt;
            &lt;/tr&gt;
&quot;@
    }

    $htmlContent += @&quot;
        &lt;/table&gt;

        &lt;h3&gt;√∞≈∏‚Äú¬± Logs de Aplicaci√É¬≥n (√É≈°ltimos eventos cr√É¬≠ticos)&lt;/h3&gt;
        &lt;table&gt;
            &lt;tr&gt;
                &lt;th&gt;Fecha/Hora&lt;/th&gt;
                &lt;th&gt;Nivel&lt;/th&gt;
                &lt;th&gt;Proveedor&lt;/th&gt;
                &lt;th&gt;ID Evento&lt;/th&gt;
                &lt;th&gt;Mensaje&lt;/th&gt;
            &lt;/tr&gt;
&quot;@

    foreach ($log in $LogsEventos.LogsAplicacion | Select-Object -First 10) {
        $nivelClass = switch ($log.LevelDisplayName) {
            &quot;Critical&quot; { &quot;status-critical&quot; }
            &quot;Error&quot; { &quot;status-critical&quot; }
            &quot;Warning&quot; { &quot;status-warning&quot; }
            default { &quot;status-normal&quot; }
        }
        
        $htmlContent += @&quot;
            &lt;tr&gt;
                &lt;td&gt;$($log.TimeCreated.ToString(&quot;dd/MM/yyyy HH:mm:ss&quot;))&lt;/td&gt;
                &lt;td&gt;&lt;span class=&quot;status-indicator $nivelClass&quot;&gt;$($log.LevelDisplayName)&lt;/span&gt;&lt;/td&gt;
                &lt;td&gt;$($log.ProviderName)&lt;/td&gt;
                &lt;td&gt;$($log.Id)&lt;/td&gt;
                &lt;td&gt;$($log.Message)&lt;/td&gt;
            &lt;/tr&gt;
&quot;@
    }

    $htmlContent += @&quot;
        &lt;/table&gt;

        &lt;h3&gt;√∞≈∏‚Äù‚Äô Logs de Seguridad (Eventos de autenticaci√É¬≥n)&lt;/h3&gt;
        &lt;table&gt;
            &lt;tr&gt;
                &lt;th&gt;Fecha/Hora&lt;/th&gt;
                &lt;th&gt;ID Evento&lt;/th&gt;
                &lt;th&gt;Cuenta&lt;/th&gt;
                &lt;th&gt;IP Origen&lt;/th&gt;
                &lt;th&gt;Tipo de Evento&lt;/th&gt;
                &lt;th&gt;Mensaje&lt;/th&gt;
            &lt;/tr&gt;
&quot;@

    foreach ($log in $LogsEventos.LogsSeguridad | Select-Object -First 15) {
        $tipoClass = switch ($log.EventType) {
            &quot;Login Fallido&quot; { &quot;status-critical&quot; }
            &quot;Cuenta Bloqueada&quot; { &quot;status-critical&quot; }
            &quot;Login&quot; { &quot;status-normal&quot; }
            &quot;Logout&quot; { &quot;status-normal&quot; }
            default { &quot;status-warning&quot; }
        }
        
        $htmlContent += @&quot;
            &lt;tr&gt;
                &lt;td&gt;$($log.TimeCreated.ToString(&quot;dd/MM/yyyy HH:mm:ss&quot;))&lt;/td&gt;
                &lt;td&gt;$($log.Id)&lt;/td&gt;
                &lt;td&gt;$($log.Account)&lt;/td&gt;
                &lt;td&gt;$($log.SourceIP)&lt;/td&gt;
                &lt;td&gt;&lt;span class=&quot;status-indicator $tipoClass&quot;&gt;$($log.EventType)&lt;/span&gt;&lt;/td&gt;
                &lt;td&gt;$($log.RawMessage)&lt;/td&gt;
            &lt;/tr&gt;
&quot;@
    }

    $htmlContent += @&quot;
        &lt;/table&gt;

        &lt;h2&gt;√∞≈∏‚Äù¬ç DATOS EXTENDIDOS Y AN√É¬ÅLISIS AVANZADO&lt;/h2&gt;
        
        &lt;h3&gt;√∞≈∏‚Äù‚Äû √É≈°ltimos Parches Instalados&lt;/h3&gt;
        &lt;table&gt;
            &lt;tr&gt;
                &lt;th&gt;HotFix ID&lt;/th&gt;
                &lt;th&gt;Descripci√É¬≥n&lt;/th&gt;
                &lt;th&gt;Fecha Instalaci√É¬≥n&lt;/th&gt;
                &lt;th&gt;Instalado Por&lt;/th&gt;
            &lt;/tr&gt;
&quot;@

    foreach ($parche in $DatosExtendidos.UltimosParches) {
        $fechaInstalacion = if ($parche.InstalledOn) { $parche.InstalledOn.ToString(&quot;dd/MM/yyyy&quot;) } else { &quot;No disponible&quot; }
        $htmlContent += @&quot;
            &lt;tr&gt;
                &lt;td&gt;&lt;strong&gt;$($parche.HotFixID)&lt;/strong&gt;&lt;/td&gt;
                &lt;td&gt;$($parche.Description)&lt;/td&gt;
                &lt;td&gt;$fechaInstalacion&lt;/td&gt;
                &lt;td&gt;$($parche.InstalledBy)&lt;/td&gt;
            &lt;/tr&gt;
&quot;@
    }

    $htmlContent += @&quot;
        &lt;/table&gt;

        &lt;h3&gt;√¢≈°¬†√Ø¬∏¬è Servicios Autom√É¬°ticos Detenidos&lt;/h3&gt;
        &lt;table&gt;
            &lt;tr&gt;
                &lt;th&gt;Nombre del Servicio&lt;/th&gt;
                &lt;th&gt;Nombre Interno&lt;/th&gt;
                &lt;th&gt;Estado&lt;/th&gt;
                &lt;th&gt;Tipo de Inicio&lt;/th&gt;
&quot;@

    if ($RevisarServicioTerceros) {
        $htmlContent += &quot;&lt;th&gt;Compa√É¬±√É¬≠a&lt;/th&gt;&lt;th&gt;Tipo&lt;/th&gt;&quot;
    }

    $htmlContent += &quot;&lt;/tr&gt;&quot;

    foreach ($servicio in $DatosExtendidos.ServiciosDetenidos) {
        $htmlContent += @&quot;
            &lt;tr&gt;
                &lt;td&gt;&lt;strong&gt;$($servicio.DisplayName)&lt;/strong&gt;&lt;/td&gt;
                &lt;td&gt;$($servicio.Name)&lt;/td&gt;
                &lt;td&gt;&lt;span class=&quot;status-indicator status-critical&quot;&gt;$($servicio.Status)&lt;/span&gt;&lt;/td&gt;
                &lt;td&gt;$($servicio.StartType)&lt;/td&gt;
&quot;@
        
        if ($RevisarServicioTerceros) {
            $tipoClass = if ($servicio.EsMicrosoft) { &quot;status-normal&quot; } else { &quot;status-warning&quot; }
            $htmlContent += @&quot;
                &lt;td&gt;$($servicio.Compania)&lt;/td&gt;
                &lt;td&gt;&lt;span class=&quot;status-indicator $tipoClass&quot;&gt;$($servicio.Tipo)&lt;/span&gt;&lt;/td&gt;
&quot;@
        }
        
        $htmlContent += &quot;&lt;/tr&gt;&quot;
    }

    $htmlContent += @&quot;
        &lt;/table&gt;

        &lt;h3&gt;√∞≈∏‚Äù¬• TOP 5 Procesos por Uso de CPU&lt;/h3&gt;
        &lt;table&gt;
            &lt;tr&gt;
                &lt;th&gt;Proceso&lt;/th&gt;
                &lt;th&gt;CPU (segundos)&lt;/th&gt;
                &lt;th&gt;ID Proceso&lt;/th&gt;
                &lt;th&gt;Memoria (MB)&lt;/th&gt;
            &lt;/tr&gt;
&quot;@

    foreach ($proceso in $DatosExtendidos.ProcesosCPU) {
        $htmlContent += @&quot;
            &lt;tr&gt;
                &lt;td&gt;&lt;strong&gt;$($proceso.Name)&lt;/strong&gt;&lt;/td&gt;
                &lt;td&gt;$($proceso.CPU)&lt;/td&gt;
                &lt;td&gt;$($proceso.Id)&lt;/td&gt;
                &lt;td&gt;$($proceso.Memoria_MB)&lt;/td&gt;
            &lt;/tr&gt;
&quot;@
    }

    $htmlContent += @&quot;
        &lt;/table&gt;

        &lt;h3&gt;√∞≈∏¬ß¬† TOP 5 Procesos por Uso de Memoria&lt;/h3&gt;
        &lt;table&gt;
            &lt;tr&gt;
                &lt;th&gt;Proceso&lt;/th&gt;
                &lt;th&gt;Memoria (MB)&lt;/th&gt;
                &lt;th&gt;ID Proceso&lt;/th&gt;
                &lt;th&gt;CPU (segundos)&lt;/th&gt;
            &lt;/tr&gt;
&quot;@

    foreach ($proceso in $DatosExtendidos.ProcesosMemoria) {
        $htmlContent += @&quot;
            &lt;tr&gt;
                &lt;td&gt;&lt;strong&gt;$($proceso.Name)&lt;/strong&gt;&lt;/td&gt;
                &lt;td&gt;$($proceso.Memoria_MB)&lt;/td&gt;
                &lt;td&gt;$($proceso.Id)&lt;/td&gt;
                &lt;td&gt;$($proceso.CPU)&lt;/td&gt;
            &lt;/tr&gt;
&quot;@
    }

    $htmlContent += @&quot;
        &lt;/table&gt;

        &lt;h3&gt;√∞≈∏≈í¬ê Puertos Abiertos (Listening)&lt;/h3&gt;
        &lt;table&gt;
            &lt;tr&gt;
                &lt;th&gt;Direcci√É¬≥n Local&lt;/th&gt;
                &lt;th&gt;Puerto&lt;/th&gt;
                &lt;th&gt;Estado&lt;/th&gt;
                &lt;th&gt;Proceso ID&lt;/th&gt;
            &lt;/tr&gt;
&quot;@

    foreach ($puerto in $DatosExtendidos.PuertosAbiertos | Select-Object -First 20) {
        $htmlContent += @&quot;
            &lt;tr&gt;
                &lt;td&gt;$($puerto.LocalAddress)&lt;/td&gt;
                &lt;td&gt;&lt;strong&gt;$($puerto.LocalPort)&lt;/strong&gt;&lt;/td&gt;
                &lt;td&gt;&lt;span class=&quot;status-indicator status-normal&quot;&gt;$($puerto.State)&lt;/span&gt;&lt;/td&gt;
                &lt;td&gt;$($puerto.OwningProcess)&lt;/td&gt;
            &lt;/tr&gt;
&quot;@
    }

    $htmlContent += @&quot;
        &lt;/table&gt;

        &lt;h3&gt;√∞≈∏‚Äù‚Äî TOP 10 Conexiones Activas por IP&lt;/h3&gt;
        &lt;table&gt;
            &lt;tr&gt;
                &lt;th&gt;IP Remota&lt;/th&gt;
                &lt;th&gt;N√É¬∫mero de Conexiones&lt;/th&gt;
            &lt;/tr&gt;
&quot;@

    foreach ($conexion in $DatosExtendidos.ConexionesActivas) {
        $htmlContent += @&quot;
            &lt;tr&gt;
                &lt;td&gt;&lt;strong&gt;$($conexion.Name)&lt;/strong&gt;&lt;/td&gt;
                &lt;td&gt;$($conexion.Count)&lt;/td&gt;
            &lt;/tr&gt;
&quot;@
    }

    $htmlContent += @&quot;
        &lt;/table&gt;

        &lt;h3&gt;√∞≈∏‚Äò¬• Usuarios Locales&lt;/h3&gt;
        &lt;table&gt;
            &lt;tr&gt;
                &lt;th&gt;Nombre&lt;/th&gt;
                &lt;th&gt;Habilitado&lt;/th&gt;
                &lt;th&gt;√É≈°ltimo Logon&lt;/th&gt;
                &lt;th&gt;Contrase√É¬±a Expira&lt;/th&gt;
            &lt;/tr&gt;
&quot;@

    foreach ($usuario in $DatosExtendidos.UsuariosLocales) {
        $habilitadoClass = if ($usuario.Enabled) { &quot;status-normal&quot; } else { &quot;status-warning&quot; }
        $htmlContent += @&quot;
            &lt;tr&gt;
                &lt;td&gt;&lt;strong&gt;$($usuario.Name)&lt;/strong&gt;&lt;/td&gt;
                &lt;td&gt;&lt;span class=&quot;status-indicator $habilitadoClass&quot;&gt;$(if($usuario.Enabled){&#x27;S√É¬≠&#x27;}else{&#x27;No&#x27;})&lt;/span&gt;&lt;/td&gt;
                &lt;td&gt;$($usuario.UltimoLogon)&lt;/td&gt;
                &lt;td&gt;$($usuario.PasswordExpires)&lt;/td&gt;
            &lt;/tr&gt;
&quot;@
    }

    $htmlContent += @&quot;
        &lt;/table&gt;

        &lt;h3&gt;√∞≈∏≈°¬´ √É≈°ltimos 5 Intentos de Login Fallidos&lt;/h3&gt;
        &lt;table&gt;
            &lt;tr&gt;
                &lt;th&gt;Fecha/Hora&lt;/th&gt;
                &lt;th&gt;Cuenta&lt;/th&gt;
                &lt;th&gt;IP Origen&lt;/th&gt;
                &lt;th&gt;Tipo de Fallo&lt;/th&gt;
            &lt;/tr&gt;
&quot;@

    if ($DatosExtendidos.LoginsFallidos -and $DatosExtendidos.LoginsFallidos.Count -gt 0) {
        foreach ($login in $DatosExtendidos.LoginsFallidos) {
            $htmlContent += @&quot;
            &lt;tr&gt;
                &lt;td&gt;$($login.TimeCreated.ToString(&quot;dd/MM/yyyy HH:mm:ss&quot;))&lt;/td&gt;
                &lt;td&gt;&lt;strong&gt;$($login.Cuenta)&lt;/strong&gt;&lt;/td&gt;
                &lt;td&gt;$($login.IPOrigen)&lt;/td&gt;
                &lt;td&gt;$($login.TipoFallo)&lt;/td&gt;
            &lt;/tr&gt;
&quot;@
        }
    } else {
        $htmlContent += @&quot;
            &lt;tr&gt;
                &lt;td colspan=&quot;4&quot; style=&quot;text-align: center; font-style: italic;&quot;&gt;No se encontraron intentos de login fallidos recientes&lt;/td&gt;
            &lt;/tr&gt;
&quot;@
    }

    $htmlContent += @&quot;
        &lt;/table&gt;

        &lt;h3&gt;√¢¬è¬∞ Tareas Programadas (Estado)&lt;/h3&gt;
        &lt;table&gt;
            &lt;tr&gt;
                &lt;th&gt;Nombre de Tarea&lt;/th&gt;
                &lt;th&gt;√É≈°ltima Ejecuci√É¬≥n&lt;/th&gt;
                &lt;th&gt;Resultado&lt;/th&gt;
                &lt;th&gt;Estado&lt;/th&gt;
            &lt;/tr&gt;
&quot;@

    foreach ($tarea in $DatosExtendidos.TareasProgramadas | Select-Object -First 15) {
        $estadoClass = switch ($tarea.Estado) {
            &quot;Exitoso&quot; { &quot;status-normal&quot; }
            &quot;Error*&quot; { &quot;status-critical&quot; }
            default { &quot;status-warning&quot; }
        }
        
        $ultimaEjecucion = if ($tarea.LastRunTime) { $tarea.LastRunTime.ToString(&quot;dd/MM/yyyy HH:mm&quot;) } else { &quot;Nunca&quot; }
        
        $htmlContent += @&quot;
            &lt;tr&gt;
                &lt;td&gt;&lt;strong&gt;$($tarea.TaskName)&lt;/strong&gt;&lt;/td&gt;
                &lt;td&gt;$ultimaEjecucion&lt;/td&gt;
                &lt;td&gt;$($tarea.LastTaskResult)&lt;/td&gt;
                &lt;td&gt;&lt;span class=&quot;status-indicator $estadoClass&quot;&gt;$($tarea.Estado)&lt;/span&gt;&lt;/td&gt;
            &lt;/tr&gt;
&quot;@
    }

    # SECCI√É‚ÄúN DE SEGURIDAD EXTENDIDA
    $htmlContent += @&quot;
        &lt;/table&gt;

        &lt;h2&gt;√∞≈∏‚Ä∫¬°√Ø¬∏¬è AN√É¬ÅLISIS DE SEGURIDAD EXTENDIDO&lt;/h2&gt;
        
        &lt;h3&gt;√∞≈∏‚Äù¬ç Windows Defender&lt;/h3&gt;
        &lt;div class=&quot;metrics-grid&quot;&gt;
            &lt;div class=&quot;metric-card&quot;&gt;
                &lt;h4&gt;Estado de Windows Defender&lt;/h4&gt;
&quot;@

    if ($DatosExtendidos.WindowsDefender -and -not $DatosExtendidos.WindowsDefender.Error) {
        $defenderStatus = if ($DatosExtendidos.WindowsDefender.Habilitado) { &quot;status-normal&quot; } else { &quot;status-critical&quot; }
        $realtimeStatus = if ($DatosExtendidos.WindowsDefender.TiempoRealActivo) { &quot;status-normal&quot; } else { &quot;status-critical&quot; }
        
        $htmlContent += @&quot;
                &lt;p&gt;&lt;strong&gt;Antivirus Habilitado:&lt;/strong&gt; &lt;span class=&quot;status-indicator $defenderStatus&quot;&gt;$(if($DatosExtendidos.WindowsDefender.Habilitado){&#x27;S√É¬≠&#x27;}else{&#x27;No&#x27;})&lt;/span&gt;&lt;/p&gt;
                &lt;p&gt;&lt;strong&gt;Protecci√É¬≥n en Tiempo Real:&lt;/strong&gt; &lt;span class=&quot;status-indicator $realtimeStatus&quot;&gt;$(if($DatosExtendidos.WindowsDefender.TiempoRealActivo){&#x27;Activa&#x27;}else{&#x27;Inactiva&#x27;})&lt;/span&gt;&lt;/p&gt;
                &lt;p&gt;&lt;strong&gt;√É≈°ltimo An√É¬°lisis R√É¬°pido:&lt;/strong&gt; $($DatosExtendidos.WindowsDefender.UltimoAnalisisRapido)&lt;/p&gt;
                &lt;p&gt;&lt;strong&gt;√É≈°ltimo An√É¬°lisis Completo:&lt;/strong&gt; $($DatosExtendidos.WindowsDefender.UltimoAnalisisCompleto)&lt;/p&gt;
                &lt;p&gt;&lt;strong&gt;Edad de Definiciones:&lt;/strong&gt; $($DatosExtendidos.WindowsDefender.EdadDefinicionesAV)&lt;/p&gt;
&quot;@
    } else {
        $htmlContent += @&quot;
                &lt;p&gt;&lt;span class=&quot;status-indicator status-warning&quot;&gt;Estado no disponible&lt;/span&gt;&lt;/p&gt;
                &lt;p&gt;$($DatosExtendidos.WindowsDefender.Error)&lt;/p&gt;
&quot;@
    }

    $htmlContent += @&quot;
            &lt;/div&gt;
        &lt;/div&gt;

        &lt;h3&gt;√∞≈∏‚Äù¬• Estado del Firewall por Perfil&lt;/h3&gt;
        &lt;table&gt;
            &lt;tr&gt;
                &lt;th&gt;Perfil&lt;/th&gt;
                &lt;th&gt;Habilitado&lt;/th&gt;
                &lt;th&gt;Conexiones Entrantes&lt;/th&gt;
                &lt;th&gt;Conexiones Salientes&lt;/th&gt;
                &lt;th&gt;Notificaciones&lt;/th&gt;
            &lt;/tr&gt;
&quot;@

    if ($DatosExtendidos.Firewall -and $DatosExtendidos.Firewall.Count -gt 0) {
        foreach ($perfil in $DatosExtendidos.Firewall) {
            $habilitadoClass = if ($perfil.Habilitado) { &quot;status-normal&quot; } else { &quot;status-critical&quot; }
            
            $htmlContent += @&quot;
            &lt;tr&gt;
                &lt;td&gt;&lt;strong&gt;$($perfil.Nombre)&lt;/strong&gt;&lt;/td&gt;
                &lt;td&gt;&lt;span class=&quot;status-indicator $habilitadoClass&quot;&gt;$(if($perfil.Habilitado){&#x27;S√É¬≠&#x27;}else{&#x27;No&#x27;})&lt;/span&gt;&lt;/td&gt;
                &lt;td&gt;$($perfil.ConexionesEntrantes)&lt;/td&gt;
                &lt;td&gt;$($perfil.ConexionesSalientes)&lt;/td&gt;
                &lt;td&gt;$(if($perfil.NotificacionesActivas){&#x27;Activas&#x27;}else{&#x27;Inactivas&#x27;})&lt;/td&gt;
            &lt;/tr&gt;
&quot;@
        }
    } else {
        $htmlContent += @&quot;
            &lt;tr&gt;
                &lt;td colspan=&quot;5&quot; style=&quot;text-align: center; font-style: italic;&quot;&gt;Informaci√É¬≥n del firewall no disponible&lt;/td&gt;
            &lt;/tr&gt;
&quot;@
    }

    $htmlContent += @&quot;
        &lt;/table&gt;

        &lt;h3&gt;√∞≈∏‚Äù‚Äô Control de Acceso de Usuario (UAC)&lt;/h3&gt;
        &lt;div class=&quot;metric-card&quot;&gt;
&quot;@

    if ($DatosExtendidos.UAC -and -not $DatosExtendidos.UAC.Error) {
        $uacStatus = if ($DatosExtendidos.UAC.Habilitado) { &quot;status-normal&quot; } else { &quot;status-critical&quot; }
        
        $htmlContent += @&quot;
            &lt;p&gt;&lt;strong&gt;UAC Habilitado:&lt;/strong&gt; &lt;span class=&quot;status-indicator $uacStatus&quot;&gt;$(if($DatosExtendidos.UAC.Habilitado){&#x27;S√É¬≠&#x27;}else{&#x27;No&#x27;})&lt;/span&gt;&lt;/p&gt;
            &lt;p&gt;&lt;strong&gt;Nivel de UAC:&lt;/strong&gt; $($DatosExtendidos.UAC.Nivel)&lt;/p&gt;
            &lt;p&gt;&lt;strong&gt;Elevaci√É¬≥n No Segura:&lt;/strong&gt; $(if($DatosExtendidos.UAC.ElevacionNoSegura){&#x27;S√É¬≠&#x27;}else{&#x27;No&#x27;})&lt;/p&gt;
&quot;@
    } else {
        $htmlContent += @&quot;
            &lt;p&gt;&lt;span class=&quot;status-indicator status-warning&quot;&gt;Informaci√É¬≥n de UAC no disponible&lt;/span&gt;&lt;/p&gt;
&quot;@
    }

    $htmlContent += @&quot;
        &lt;/div&gt;

        &lt;h3&gt;√∞≈∏‚Äú¬° Configuraci√É¬≥n SNMP&lt;/h3&gt;
        &lt;div class=&quot;metric-card&quot;&gt;
&quot;@

    if ($DatosExtendidos.ServicioSNMP) {
        $snmpStatus = if ($DatosExtendidos.ServicioSNMP.Status -eq &quot;Running&quot;) { &quot;status-normal&quot; } else { &quot;status-warning&quot; }
        
        $htmlContent += @&quot;
            &lt;p&gt;&lt;strong&gt;Servicio SNMP:&lt;/strong&gt; &lt;span class=&quot;status-indicator $snmpStatus&quot;&gt;$($DatosExtendidos.ServicioSNMP.Status)&lt;/span&gt;&lt;/p&gt;
            &lt;p&gt;&lt;strong&gt;Tipo de Inicio:&lt;/strong&gt; $($DatosExtendidos.ServicioSNMP.StartType)&lt;/p&gt;
&quot;@
    } else {
        $htmlContent += @&quot;
            &lt;p&gt;&lt;span class=&quot;status-indicator status-normal&quot;&gt;Servicio SNMP no instalado&lt;/span&gt;&lt;/p&gt;
&quot;@
    }

    $htmlContent += @&quot;
        &lt;/div&gt;

        &lt;div class=&quot;footer&quot;&gt;
            &lt;h3&gt;√∞≈∏‚Äú‚Äπ RESUMEN DEL INFORME&lt;/h3&gt;
            &lt;p&gt;&lt;strong&gt;Servidor Analizado:&lt;/strong&gt; $nombreServidor&lt;/p&gt;
            &lt;p&gt;&lt;strong&gt;Sistema Operativo:&lt;/strong&gt; $sistemaOperativo&lt;/p&gt;
            &lt;p&gt;&lt;strong&gt;Fecha y Hora del Informe:&lt;/strong&gt; $(Get-Date -Format &quot;dd/MM/yyyy HH:mm:ss&quot;)&lt;/p&gt;
            &lt;p&gt;&lt;strong&gt;Generado por:&lt;/strong&gt; Script de Salud del Sistema v3.0 - An√É¬°lisis Completo&lt;/p&gt;
            &lt;hr style=&quot;margin: 20px 0; border: 1px solid rgba(255,255,255,0.3);&quot;&gt;
            &lt;p style=&quot;font-size: 0.9em; opacity: 0.8;&quot;&gt;
                Este informe incluye an√É¬°lisis de los 4 subsistemas principales (CPU, Memoria, Disco, Red), 
                logs de eventos de seguridad, an√É¬°lisis de confiabilidad, diagn√É¬≥stico avanzado de hardware,
                verificaci√É¬≥n de cumplimiento con CIS Benchmarks, an√É¬°lisis de permisos de carpetas sensibles,
                auditor√É¬≠a de software instalado, y an√É¬°lisis completo de seguridad del sistema.
            &lt;/p&gt;
        &lt;/div&gt;
    &lt;/div&gt;

    &lt;script&gt;
        // Agregar interactividad b√É¬°sica
        document.addEventListener(&#x27;DOMContentLoaded&#x27;, function() {
            // Efecto hover en las tarjetas
            const cards = document.querySelectorAll(&#x27;.metric-card, .header-card, .compliance-card&#x27;);
            cards.forEach(card =&gt; {
                card.addEventListener(&#x27;mouseenter&#x27;, function() {
                    this.style.transform = &#x27;translateY(-5px)&#x27;;
                    this.style.transition = &#x27;transform 0.3s ease&#x27;;
                });
                card.addEventListener(&#x27;mouseleave&#x27;, function() {
                    this.style.transform = &#x27;translateY(0)&#x27;;
                });
            });

            // Resaltar filas de tabla al hacer hover
            const rows = document.querySelectorAll(&#x27;tr&#x27;);
            rows.forEach(row =&gt; {
                row.addEventListener(&#x27;mouseenter&#x27;, function() {
                    if (this.parentElement.tagName === &#x27;TBODY&#x27; || this.parentElement.parentElement.tagName === &#x27;TABLE&#x27;) {
                        this.style.backgroundColor = &#x27;#e3f2fd&#x27;;
                        this.style.transition = &#x27;background-color 0.2s ease&#x27;;
                    }
                });
                row.addEventListener(&#x27;mouseleave&#x27;, function() {
                    if (this.parentElement.tagName === &#x27;TBODY&#x27; || this.parentElement.parentElement.tagName === &#x27;TABLE&#x27;) {
                        this.style.backgroundColor = &#x27;&#x27;;
                    }
                });
            });

            // Animaci√É¬≥n de aparici√É¬≥n para las secciones
            const sections = document.querySelectorAll(&#x27;h2, h3&#x27;);
            const observer = new IntersectionObserver((entries) =&gt; {
                entries.forEach(entry =&gt; {
                    if (entry.isIntersecting) {
                        entry.target.style.opacity = &#x27;1&#x27;;
                        entry.target.style.transform = &#x27;translateY(0)&#x27;;
                    }
                });
            });

            sections.forEach(section =&gt; {
                section.style.opacity = &#x27;0&#x27;;
                section.style.transform = &#x27;translateY(20px)&#x27;;
                section.style.transition = &#x27;opacity 0.6s ease, transform 0.6s ease&#x27;;
                observer.observe(section);
            });
        });
    &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
&quot;@

    return $htmlContent
}

# FUNCI√É‚ÄúN PRINCIPAL MEJORADA
function Main {
    try {
        Write-Host &quot;`n√∞≈∏≈°‚Ç¨ INICIANDO AN√É¬ÅLISIS COMPLETO DE SALUD DEL SISTEMA&quot; -ForegroundColor Green
        Write-Host &quot;=&quot; * 80 -ForegroundColor Green
        Write-Host &quot;Servidor: $NombreServidor&quot; -ForegroundColor Cyan
        Write-Host &quot;Fecha: $(Get-Date -Format &#x27;dd/MM/yyyy HH:mm:ss&#x27;)&quot; -ForegroundColor Cyan
        Write-Host &quot;=&quot; * 80 -ForegroundColor Green
        
        # 1. Informaci√É¬≥n b√É¬°sica del sistema
        Write-Host &quot;`n√∞≈∏‚Äú‚Äπ FASE 1: Recopilando informaci√É¬≥n del sistema...&quot; -ForegroundColor Yellow
        $infoSistema = Get-InformacionSistema
        
        # 2. M√É¬©tricas de rendimiento de los 4 subsistemas
        Write-Host &quot;`n√∞≈∏‚Äú≈† FASE 2: Analizando m√É¬©tricas de rendimiento...&quot; -ForegroundColor Yellow
        $metricasRendimiento = Get-MetricasRendimiento
        
        # 3. Logs de eventos
        Write-Host &quot;`n√∞≈∏‚Äú¬ù FASE 3: Recopilando logs de eventos...&quot; -ForegroundColor Yellow
        $logsEventos = Get-LogsEventos -Dias $DiasLogs
        
        # 4. Datos extendidos
        Write-Host &quot;`n√∞≈∏‚Äù¬ç FASE 4: Recopilando datos extendidos...&quot; -ForegroundColor Yellow
        $datosExtendidos = Get-DatosExtendidos -ParchesFaltantes $ParchesFaltantes -RevisarServicioTerceros $RevisarServicioTerceros
        
        # 5. NUEVAS FUNCIONALIDADES DE SEGURIDAD
        $analisisConfiabilidad = $null
        $diagnosticoHardware = $null
        $analisisRoles = $null
        $analisisPoliticas = $null
        $verificacionCumplimiento = $null
        $analisisPermisos = $null
        $auditoriaSoftware = $null
        
        if ($AnalisisSeguridad) {
            Write-Host &quot;`n√∞≈∏‚Ä∫¬°√Ø¬∏¬è FASE 5: Ejecutando an√É¬°lisis de seguridad avanzado...&quot; -ForegroundColor Yellow
            
            # 5.1 An√É¬°lisis de confiabilidad
            Write-Host &quot;   5.1 An√É¬°lisis de confiabilidad...&quot; -ForegroundColor Cyan
            $analisisConfiabilidad = Get-AnalisisConfiabilidad
            
            # 5.2 Diagn√É¬≥stico de hardware avanzado
            Write-Host &quot;   5.2 Diagn√É¬≥stico de hardware avanzado...&quot; -ForegroundColor Cyan
            $diagnosticoHardware = Get-DiagnosticoHardwareAvanzado
            
            # 5.3 An√É¬°lisis de roles de servidor
            Write-Host &quot;   5.3 An√É¬°lisis de roles de servidor...&quot; -ForegroundColor Cyan
            $analisisRoles = Get-AnalisisRolesServidor
            
            # 5.4 An√É¬°lisis de pol√É¬≠ticas de grupo
            Write-Host &quot;   5.4 An√É¬°lisis de pol√É¬≠ticas de grupo...&quot; -ForegroundColor Cyan
            $analisisPoliticas = Get-AnalisisPoliticasGrupo
            
            # 5.5 An√É¬°lisis de permisos
            Write-Host &quot;   5.5 An√É¬°lisis de permisos de carpetas...&quot; -ForegroundColor Cyan
            $analisisPermisos = Get-AnalisisPermisos
            
            # 5.6 Auditor√É¬≠a de software
            Write-Host &quot;   5.6 Auditor√É¬≠a de software instalado...&quot; -ForegroundColor Cyan
            $auditoriaSoftware = Get-AuditoriaSoftware
        }
        
        if ($VerificarCumplimiento) {
            Write-Host &quot;`n√¢≈ì‚Ä¶ FASE 6: Verificando cumplimiento con est√É¬°ndares...&quot; -ForegroundColor Yellow
            $verificacionCumplimiento = Get-VerificacionCumplimiento
        }
        
        # Generar informe
        Write-Host &quot;`n√∞≈∏‚Äú‚Äû FASE FINAL: Generando informe completo...&quot; -ForegroundColor Yellow
        Write-Progress -Activity &quot;Generando informe HTML&quot; -PercentComplete 90
        
        $htmlContent = Generate-CompleteHTML -InfoSistema $infoSistema -MetricasRendimiento $metricasRendimiento -LogsEventos $logsEventos -DatosExtendidos $datosExtendidos -AnalisisConfiabilidad $analisisConfiabilidad -DiagnosticoHardware $diagnosticoHardware -AnalisisRoles $analisisRoles -AnalisisPoliticas $analisisPoliticas -VerificacionCumplimiento $verificacionCumplimiento -AnalisisPermisos $analisisPermisos -AuditoriaSoftware $auditoriaSoftware
        
        # Guardar archivo
        $archivoHTML = &quot;$ArchivoSalida.html&quot;
        $htmlContent | Out-File -FilePath $archivoHTML -Encoding UTF8
        
        Write-Progress -Activity &quot;Completado&quot; -PercentComplete 100
        
        # Resumen final
        Write-Host &quot;`n&quot; + &quot;=&quot; * 80 -ForegroundColor Green
        Write-Host &quot;√¢≈ì‚Ä¶ AN√É¬ÅLISIS COMPLETADO EXITOSAMENTE&quot; -ForegroundColor Green
        Write-Host &quot;=&quot; * 80 -ForegroundColor Green
        Write-Host &quot;√∞≈∏‚Äú¬Å Archivo generado: $archivoHTML&quot; -ForegroundColor Cyan
        Write-Host &quot;√∞≈∏‚Äú≈† Servidor analizado: $($infoSistema.NombreServidor)&quot; -ForegroundColor Cyan
        Write-Host &quot;√∞≈∏‚Äì¬•√Ø¬∏¬è Sistema operativo: $($infoSistema.NombreSO)&quot; -ForegroundColor Cyan
        Write-Host &quot;√¢¬è¬±√Ø¬∏¬è Tiempo de actividad: $($infoSistema.TiempoActividad.Days) d√É¬≠as, $($infoSistema.TiempoActividad.Hours) horas&quot; -ForegroundColor Cyan
        
        # Estad√É¬≠sticas del an√É¬°lisis
        Write-Host &quot;`n√∞≈∏‚ÄúÀÜ ESTAD√É¬çSTICAS DEL AN√É¬ÅLISIS:&quot; -ForegroundColor Yellow
        Write-Host &quot;   √¢‚Ç¨¬¢ Logs del sistema analizados: $($logsEventos.LogsSistema.Count)&quot; -ForegroundColor White
        Write-Host &quot;   √¢‚Ç¨¬¢ Logs de aplicaci√É¬≥n analizados: $($logsEventos.LogsAplicacion.Count)&quot; -ForegroundColor White
        Write-Host &quot;   √¢‚Ç¨¬¢ Logs de seguridad analizados: $($logsEventos.LogsSeguridad.Count)&quot; -ForegroundColor White
        Write-Host &quot;   √¢‚Ç¨¬¢ Servicios autom√É¬°ticos detenidos: $($datosExtendidos.ServiciosDetenidos.Count)&quot; -ForegroundColor White
        Write-Host &quot;   √¢‚Ç¨¬¢ Parches recientes instalados: $($datosExtendidos.UltimosParches.Count)&quot; -ForegroundColor White
        
        if ($AnalisisSeguridad) {
            Write-Host &quot;`n√∞≈∏‚Ä∫¬°√Ø¬∏¬è AN√É¬ÅLISIS DE SEGURIDAD:&quot; -ForegroundColor Yellow
            if ($verificacionCumplimiento -and $verificacionCumplimiento.ResumenCumplimiento) {
                Write-Host &quot;   √¢‚Ç¨¬¢ Cumplimiento general: $($verificacionCumplimiento.ResumenCumplimiento.PorcentajeCumplimiento)%&quot; -ForegroundColor White
                Write-Host &quot;   √¢‚Ç¨¬¢ Verificaciones exitosas: $($verificacionCumplimiento.ResumenCumplimiento.Cumple)&quot; -ForegroundColor White
                Write-Host &quot;   √¢‚Ç¨¬¢ Verificaciones fallidas: $($verificacionCumplimiento.ResumenCumplimiento.NoCumple)&quot; -ForegroundColor White
            }
            if ($analisisPermisos -and $analisisPermisos.ResumenPermisos) {
                Write-Host &quot;   √¢‚Ç¨¬¢ Carpetas analizadas: $($analisisPermisos.ResumenPermisos.TotalCarpetasAnalizadas)&quot; -ForegroundColor White
                Write-Host &quot;   √¢‚Ç¨¬¢ Carpetas con problemas: $($analisisPermisos.ResumenPermisos.CarpetasConProblemas)&quot; -ForegroundColor White
            }
            if ($auditoriaSoftware -and $auditoriaSoftware.ResumenAuditoria) {
                Write-Host &quot;   √¢‚Ç¨¬¢ Software instalado: $($auditoriaSoftware.ResumenAuditoria.TotalSoftwareInstalado)&quot; -ForegroundColor White
                Write-Host &quot;   √¢‚Ç¨¬¢ Software problem√É¬°tico: $($auditoriaSoftware.ResumenAuditoria.SoftwareConProblemas)&quot; -ForegroundColor White
            }
        }
        
        Write-Host &quot;`n√∞≈∏≈í¬ê Para ver el informe completo, abra el archivo HTML en su navegador.&quot; -ForegroundColor Green
        Write-Host &quot;=&quot; * 80 -ForegroundColor Green
        
        # Abrir autom√É¬°ticamente el archivo si es posible
        try {
            Start-Process $archivoHTML
            Write-Host &quot;√∞≈∏≈°‚Ç¨ Abriendo informe en el navegador predeterminado...&quot; -ForegroundColor Green
        } catch {
            Write-Host &quot;√¢‚Äû¬π√Ø¬∏¬è Abra manualmente el archivo: $archivoHTML&quot; -ForegroundColor Yellow
        }
        
    } catch {
        Write-Error &quot;√¢¬ù≈í Error durante la ejecuci√É¬≥n del script: $_&quot;
        Write-Host &quot;√∞≈∏‚Äú¬ß Si el problema persiste, contacte al administrador del sistema.&quot; -ForegroundColor Red
        exit 1
    }
}

# Ejecutar funci√É¬≥n principal
Main

</code></pre>
      <button class="copy-button" onclick="copyCode(this, 'codeBlock1')" aria-label="Copiar c√≥digo">Copiar</button>
      <div id="copyConfirmation1" class="copy-confirmation" aria-live="polite">¬°Copiado!</div>
      </div>
    </section>
    <section class="instructions">
      <h3>Instrucciones de uso</h3>
      <ol>
        <li>Abre PowerShell como administrador.</li>
        <li>Copia el script de arriba y p√©galo en la consola.</li>
        <li>Ejecuta <code>Invoke-HealthCheck</code> para ver el estado del sistema.</li>
        <li>Revisa los resultados y toma acciones si detectas alg√∫n problema.</li>
      </ol>
      <ul>
        <li><b>Discos:</b> Muestra el espacio libre y total de cada disco.</li>
        <li><b>Servicios:</b> Verifica que servicios cr√≠ticos est√©n en ejecuci√≥n.</li>
        <li><b>CPU:</b> Promedio de uso del procesador.</li>
        <li><b>Memoria:</b> Porcentaje de uso de memoria RAM.</li>
      </ul>
    </section>
  </main>
  <script>
    function copyCode(btn, blockId) {
      const codeBlock = document.getElementById(blockId).querySelector('code');
      const text = codeBlock.innerText;
      navigator.clipboard.writeText(text).then(function() {
        btn.nextElementSibling.style.display = 'inline';
        setTimeout(function() {
          btn.nextElementSibling.style.display = 'none';
        }, 1500);
      });
    }
  </script>
</body>
</html>
